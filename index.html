<!DOCTYPE html>
<html lang="en" data-theme="light" data-mode="focus">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#e74c3c">
  <meta name="description" content="A focused pomodoro timer to boost your productivity">
  <title>Pomodoro Timer</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Ccircle cx='256' cy='280' r='200' fill='%23e74c3c'/%3E%3Ccircle cx='256' cy='280' r='170' fill='%23c0392b'/%3E%3Ccircle cx='256' cy='280' r='160' fill='%23e74c3c'/%3E%3Crect x='250' y='130' width='12' height='100' rx='6' fill='%23fff'/%3E%3Crect x='250' y='230' width='12' height='60' rx='6' fill='%23fff' transform='rotate(30 256 280)'/%3E%3Cellipse cx='256' cy='100' rx='12' ry='20' fill='%2327ae60'/%3E%3Cellipse cx='240' cy='95' rx='18' ry='10' fill='%2327ae60' transform='rotate(-30 240 95)'/%3E%3Cellipse cx='272' cy='95' rx='18' ry='10' fill='%2327ae60' transform='rotate(30 272 95)'/%3E%3C/svg%3E">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.10);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 9999px;
      --transition: 600ms ease;
    }

    /* Light Focus */
    html[data-theme="light"][data-mode="focus"] {
      --bg: #fdf6f4;
      --surface: #ffffff;
      --primary: #e74c3c;
      --primary-hover: #c0392b;
      --text: #2c2c2c;
      --text-secondary: #666666;
      --ring-track: #f0d5d1;
      --border: #e8e0de;
    }

    /* Light Break */
    html[data-theme="light"][data-mode="break"],
    html[data-theme="light"][data-mode="longbreak"] {
      --bg: #f4fdf6;
      --surface: #ffffff;
      --primary: #27ae60;
      --primary-hover: #1e8449;
      --text: #2c2c2c;
      --text-secondary: #666666;
      --ring-track: #c8e6c9;
      --border: #d5e8d7;
    }

    /* Dark Focus */
    html[data-theme="dark"][data-mode="focus"] {
      --bg: #1a1215;
      --surface: #2d2024;
      --primary: #e74c3c;
      --primary-hover: #ff6b5a;
      --text: #f0e6e6;
      --text-secondary: #a89999;
      --ring-track: #4a2a2a;
      --border: #3d2a2e;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.16);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.20);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.24);
    }

    /* Dark Break */
    html[data-theme="dark"][data-mode="break"],
    html[data-theme="dark"][data-mode="longbreak"] {
      --bg: #121a15;
      --surface: #1e2d22;
      --primary: #2ecc71;
      --primary-hover: #58d68d;
      --text: #e6f0e8;
      --text-secondary: #8fb898;
      --ring-track: #1e3d24;
      --border: #2a3d2e;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.16);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.20);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.24);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background var(--transition), color var(--transition);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      -webkit-font-smoothing: antialiased;
    }

    .app {
      width: 100%;
      max-width: 420px;
      padding: 16px 20px 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      animation: fadeIn 400ms ease;
    }

    /* Header */
    .header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
      transition: color var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo svg { width: 28px; height: 28px; }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: var(--surface);
      color: var(--text-secondary);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background var(--transition), color var(--transition), box-shadow var(--transition);
      box-shadow: var(--shadow-sm);
      touch-action: manipulation;
    }

    .icon-btn:hover { color: var(--primary); box-shadow: var(--shadow-md); }
    .icon-btn svg { width: 20px; height: 20px; }

    /* Mode tabs */
    .mode-tabs {
      display: flex;
      background: var(--surface);
      border-radius: var(--radius-full);
      padding: 4px;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), box-shadow var(--transition);
      width: 100%;
      max-width: 340px;
    }

    .mode-tab {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.8125rem;
      font-weight: 600;
      padding: 8px 4px;
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: background 300ms ease, color 300ms ease;
      touch-action: manipulation;
      white-space: nowrap;
    }

    .mode-tab:hover {
      color: var(--text);
    }

    .mode-tab.active {
      background: var(--primary);
      color: #fff;
      box-shadow: var(--shadow-sm);
    }

    /* Active icon button (page nav highlight) */
    .icon-btn.active { color: var(--primary); }

    /* Tooltip for icon buttons */
    .icon-btn[data-tooltip],
    .theme-toggle-fixed[data-tooltip] {
      position: relative;
    }

    .icon-btn[data-tooltip]::after,
    .theme-toggle-fixed[data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--text);
      color: var(--bg);
      font-size: 0.6875rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 6px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 150ms ease;
      z-index: 60;
    }

    .icon-btn[data-tooltip]:hover::after,
    .theme-toggle-fixed[data-tooltip]:hover::after {
      opacity: 1;
    }

    /* Fixed dark mode toggle */
    .theme-toggle-fixed {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 50;
      width: 40px;
      height: 40px;
      border: none;
      background: var(--surface);
      color: var(--text-secondary);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background var(--transition), color var(--transition), box-shadow var(--transition);
      box-shadow: var(--shadow-md);
      touch-action: manipulation;
    }

    .theme-toggle-fixed:hover { color: var(--primary); box-shadow: var(--shadow-lg); }
    .theme-toggle-fixed svg { width: 20px; height: 20px; }

    /* Page sections */
    .page-section {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
    }

    /* Mode indicator (sr-only, kept for aria-live) */
    .mode-label {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
    }

    /* Timer ring */
    .timer-container {
      position: relative;
      width: clamp(260px, 68vw, 340px);
      height: clamp(260px, 68vw, 340px);
    }

    .timer-svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .ring-track {
      fill: none;
      stroke: var(--ring-track);
      stroke-width: 8;
      transition: stroke var(--transition);
    }

    .ring-progress {
      fill: none;
      stroke: var(--primary);
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke var(--transition), stroke-dashoffset 0.3s linear;
    }

    .timer-display {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .time-text {
      font-size: clamp(3.5rem, 15vw, 6rem);
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      line-height: 1;
      color: var(--text);
      transition: color var(--transition);
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn {
      height: 48px;
      padding: 0 28px;
      border: none;
      border-radius: var(--radius-full);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background var(--transition), color var(--transition), box-shadow var(--transition), transform 100ms ease;
      touch-action: manipulation;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn:active { transform: scale(0.96); }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover { background: var(--primary-hover); box-shadow: var(--shadow-lg); }

    .btn-secondary {
      background: var(--surface);
      color: var(--primary);
      box-shadow: var(--shadow-sm);
      border: 2px solid var(--primary);
    }

    .btn-secondary:hover { box-shadow: var(--shadow-md); }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      padding: 0 16px;
    }

    .btn-ghost:hover { color: var(--text); background: var(--surface); }

    .hidden { display: none !important; }

    /* Session dots */
    .session-dots {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--ring-track);
      transition: background var(--transition), transform 200ms ease;
    }

    .dot.completed {
      background: var(--primary);
      transform: scale(1.15);
    }

    .dot.active {
      background: var(--primary);
      animation: pulse 1.5s ease infinite;
    }

    /* Today's progress */
    .today-progress {
      width: 100%;
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), box-shadow var(--transition);
      animation: slideUp 400ms ease both;
    }

    .today-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
    }

    .today-title {
      font-size: 0.8125rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      transition: color var(--transition);
    }

    .today-summary {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
      transition: color var(--transition);
    }

    .today-summary strong {
      color: var(--primary);
      font-weight: 700;
      transition: color var(--transition);
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--ring-track);
      border-radius: 4px;
      overflow: hidden;
      transition: background var(--transition);
    }

    .progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 400ms ease, background var(--transition);
      min-width: 0;
    }

    .today-detail {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
      transition: color var(--transition);
    }

    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      width: 100%;
    }

    .stat-card {
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 14px 8px;
      text-align: center;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), box-shadow var(--transition);
      animation: slideUp 400ms ease both;
    }

    .stat-card:nth-child(2) { animation-delay: 60ms; }
    .stat-card:nth-child(3) { animation-delay: 120ms; }
    .stat-card:nth-child(4) { animation-delay: 180ms; }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      font-variant-numeric: tabular-nums;
      transition: color var(--transition);
    }

    .stat-label {
      font-size: 0.6875rem;
      color: var(--text-secondary);
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: color var(--transition);
    }

    /* Weekly chart */
    .weekly-chart {
      width: 100%;
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), box-shadow var(--transition);
      animation: slideUp 400ms ease both;
      animation-delay: 240ms;
    }

    .weekly-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 24px;
    }

    .weekly-title {
      font-size: 0.8125rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      transition: color var(--transition);
    }

    .weekly-total {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
      transition: color var(--transition);
    }

    .weekly-total strong {
      color: var(--primary);
      font-weight: 700;
      transition: color var(--transition);
    }

    .chart-bars {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      height: 80px;
      width: 100%;
    }

    .chart-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      height: 100%;
    }

    .chart-bar-wrap {
      flex: 1;
      width: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    .chart-bar {
      width: 100%;
      max-width: 32px;
      background: var(--primary);
      border-radius: 4px 4px 2px 2px;
      min-height: 2px;
      transition: height 400ms ease, background var(--transition);
      position: relative;
    }

    .chart-bar.empty {
      background: var(--ring-track);
      height: 2px !important;
    }

    .chart-bar-value {
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.625rem;
      font-weight: 600;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      transition: color var(--transition);
    }

    .chart-day {
      font-size: 0.625rem;
      color: var(--text-secondary);
      font-weight: 500;
      transition: color var(--transition);
    }

    .chart-day.today {
      color: var(--primary);
      font-weight: 700;
    }

    /* Settings dialog */
    dialog {
      border: none;
      border-radius: var(--radius-lg);
      background: var(--surface);
      color: var(--text);
      padding: 0;
      max-width: 380px;
      width: calc(100% - 32px);
      box-shadow: var(--shadow-lg);
      animation: slideUp 300ms ease;
      margin: auto;
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
    }

    .dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px 0;
    }

    .dialog-header h2 {
      font-size: 1.125rem;
      font-weight: 700;
    }

    .dialog-body {
      padding: 20px 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field label {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .field input[type="number"] {
      height: 42px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0 12px;
      font-size: 1rem;
      background: var(--bg);
      color: var(--text);
      transition: border-color 200ms ease;
      width: 100%;
    }

    .field input[type="number"]:focus {
      outline: none;
      border-color: var(--primary);
    }

    .field select {
      height: 42px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0 12px;
      font-size: 1rem;
      background: var(--bg);
      color: var(--text);
      transition: border-color 200ms ease;
      width: 100%;
      cursor: pointer;
    }

    .field select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .field-row {
      display: flex;
      gap: 12px;
    }

    .field-row .field {
      flex: 1;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0;
    }

    .toggle-row span {
      font-size: 0.875rem;
      font-weight: 500;
    }

    .toggle {
      position: relative;
      width: 48px;
      height: 28px;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      inset: 0;
      background: var(--border);
      border-radius: 14px;
      cursor: pointer;
      transition: background 200ms ease;
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      left: 3px;
      bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: transform 200ms ease;
    }

    .toggle input:checked + .toggle-slider {
      background: var(--primary);
    }

    .toggle input:checked + .toggle-slider::before {
      transform: translateX(20px);
    }

    .dialog-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      padding-top: 8px;
    }

    /* Keyboard hint — hidden on touch-only devices */
    .kbd-hint {
      font-size: 0.6875rem;
      color: var(--text-secondary);
      text-align: center;
      opacity: 0.7;
      transition: color var(--transition);
      display: none;
    }

    @media (hover: hover) {
      .kbd-hint { display: block; }
    }

    /* Animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Confetti celebration */
    .confetti-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 200;
      overflow: hidden;
    }

    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 10px;
      top: -20px;
      animation: confettiFall 3s ease-out forwards;
    }

    .celebration-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      z-index: 199;
      animation: fadeIn 200ms ease;
    }

    .celebration-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--surface);
      color: var(--text);
      padding: 24px 32px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      z-index: 201;
      text-align: center;
      animation: celebrationPop 400ms cubic-bezier(0.175, 0.885, 0.32, 1.275);
      max-width: 320px;
    }

    .celebration-message .celebration-emoji {
      font-size: 3rem;
      margin-bottom: 12px;
      display: block;
    }

    .celebration-message .celebration-text {
      font-size: 1.125rem;
      font-weight: 600;
      line-height: 1.4;
    }

    @keyframes confettiFall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    @keyframes celebrationPop {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
      .confetti-overlay,
      .confetti-piece {
        display: none !important;
      }
    }

    /* Auth button */
    .auth-btn {
      height: 36px;
      padding: 0 14px;
      border: none;
      background: var(--surface);
      color: var(--text);
      border-radius: var(--radius-full);
      font-size: 0.8125rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), color var(--transition), box-shadow var(--transition);
      touch-action: manipulation;
      white-space: nowrap;
    }

    .auth-btn:hover { box-shadow: var(--shadow-md); }

    .auth-btn svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    /* User avatar */
    .user-avatar-btn {
      width: 36px;
      height: 36px;
      border: 2px solid var(--primary);
      border-radius: 50%;
      padding: 0;
      background: var(--surface);
      cursor: pointer;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: border-color var(--transition), box-shadow var(--transition), background var(--transition);
      touch-action: manipulation;
      position: relative;
    }

    .user-avatar-btn:hover { box-shadow: var(--shadow-md); }

    .user-avatar-btn img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      display: block;
    }

    /* User dropdown */
    .user-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--surface);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      padding: 8px 0;
      min-width: 180px;
      z-index: 100;
      animation: slideUp 200ms ease;
      transition: background var(--transition);
    }

    .user-menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 10px 16px;
      border: none;
      background: none;
      color: var(--text);
      font-size: 0.875rem;
      cursor: pointer;
      transition: background 150ms ease, color var(--transition);
      text-align: left;
    }

    .user-menu-item:hover { background: var(--ring-track); }

    .user-menu-item svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      color: var(--text-secondary);
    }

    .user-menu-name {
      padding: 8px 16px 4px;
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text);
      transition: color var(--transition);
    }

    .user-menu-email {
      padding: 0 16px 8px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      margin-bottom: 4px;
      transition: color var(--transition), border-color var(--transition);
    }

    .user-menu-backdrop {
      position: fixed;
      inset: 0;
      z-index: 99;
    }

    /* Auth prompt card */
    .auth-prompt {
      width: 100%;
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 28px 24px;
      text-align: center;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), box-shadow var(--transition);
      animation: slideUp 400ms ease both;
    }

    .auth-prompt-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      color: var(--primary);
      transition: color var(--transition);
    }

    .auth-prompt-text {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
      line-height: 1.5;
      transition: color var(--transition);
    }

    .auth-prompt .auth-btn {
      margin: 0 auto;
      height: 42px;
      padding: 0 20px;
      font-size: 0.875rem;
      background: var(--primary);
      color: #fff;
      box-shadow: var(--shadow-md);
    }

    .auth-prompt .auth-btn:hover {
      box-shadow: var(--shadow-lg);
    }

    .auth-prompt .auth-btn svg {
      color: #fff;
    }

    /* Leaderboard */
    .leaderboard {
      width: 100%;
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), box-shadow var(--transition);
      animation: slideUp 400ms ease both;
      animation-delay: 300ms;
    }

    .leaderboard-title {
      font-size: 0.8125rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 12px;
      transition: color var(--transition);
    }

    .leaderboard-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .leaderboard-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      transition: background 150ms ease;
    }

    .leaderboard-row:hover {
      background: var(--ring-track);
    }

    .leaderboard-row.current-user {
      background: var(--ring-track);
      outline: 2px solid var(--primary);
      outline-offset: -2px;
    }

    .leaderboard-rank {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-secondary);
      flex-shrink: 0;
      transition: color var(--transition);
    }

    .leaderboard-rank.gold { color: #f1c40f; }
    .leaderboard-rank.silver { color: #95a5a6; }
    .leaderboard-rank.bronze { color: #cd6133; }

    .leaderboard-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      background: var(--ring-track);
    }

    .leaderboard-name {
      flex: 1;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: color var(--transition);
    }

    .leaderboard-minutes {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--primary);
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      transition: color var(--transition);
    }

    .leaderboard-divider {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
      transition: background var(--transition);
    }

    .leaderboard-empty {
      text-align: center;
      padding: 16px 0;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      transition: color var(--transition);
    }

    @media (min-width: 480px) {
      .app { padding: 24px 24px 48px; gap: 28px; }
      .stat-card { padding: 16px 12px; }
      .stat-value { font-size: 1.75rem; }
      .chart-bars { height: 100px; }
    }

    @media (min-width: 768px) {
      .app { max-width: 560px; padding: 32px 24px 56px; gap: 32px; }
      .timer-container { width: 360px; height: 360px; }
    }

    @media (min-width: 1024px) {
      .app { max-width: 640px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="logo" aria-label="Pomodoro Timer">
        <svg viewBox="0 0 512 512" aria-hidden="true">
          <circle cx="256" cy="280" r="200" fill="currentColor"/>
          <circle cx="256" cy="280" r="170" fill="currentColor" opacity="0.7"/>
          <circle cx="256" cy="280" r="160" fill="currentColor"/>
          <rect x="250" y="130" width="12" height="100" rx="6" fill="#fff"/>
          <rect x="250" y="230" width="12" height="60" rx="6" fill="#fff" transform="rotate(30 256 280)"/>
          <ellipse cx="256" cy="100" rx="12" ry="20" fill="#27ae60"/>
          <ellipse cx="240" cy="95" rx="18" ry="10" fill="#27ae60" transform="rotate(-30 240 95)"/>
          <ellipse cx="272" cy="95" rx="18" ry="10" fill="#27ae60" transform="rotate(30 272 95)"/>
        </svg>
        Pomodoro
      </div>
      <div class="header-actions">
        <button class="auth-btn" id="signInBtn" aria-label="Sign in with Google" title="Sign in">
          <svg viewBox="0 0 24 24" fill="none"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18A10.96 10.96 0 0 0 1 12c0 1.77.42 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
          Sign In
        </button>
        <button class="icon-btn hidden" id="statsBtn" aria-label="Stats" data-tooltip="Stats">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
          </svg>
        </button>
        <button class="icon-btn hidden" id="leaderboardBtn" aria-label="Leaderboard" data-tooltip="Leaderboard">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 22V8a2 2 0 0 0-2-2H6v0a2 2 0 0 0-2 2v4a4 4 0 0 0 4 4h0"/><path d="M14 22V8a2 2 0 0 1 2-2h2v0a2 2 0 0 1 2 2v4a4 4 0 0 1-4 4h0"/>
          </svg>
        </button>
        <button class="icon-btn" id="settingsBtn" aria-label="Open settings" data-tooltip="Settings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
        </button>
        <div class="hidden" id="userAvatarWrap" style="position:relative;">
          <button class="user-avatar-btn" id="userAvatarBtn" aria-label="Account menu" title="Account">
            <img id="userAvatarImg" src="" alt="" referrerpolicy="no-referrer">
          </button>
        </div>
      </div>
    </header>

    <div id="pageTimer" class="page-section">
    <div class="mode-tabs" role="tablist" aria-label="Timer mode">
      <button class="mode-tab active" role="tab" data-mode="focus" aria-selected="true">Focus</button>
      <button class="mode-tab" role="tab" data-mode="break" aria-selected="false">Short Break</button>
      <button class="mode-tab" role="tab" data-mode="longbreak" aria-selected="false">Long Break</button>
    </div>
    <div class="mode-label" id="modeLabel" aria-live="polite">Focus Time</div>

    <div class="timer-container" role="timer" aria-label="Timer">
      <svg class="timer-svg" viewBox="0 0 200 200">
        <circle class="ring-track" cx="100" cy="100" r="90"/>
        <circle class="ring-progress" id="progressRing" cx="100" cy="100" r="90"
                stroke-dasharray="565.49" stroke-dashoffset="0"/>
      </svg>
      <div class="timer-display">
        <span class="time-text" id="timeDisplay">25:00</span>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" id="startBtn">Start</button>
      <button class="btn btn-secondary hidden" id="pauseBtn">Pause</button>
      <button class="btn btn-ghost" id="resetBtn">Reset</button>
    </div>

    <div class="session-dots" id="sessionDots" aria-label="Session progress">
      <div class="dot" data-dot="0"></div>
      <div class="dot" data-dot="1"></div>
      <div class="dot" data-dot="2"></div>
      <div class="dot" data-dot="3"></div>
    </div>

    <div class="auth-prompt hidden" id="authPrompt">
      <svg class="auth-prompt-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
      <div class="auth-prompt-text">Sign in with Google to track your stats and compete on the leaderboard</div>
      <button class="auth-btn" id="authPromptBtn" aria-label="Sign in with Google">
        <svg viewBox="0 0 24 24" fill="none"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z" fill="#fff"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#fff"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18A10.96 10.96 0 0 0 1 12c0 1.77.42 3.45 1.18 4.93l3.66-2.84z" fill="#fff"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#fff"/></svg>
        Sign in with Google
      </button>
    </div>

    <div class="kbd-hint" aria-hidden="true">Space: start/pause &middot; R: reset &middot; Esc: close settings</div>
    </div>

    </div>
  </div>

  <button class="theme-toggle-fixed" id="themeToggle" aria-label="Toggle dark mode" data-tooltip="Dark mode">
    <svg id="sunIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
    </svg>
    <svg id="moonIcon" class="hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
    </svg>
  </button>

  <div id="celebrationContainer"></div>

  <dialog id="settingsDialog" aria-labelledby="settingsTitle">
    <div class="dialog-header">
      <h2 id="settingsTitle">Settings</h2>
      <button class="icon-btn" id="closeSettings" aria-label="Close settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <form class="dialog-body" id="settingsForm">
      <div class="field">
        <label for="focusDuration">Focus Duration (min)</label>
        <input type="number" id="focusDuration" min="1" max="120" value="25">
      </div>
      <div class="field">
        <label for="breakDuration">Break Duration (min)</label>
        <input type="number" id="breakDuration" min="1" max="30" value="5">
      </div>
      <div class="field">
        <label for="longBreakDuration">Long Break Duration (min)</label>
        <input type="number" id="longBreakDuration" min="1" max="60" value="15">
      </div>
      <div class="field">
        <label for="longBreakInterval">Long Break Interval</label>
        <input type="number" id="longBreakInterval" min="2" max="10" value="4">
      </div>
      <div class="field-row">
        <div class="field">
          <label for="dailyGoalInput">Daily Goal</label>
          <input type="number" id="dailyGoalInput" min="1" max="480" value="100">
        </div>
        <div class="field">
          <label for="dailyGoalUnit">Unit</label>
          <select id="dailyGoalUnit">
            <option value="minutes">Minutes</option>
            <option value="hours">Hours</option>
            <option value="pomodoros">Pomodoros</option>
          </select>
        </div>
      </div>
      <div class="toggle-row">
        <span>Auto-start next session</span>
        <label class="toggle">
          <input type="checkbox" id="autoStart">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="toggle-row">
        <span>Sound</span>
        <label class="toggle">
          <input type="checkbox" id="soundEnabled" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="dialog-actions">
        <button type="button" class="btn btn-ghost" id="cancelSettings">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </dialog>

  <dialog id="statsDialog" aria-labelledby="statsTitle">
    <div class="dialog-header">
      <h2 id="statsTitle">Stats</h2>
      <button class="icon-btn" id="closeStats" aria-label="Close stats">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="dialog-body">
      <div class="today-progress" id="todayProgress">
        <div class="today-header">
          <span class="today-title">Today's Progress</span>
          <span class="today-summary"><strong id="todayMinutes">0</strong> <span id="todayMinutesUnit">min</span> focused</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="today-detail">
          <span id="todayDetailLeft"><span id="todaySessions">0</span> sessions</span>
          <span>Goal: <span id="dailyGoal">100</span> <span id="dailyGoalUnitLabel">min</span></span>
        </div>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="statTodayMin">0</div>
          <div class="stat-label" id="statTodayMinLabel">Min Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statTodaySessions">0</div>
          <div class="stat-label">Sessions</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statWeekTotal">0</div>
          <div class="stat-label" id="statWeekTotalLabel">Min This Week</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statBestStreak">0</div>
          <div class="stat-label">Best Streak</div>
        </div>
      </div>

      <div class="weekly-chart" id="weeklyChart">
        <div class="weekly-header">
          <span class="weekly-title">This Week</span>
          <span class="weekly-total"><strong id="weekTotalMin">0</strong> <span id="weekTotalUnit">min</span> total</span>
        </div>
        <div class="chart-bars" id="chartBars"></div>
      </div>
    </div>
  </dialog>

  <dialog id="leaderboardDialog" aria-labelledby="leaderboardTitle">
    <div class="dialog-header">
      <h2 id="leaderboardTitle">Leaderboard</h2>
      <button class="icon-btn" id="closeLeaderboard" aria-label="Close leaderboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="dialog-body">
      <div class="leaderboard" id="leaderboard">
        <ul class="leaderboard-list" id="leaderboardList"></ul>
      </div>
    </div>
  </dialog>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script>
    // Firebase config — replace these placeholder values with your project's config
    const firebaseConfig = {
      apiKey: "AIzaSyBJIAgGQQHhKFO4xXFVg25pb1nb8nY3e9M",
      authDomain: "pomodoro-timer-82980.firebaseapp.com",
      projectId: "pomodoro-timer-82980",
      storageBucket: "pomodoro-timer-82980.firebasestorage.app",
      messagingSenderId: "785507725684",
      appId: "1:785507725684:web:90549bfb8776be5920bc21",
      measurementId: "G-G14JMRPL39"
    };
    firebase.initializeApp(firebaseConfig);
    const fbAuth = firebase.auth();
    const fbDb = firebase.firestore();
    fbDb.enablePersistence({ synchronizeTabs: true }).catch(() => {});
  </script>
  <script>
    (() => {
      'use strict';

      // --- Constants ---
      const CIRCUMFERENCE = 2 * Math.PI * 90; // ~565.49
      const STORAGE_KEYS = {
        settings: 'pomodoro-settings',
        stats: 'pomodoro-stats',
        theme: 'pomodoro-theme',
      };
      const CONFETTI_COLORS = ['#e74c3c', '#f39c12', '#2ecc71', '#3498db', '#9b59b6', '#1abc9c', '#e91e63'];

      // --- DOM refs ---
      const $ = (s) => document.querySelector(s);
      const root = document.documentElement;
      const modeLabel = $('#modeLabel');
      const timeDisplay = $('#timeDisplay');
      const progressRing = $('#progressRing');
      const startBtn = $('#startBtn');
      const pauseBtn = $('#pauseBtn');
      const resetBtn = $('#resetBtn');
      const sessionDotsEl = $('#sessionDots');
      const todayMinutesEl = $('#todayMinutes');
      const todayMinutesUnit = $('#todayMinutesUnit');
      const todaySessionsEl = $('#todaySessions');
      const todayDetailLeft = $('#todayDetailLeft');
      const progressFill = $('#progressFill');
      const dailyGoalEl = $('#dailyGoal');
      const dailyGoalUnitLabel = $('#dailyGoalUnitLabel');
      const statTodayMin = $('#statTodayMin');
      const statTodayMinLabel = $('#statTodayMinLabel');
      const statTodaySessions = $('#statTodaySessions');
      const statWeekTotal = $('#statWeekTotal');
      const statWeekTotalLabel = $('#statWeekTotalLabel');
      const statBestStreak = $('#statBestStreak');
      const weekTotalMin = $('#weekTotalMin');
      const weekTotalUnit = $('#weekTotalUnit');
      const chartBars = $('#chartBars');
      const modeTabs = document.querySelectorAll('.mode-tab');
      const themeToggle = $('#themeToggle');
      const sunIcon = $('#sunIcon');
      const moonIcon = $('#moonIcon');
      const settingsBtn = $('#settingsBtn');
      const settingsDialog = $('#settingsDialog');
      const settingsForm = $('#settingsForm');
      const closeSettingsBtn = $('#closeSettings');
      const cancelSettingsBtn = $('#cancelSettings');
      const themeColorMeta = $('meta[name="theme-color"]');
      const signInBtn = $('#signInBtn');
      const userAvatarWrap = $('#userAvatarWrap');
      const userAvatarBtn = $('#userAvatarBtn');
      const userAvatarImg = $('#userAvatarImg');
      const authPrompt = $('#authPrompt');
      const authPromptBtn = $('#authPromptBtn');
      const todayProgressEl = $('#todayProgress');
      const statsEl = $('.stats');
      const weeklyChartEl = $('#weeklyChart');
      const leaderboardEl = $('#leaderboard');
      const leaderboardList = $('#leaderboardList');
      const statsBtn = $('#statsBtn');
      const leaderboardBtn = $('#leaderboardBtn');
      const statsDialog = $('#statsDialog');
      const closeStatsBtn = $('#closeStats');
      const leaderboardDialog = $('#leaderboardDialog');
      const closeLeaderboardBtn = $('#closeLeaderboard');
      const celebrationContainer = $('#celebrationContainer');

      // --- Default settings ---
      const DEFAULTS = {
        focusDuration: 25,
        breakDuration: 5,
        longBreakDuration: 15,
        longBreakInterval: 4,
        autoStart: false,
        soundEnabled: true,
        dailyGoal: 100,
        dailyGoalUnit: 'minutes', // 'minutes' | 'hours' | 'pomodoros'
      };

      // --- State ---
      const state = {
        mode: 'focus', // 'focus' | 'break' | 'longbreak'
        status: 'idle', // 'idle' | 'running' | 'paused'
        timeRemaining: 0,
        totalTime: 0,
        endTime: 0,
        intervalId: null,
        completedInCycle: 0,
        settings: { ...DEFAULTS },
        stats: { totalPomodoros: 0, dailyCounts: {}, dailyMinutes: {}, bestStreak: 0 },
        user: null, // Firebase user object
        userMenuOpen: false,
      };

      // --- Storage ---
      function loadSettings() {
        try {
          const raw = localStorage.getItem(STORAGE_KEYS.settings);
          if (raw) Object.assign(state.settings, JSON.parse(raw));
        } catch {}
      }

      function saveSettings() {
        localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(state.settings));
      }

      function loadStats() {
        try {
          const raw = localStorage.getItem(STORAGE_KEYS.stats);
          if (raw) Object.assign(state.stats, JSON.parse(raw));
        } catch {}
      }

      function saveStats() {
        localStorage.setItem(STORAGE_KEYS.stats, JSON.stringify(state.stats));
      }

      function loadTheme() {
        const saved = localStorage.getItem(STORAGE_KEYS.theme);
        if (saved) return saved;
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      function saveTheme(theme) {
        localStorage.setItem(STORAGE_KEYS.theme, theme);
      }

      // --- Helpers ---
      function dateKeyLocal(date = new Date()) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }

      function todayKey() {
        return dateKeyLocal(new Date());
      }

      function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
      }

      function getDurationForMode(mode) {
        switch (mode) {
          case 'focus': return state.settings.focusDuration * 60;
          case 'break': return state.settings.breakDuration * 60;
          case 'longbreak': return state.settings.longBreakDuration * 60;
        }
      }

      function getModeName(mode) {
        switch (mode) {
          case 'focus': return 'Focus Time';
          case 'break': return 'Break';
          case 'longbreak': return 'Long Break';
        }
      }

      function getThemeColor() {
        const theme = root.dataset.theme;
        const mode = root.dataset.mode;
        if (mode === 'focus') return '#e74c3c';
        if (theme === 'dark') return '#2ecc71';
        return '#27ae60';
      }

      // --- Streak calculation ---
      function calculateStreak() {
        const counts = state.stats.dailyCounts;
        let streak = 0;
        const d = new Date();
        // Check today first
        const today = dateKeyLocal(d);
        if (!counts[today] || counts[today] < 1) {
          // Check if yesterday has counts (streak not broken yet today)
          d.setDate(d.getDate() - 1);
        }
        while (true) {
          const key = dateKeyLocal(d);
          if (counts[key] && counts[key] >= 1) {
            streak++;
            d.setDate(d.getDate() - 1);
          } else {
            break;
          }
        }
        return streak;
      }

      // --- Sound (Web Audio API) ---
      let audioCtx = null;

      function getAudioCtx() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        return audioCtx;
      }

      function playChime(type) {
        if (!state.settings.soundEnabled) return;
        try {
          const ctx = getAudioCtx();
          const now = ctx.currentTime;
          const notes = type === 'focus'
            ? [523.25, 659.25, 783.99] // C5, E5, G5
            : [783.99, 659.25, 523.25]; // G5, E5, C5 descending for break

          notes.forEach((freq, i) => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0, now + i * 0.15);
            gain.gain.linearRampToValueAtTime(0.3, now + i * 0.15 + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.15 + 0.4);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start(now + i * 0.15);
            osc.stop(now + i * 0.15 + 0.4);
          });
        } catch {}
      }

      // --- Celebration ---
      function showCelebration(message) {
        // Respect reduced motion preference
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        // Clear any existing celebration
        celebrationContainer.innerHTML = '';

        // Create backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'celebration-backdrop';

        // Create message modal
        const modal = document.createElement('div');
        modal.className = 'celebration-message';
        modal.setAttribute('role', 'alert');
        modal.setAttribute('aria-live', 'polite');
        modal.innerHTML = `
          <span class="celebration-emoji" aria-hidden="true">🎉</span>
          <span class="celebration-text">${message}</span>
        `;

        // Create confetti overlay (only if motion is allowed)
        if (!prefersReducedMotion) {
          const confettiOverlay = document.createElement('div');
          confettiOverlay.className = 'confetti-overlay';

          for (let i = 0; i < 50; i++) {
            const piece = document.createElement('div');
            piece.className = 'confetti-piece';
            piece.style.left = Math.random() * 100 + '%';
            piece.style.backgroundColor = CONFETTI_COLORS[Math.floor(Math.random() * CONFETTI_COLORS.length)];
            piece.style.width = (Math.random() * 8 + 6) + 'px';
            piece.style.height = (Math.random() * 8 + 6) + 'px';
            piece.style.animationDelay = (Math.random() * 0.5) + 's';
            piece.style.animationDuration = (Math.random() * 1 + 2.5) + 's';
            piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
            confettiOverlay.appendChild(piece);
          }

          celebrationContainer.appendChild(confettiOverlay);
        }

        celebrationContainer.appendChild(backdrop);
        celebrationContainer.appendChild(modal);

        // Dismiss function
        function dismiss() {
          celebrationContainer.innerHTML = '';
        }

        // Click backdrop to dismiss
        backdrop.addEventListener('click', dismiss);

        // Auto-dismiss after 4 seconds
        setTimeout(dismiss, 4000);
      }

      // --- Notifications ---
      function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
      }

      function sendNotification(title, body) {
        if ('Notification' in window && Notification.permission === 'granted') {
          try { new Notification(title, { body, icon: 'data:image/svg+xml,...' }); } catch {}
        }
      }

      // --- UI Updates ---
      function updateTimerDisplay() {
        const text = formatTime(state.timeRemaining);
        timeDisplay.textContent = text;
      }

      function updateProgressRing() {
        const fraction = state.totalTime > 0
          ? state.timeRemaining / state.totalTime
          : 1;
        progressRing.style.strokeDashoffset = CIRCUMFERENCE * (1 - fraction);
      }

      function updateControls() {
        if (state.status === 'running') {
          startBtn.classList.add('hidden');
          pauseBtn.classList.remove('hidden');
        } else {
          startBtn.classList.remove('hidden');
          pauseBtn.classList.add('hidden');
          startBtn.textContent = state.status === 'paused' ? 'Resume' : 'Start';
        }
      }

      function updateModeIndicator() {
        modeLabel.textContent = getModeName(state.mode);
        root.dataset.mode = state.mode;
        themeColorMeta.content = getThemeColor();
        modeTabs.forEach((tab) => {
          const isActive = tab.dataset.mode === state.mode;
          tab.classList.toggle('active', isActive);
          tab.setAttribute('aria-selected', isActive);
        });
      }

      function updateSessionDots() {
        const dots = sessionDotsEl.querySelectorAll('.dot');
        const interval = state.settings.longBreakInterval;

        dots.forEach((dot, i) => {
          dot.classList.remove('completed', 'active');
          if (i >= interval) {
            dot.style.display = 'none';
          } else {
            dot.style.display = '';
            if (i < state.completedInCycle) {
              dot.classList.add('completed');
            } else if (i === state.completedInCycle && state.mode === 'focus' && state.status === 'running') {
              dot.classList.add('active');
            }
          }
        });
      }

      function getWeekData() {
        const days = [];
        const d = new Date();
        for (let i = 6; i >= 0; i--) {
          const date = new Date(d);
          date.setDate(d.getDate() - i);
          const key = dateKeyLocal(date);
          const dayName = date.toLocaleDateString('en', { weekday: 'short' }).slice(0, 3);
          days.push({
            key,
            dayName,
            minutes: state.stats.dailyMinutes[key] || 0,
            sessions: state.stats.dailyCounts[key] || 0,
            isToday: i === 0,
          });
        }
        return days;
      }

      function getWeekTotalMinutes() {
        return getWeekData().reduce((sum, d) => sum + d.minutes, 0);
      }

      function getDailyGoal() {
        return state.settings.dailyGoal;
      }

      // Format minutes based on unit setting (returns { value, unit, label })
      function formatTimeByUnit(minutes) {
        const unit = state.settings.dailyGoalUnit;
        if (unit === 'hours') {
          const hrs = Math.round(minutes / 6) / 10; // one decimal place
          return { value: hrs, unit: hrs === 1 ? 'hr' : 'hrs', label: 'Hrs' };
        }
        return { value: minutes, unit: 'min', label: 'Min' };
      }

      function updateBestStreak() {
        const current = calculateStreak();
        if (current > state.stats.bestStreak) {
          state.stats.bestStreak = current;
          saveStats();
        }
      }

      function updateTodayProgress() {
        const today = todayKey();
        const minutes = state.stats.dailyMinutes[today] || 0;
        const sessions = state.stats.dailyCounts[today] || 0;
        const goal = getDailyGoal();
        const unit = state.settings.dailyGoalUnit;
        const formatted = formatTimeByUnit(minutes);

        let pct;
        let goalUnitLabel;
        if (unit === 'hours') {
          pct = Math.min(100, Math.round((minutes / (goal * 60)) * 100));
          goalUnitLabel = goal === 1 ? 'hr' : 'hrs';
        } else if (unit === 'pomodoros') {
          pct = Math.min(100, Math.round((sessions / goal) * 100));
          goalUnitLabel = goal === 1 ? 'pomodoro' : 'pomodoros';
        } else {
          pct = Math.min(100, Math.round((minutes / goal) * 100));
          goalUnitLabel = 'min';
        }

        todayMinutesEl.textContent = formatted.value;
        todayMinutesUnit.textContent = formatted.unit;
        // Show hours on left side when unit is hours, otherwise show sessions
        if (unit === 'hours') {
          todayDetailLeft.innerHTML = `<span>${formatted.value}</span> ${formatted.unit}`;
        } else {
          todayDetailLeft.innerHTML = `<span id="todaySessions">${sessions}</span> sessions`;
        }
        dailyGoalEl.textContent = goal;
        dailyGoalUnitLabel.textContent = goalUnitLabel;
        progressFill.style.width = pct + '%';
      }

      function updateWeeklyChart() {
        const week = getWeekData();
        const maxMin = Math.max(...week.map((d) => d.minutes), 1);
        const weekTotal = week.reduce((s, d) => s + d.minutes, 0);
        const formatted = formatTimeByUnit(weekTotal);

        weekTotalMin.textContent = formatted.value;
        weekTotalUnit.textContent = formatted.unit;
        chartBars.innerHTML = '';

        week.forEach((day) => {
          const col = document.createElement('div');
          col.className = 'chart-col';

          const barWrap = document.createElement('div');
          barWrap.className = 'chart-bar-wrap';

          const bar = document.createElement('div');
          const heightPct = day.minutes > 0 ? Math.max(8, (day.minutes / maxMin) * 100) : 0;
          bar.className = 'chart-bar' + (day.minutes === 0 ? ' empty' : '');
          bar.style.height = heightPct + '%';

          if (day.minutes > 0) {
            const val = document.createElement('span');
            val.className = 'chart-bar-value';
            const dayFormatted = formatTimeByUnit(day.minutes);
            val.textContent = dayFormatted.value;
            bar.appendChild(val);
          }

          barWrap.appendChild(bar);
          col.appendChild(barWrap);

          const label = document.createElement('span');
          label.className = 'chart-day' + (day.isToday ? ' today' : '');
          label.textContent = day.dayName;
          col.appendChild(label);

          chartBars.appendChild(col);
        });
      }

      function updateStats() {
        const today = todayKey();
        const sessions = state.stats.dailyCounts[today] || 0;
        const minutes = state.stats.dailyMinutes[today] || 0;
        const weekMinutes = getWeekTotalMinutes();

        const todayFormatted = formatTimeByUnit(minutes);
        const weekFormatted = formatTimeByUnit(weekMinutes);

        statTodayMin.textContent = todayFormatted.value;
        statTodayMinLabel.textContent = todayFormatted.label + ' Today';
        statTodaySessions.textContent = sessions;
        statWeekTotal.textContent = weekFormatted.value;
        statWeekTotalLabel.textContent = weekFormatted.label + ' This Week';
        updateBestStreak();
        statBestStreak.textContent = state.stats.bestStreak;

        updateTodayProgress();
        updateWeeklyChart();
      }

      function updateDocumentTitle() {
        if (state.status === 'running' || state.status === 'paused') {
          document.title = `${formatTime(state.timeRemaining)} — ${getModeName(state.mode)}`;
        } else {
          document.title = 'Pomodoro Timer';
        }
      }

      // --- Dialog openers for Stats / Leaderboard ---
      function openStatsDialog() {
        updateStats();
        statsDialog.showModal();
        statsBtn.classList.add('active');
      }

      function openLeaderboardDialog() {
        loadLeaderboard();
        leaderboardDialog.showModal();
        leaderboardBtn.classList.add('active');
      }

      // --- Auth UI ---
      function updateAuthUI() {
        const loggedIn = !!state.user;
        signInBtn.classList.toggle('hidden', loggedIn);
        userAvatarWrap.classList.toggle('hidden', !loggedIn);
        authPrompt.classList.toggle('hidden', loggedIn);
        statsBtn.classList.toggle('hidden', !loggedIn);
        leaderboardBtn.classList.toggle('hidden', !loggedIn);
        if (loggedIn) {
          userAvatarImg.src = state.user.photoURL || '';
          userAvatarImg.alt = state.user.displayName || '';
        }
      }

      function showUserMenu() {
        if (state.userMenuOpen) { hideUserMenu(); return; }
        state.userMenuOpen = true;
        // Remove existing menu
        const old = document.querySelector('.user-menu-backdrop');
        if (old) old.remove();

        const backdrop = document.createElement('div');
        backdrop.className = 'user-menu-backdrop';
        backdrop.addEventListener('click', hideUserMenu);

        const menu = document.createElement('div');
        menu.className = 'user-menu';

        const nameDiv = document.createElement('div');
        nameDiv.className = 'user-menu-name';
        nameDiv.textContent = state.user.displayName || 'User';
        menu.appendChild(nameDiv);

        const emailDiv = document.createElement('div');
        emailDiv.className = 'user-menu-email';
        emailDiv.textContent = state.user.email || '';
        menu.appendChild(emailDiv);

        const signOutItem = document.createElement('button');
        signOutItem.className = 'user-menu-item';
        signOutItem.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Sign out';
        signOutItem.addEventListener('click', () => {
          hideUserMenu();
          fbAuth.signOut();
        });
        menu.appendChild(signOutItem);

        document.body.appendChild(backdrop);
        userAvatarWrap.appendChild(menu);
      }

      function hideUserMenu() {
        state.userMenuOpen = false;
        const backdrop = document.querySelector('.user-menu-backdrop');
        if (backdrop) backdrop.remove();
        const menu = document.querySelector('.user-menu');
        if (menu) menu.remove();
      }

      let isNewSignIn = false; // Track fresh sign-ins vs page refreshes

      function signInWithGoogle() {
        isNewSignIn = true; // Mark as fresh sign-in
        const provider = new firebase.auth.GoogleAuthProvider();
        fbAuth.signInWithPopup(provider).catch(() => { isNewSignIn = false; });
      }

      // --- Firestore Sync ---
      async function syncStatsToFirestore() {
        if (!state.user) return;
        const uid = state.user.uid;
        const ref = fbDb.collection('users').doc(uid);
        try {
          const doc = await ref.get();
          const cloud = doc.exists ? doc.data() : {};
          // Merge local into cloud
          const mergedDailyCounts = { ...(cloud.dailyCounts || {}) };
          const mergedDailyMinutes = { ...(cloud.dailyMinutes || {}) };
          const localCounts = state.stats.dailyCounts || {};
          const localMinutes = state.stats.dailyMinutes || {};
          for (const key of Object.keys(localCounts)) {
            mergedDailyCounts[key] = (mergedDailyCounts[key] || 0) + (localCounts[key] || 0);
          }
          for (const key of Object.keys(localMinutes)) {
            mergedDailyMinutes[key] = (mergedDailyMinutes[key] || 0) + (localMinutes[key] || 0);
          }
          const totalSessions = Object.values(mergedDailyCounts).reduce((a, b) => a + b, 0);
          const totalMinutes = Object.values(mergedDailyMinutes).reduce((a, b) => a + b, 0);
          const bestStreak = Math.max(state.stats.bestStreak || 0, cloud.bestStreak || 0);

          await ref.set({
            displayName: state.user.displayName || '',
            photoURL: state.user.photoURL || '',
            totalMinutes,
            totalSessions,
            bestStreak,
            dailyCounts: mergedDailyCounts,
            dailyMinutes: mergedDailyMinutes,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          }, { merge: true });

          // Update local state from merged cloud data and clear local
          // so we don't double-count on next sign-in
          state.stats.dailyCounts = {};
          state.stats.dailyMinutes = {};
          state.stats.totalPomodoros = 0;
          state.stats.bestStreak = 0;
          saveStats();
        } catch {}
      }

      async function pullStatsFromFirestore() {
        if (!state.user) return;
        const uid = state.user.uid;
        try {
          const doc = await fbDb.collection('users').doc(uid).get();
          if (doc.exists) {
            const data = doc.data();
            state.stats.dailyCounts = data.dailyCounts || {};
            state.stats.dailyMinutes = data.dailyMinutes || {};
            state.stats.totalPomodoros = data.totalSessions || 0;
            state.stats.bestStreak = data.bestStreak || 0;
            saveStats();
            updateStats();
          }
        } catch {}
      }

      async function updateFirestoreOnComplete() {
        if (!state.user) return;
        const uid = state.user.uid;
        const ref = fbDb.collection('users').doc(uid);
        const today = todayKey();
        try {
          const doc = await ref.get();
          const cloud = doc.exists ? doc.data() : {};
          const dailyCounts = cloud.dailyCounts || {};
          const dailyMinutes = cloud.dailyMinutes || {};
          dailyCounts[today] = (dailyCounts[today] || 0) + 1;
          dailyMinutes[today] = (dailyMinutes[today] || 0) + state.settings.focusDuration;
          const totalSessions = Object.values(dailyCounts).reduce((a, b) => a + b, 0);
          const totalMinutes = Object.values(dailyMinutes).reduce((a, b) => a + b, 0);
          const bestStreak = Math.max(state.stats.bestStreak || 0, cloud.bestStreak || 0);

          await ref.set({
            displayName: state.user.displayName || '',
            photoURL: state.user.photoURL || '',
            totalMinutes,
            totalSessions,
            bestStreak,
            dailyCounts,
            dailyMinutes,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          }, { merge: true });
        } catch {}
      }

      // --- Leaderboard ---
      async function loadLeaderboard() {
        if (!state.user) return;
        try {
          const snap = await fbDb.collection('users')
            .orderBy('totalMinutes', 'desc')
            .limit(10)
            .get();

          leaderboardList.innerHTML = '';
          let currentInTop10 = false;
          let rank = 0;

          snap.forEach((doc) => {
            rank++;
            const d = doc.data();
            const isCurrent = doc.id === state.user.uid;
            if (isCurrent) currentInTop10 = true;
            leaderboardList.appendChild(createLeaderboardRow(rank, d, isCurrent));
          });

          if (rank === 0) {
            const li = document.createElement('li');
            li.className = 'leaderboard-empty';
            li.textContent = 'No data yet. Complete a focus session!';
            leaderboardList.appendChild(li);
            return;
          }

          // If current user not in top 10, find their rank and append
          if (!currentInTop10) {
            const userDoc = await fbDb.collection('users').doc(state.user.uid).get();
            if (userDoc.exists) {
              const userData = userDoc.data();
              const userMinutes = userData.totalMinutes || 0;
              // Count how many users have more minutes
              const countSnap = await fbDb.collection('users')
                .where('totalMinutes', '>', userMinutes)
                .get();
              const userRank = countSnap.size + 1;

              const divider = document.createElement('li');
              divider.className = 'leaderboard-divider';
              divider.setAttribute('aria-hidden', 'true');
              leaderboardList.appendChild(divider);
              leaderboardList.appendChild(createLeaderboardRow(userRank, userData, true));
            }
          }
        } catch {}
      }

      function createLeaderboardRow(rank, data, isCurrent) {
        const li = document.createElement('li');
        li.className = 'leaderboard-row' + (isCurrent ? ' current-user' : '');

        const rankEl = document.createElement('span');
        rankEl.className = 'leaderboard-rank';
        if (rank === 1) rankEl.classList.add('gold');
        else if (rank === 2) rankEl.classList.add('silver');
        else if (rank === 3) rankEl.classList.add('bronze');
        rankEl.textContent = rank;

        const avatar = document.createElement('img');
        avatar.className = 'leaderboard-avatar';
        avatar.src = data.photoURL || '';
        avatar.alt = '';
        avatar.referrerPolicy = 'no-referrer';
        avatar.onerror = function() { this.style.display = 'none'; };

        const name = document.createElement('span');
        name.className = 'leaderboard-name';
        name.textContent = data.displayName || 'Anonymous';

        const mins = document.createElement('span');
        mins.className = 'leaderboard-minutes';
        mins.textContent = (data.totalMinutes || 0) + ' min';

        li.appendChild(rankEl);
        li.appendChild(avatar);
        li.appendChild(name);
        li.appendChild(mins);
        return li;
      }

      function updateThemeIcons() {
        const isDark = root.dataset.theme === 'dark';
        sunIcon.classList.toggle('hidden', isDark);
        moonIcon.classList.toggle('hidden', !isDark);
      }

      function updateAll() {
        updateTimerDisplay();
        updateProgressRing();
        updateControls();
        updateModeIndicator();
        updateSessionDots();
        updateStats();
        updateDocumentTitle();
        updateThemeIcons();
        updateAuthUI();
      }

      // --- Timer Engine ---
      function tick() {
        if (state.status !== 'running') return;
        const now = Date.now();
        const remaining = Math.round((state.endTime - now) / 1000);
        state.timeRemaining = Math.max(0, remaining);

        updateTimerDisplay();
        updateProgressRing();
        updateDocumentTitle();

        if (state.timeRemaining <= 0) {
          complete();
        }
      }

      function start() {
        if (state.status === 'running') return;
        requestNotificationPermission();

        if (state.status === 'idle') {
          state.totalTime = getDurationForMode(state.mode);
          state.timeRemaining = state.totalTime;
        }

        state.endTime = Date.now() + state.timeRemaining * 1000;
        state.status = 'running';
        state.intervalId = setInterval(tick, 250);

        updateAll();
      }

      function pause() {
        if (state.status !== 'running') return;
        clearInterval(state.intervalId);
        state.intervalId = null;
        // Recalculate exact remaining
        state.timeRemaining = Math.max(0, Math.round((state.endTime - Date.now()) / 1000));
        state.status = 'paused';
        updateAll();
      }

      function reset() {
        clearInterval(state.intervalId);
        state.intervalId = null;
        state.status = 'idle';
        state.totalTime = getDurationForMode(state.mode);
        state.timeRemaining = state.totalTime;
        updateAll();
      }

      function complete() {
        clearInterval(state.intervalId);
        state.intervalId = null;
        state.status = 'idle';
        state.timeRemaining = 0;

        updateTimerDisplay();
        updateProgressRing();

        if (state.mode === 'focus') {
          // Check if first pomodoro of day BEFORE incrementing
          const today = todayKey();
          const isFirstOfDay = !state.stats.dailyCounts[today] || state.stats.dailyCounts[today] === 0;

          // Completed a pomodoro
          state.completedInCycle++;
          state.stats.totalPomodoros++;
          state.stats.dailyCounts[today] = (state.stats.dailyCounts[today] || 0) + 1;
          state.stats.dailyMinutes[today] = (state.stats.dailyMinutes[today] || 0) + state.settings.focusDuration;
          saveStats();

          playChime('focus');
          sendNotification('Pomodoro Complete!', 'Time for a break.');
          updateFirestoreOnComplete().then(() => loadLeaderboard());

          // Show celebration for first pomodoro of the day
          if (isFirstOfDay) {
            showCelebration("You just completed your 1st pomodoro, keep going!");
          }

          // Switch to break
          if (state.completedInCycle >= state.settings.longBreakInterval) {
            switchMode('longbreak');
          } else {
            switchMode('break');
          }
        } else {
          // Break complete
          playChime('break');
          sendNotification('Break Over!', 'Time to focus.');

          if (state.mode === 'longbreak') {
            state.completedInCycle = 0;
          }
          switchMode('focus');
        }

        if (state.settings.autoStart) {
          start();
        } else {
          updateAll();
        }
      }

      function switchMode(newMode) {
        state.mode = newMode;
        state.totalTime = getDurationForMode(newMode);
        state.timeRemaining = state.totalTime;
        state.status = 'idle';
        updateModeIndicator();
      }

      // --- Visibility change (catch-up on tab switch) ---
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && state.status === 'running') {
          tick();
        }
      });

      // --- Event listeners ---
      startBtn.addEventListener('click', start);
      pauseBtn.addEventListener('click', pause);
      resetBtn.addEventListener('click', reset);

      // Mode tabs
      modeTabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          const newMode = tab.dataset.mode;
          if (newMode === state.mode) return;
          clearInterval(state.intervalId);
          state.intervalId = null;
          switchMode(newMode);
          updateAll();
        });
      });

      // Theme toggle
      themeToggle.addEventListener('click', () => {
        const newTheme = root.dataset.theme === 'dark' ? 'light' : 'dark';
        root.dataset.theme = newTheme;
        saveTheme(newTheme);
        themeColorMeta.content = getThemeColor();
        updateThemeIcons();
      });

      // Settings
      settingsBtn.addEventListener('click', () => {
        $('#focusDuration').value = state.settings.focusDuration;
        $('#breakDuration').value = state.settings.breakDuration;
        $('#longBreakDuration').value = state.settings.longBreakDuration;
        $('#longBreakInterval').value = state.settings.longBreakInterval;
        $('#dailyGoalInput').value = state.settings.dailyGoal;
        $('#dailyGoalUnit').value = state.settings.dailyGoalUnit;
        $('#autoStart').checked = state.settings.autoStart;
        $('#soundEnabled').checked = state.settings.soundEnabled;
        settingsDialog.showModal();
      });

      closeSettingsBtn.addEventListener('click', () => settingsDialog.close());
      cancelSettingsBtn.addEventListener('click', () => settingsDialog.close());

      settingsForm.addEventListener('submit', (e) => {
        e.preventDefault();
        state.settings.focusDuration = parseInt($('#focusDuration').value) || DEFAULTS.focusDuration;
        state.settings.breakDuration = parseInt($('#breakDuration').value) || DEFAULTS.breakDuration;
        state.settings.longBreakDuration = parseInt($('#longBreakDuration').value) || DEFAULTS.longBreakDuration;
        state.settings.longBreakInterval = parseInt($('#longBreakInterval').value) || DEFAULTS.longBreakInterval;
        state.settings.dailyGoal = parseInt($('#dailyGoalInput').value) || DEFAULTS.dailyGoal;
        state.settings.dailyGoalUnit = $('#dailyGoalUnit').value || DEFAULTS.dailyGoalUnit;
        state.settings.autoStart = $('#autoStart').checked;
        state.settings.soundEnabled = $('#soundEnabled').checked;
        saveSettings();

        // Update session dots count
        const dots = sessionDotsEl.querySelectorAll('.dot');
        const needed = state.settings.longBreakInterval;
        // Add dots if needed
        while (sessionDotsEl.children.length < needed) {
          const dot = document.createElement('div');
          dot.className = 'dot';
          dot.dataset.dot = sessionDotsEl.children.length;
          sessionDotsEl.appendChild(dot);
        }

        // If idle, reset timer to new duration
        if (state.status === 'idle') {
          state.totalTime = getDurationForMode(state.mode);
          state.timeRemaining = state.totalTime;
        }

        settingsDialog.close();
        updateAll();
      });

      // Close dialog on backdrop click
      settingsDialog.addEventListener('click', (e) => {
        if (e.target === settingsDialog) settingsDialog.close();
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Don't trigger shortcuts when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        // Don't trigger when dialog is open (except Escape)
        if (settingsDialog.open && e.key !== 'Escape') return;

        switch (e.key) {
          case ' ':
            e.preventDefault();
            if (state.status === 'running') pause();
            else start();
            break;
          case 'r':
          case 'R':
            e.preventDefault();
            reset();
            break;
          case 'Escape':
            if (settingsDialog.open) settingsDialog.close();
            break;
        }
      });

      // --- Stats / Leaderboard dialog buttons ---
      statsBtn.addEventListener('click', openStatsDialog);
      leaderboardBtn.addEventListener('click', openLeaderboardDialog);
      closeStatsBtn.addEventListener('click', () => statsDialog.close());
      closeLeaderboardBtn.addEventListener('click', () => leaderboardDialog.close());
      statsDialog.addEventListener('click', (e) => { if (e.target === statsDialog) statsDialog.close(); });
      leaderboardDialog.addEventListener('click', (e) => { if (e.target === leaderboardDialog) leaderboardDialog.close(); });
      statsDialog.addEventListener('close', () => statsBtn.classList.remove('active'));
      leaderboardDialog.addEventListener('close', () => leaderboardBtn.classList.remove('active'));

      // --- Auth event listeners ---
      signInBtn.addEventListener('click', signInWithGoogle);
      authPromptBtn.addEventListener('click', signInWithGoogle);
      userAvatarBtn.addEventListener('click', showUserMenu);

      // Firebase auth state observer
      fbAuth.onAuthStateChanged(async (user) => {
        state.user = user;
        updateAuthUI();
        if (user) {
          if (isNewSignIn) {
            // Only merge local stats on fresh sign-in, not page refresh
            await syncStatsToFirestore();
            isNewSignIn = false;
          }
          // Pull latest data from Firestore
          await pullStatsFromFirestore();
          updateStats();
          loadLeaderboard();
        }
      });

      // --- Init ---
      function init() {
        loadSettings();
        loadStats();

        const theme = loadTheme();
        root.dataset.theme = theme;

        state.mode = 'focus';
        state.totalTime = getDurationForMode('focus');
        state.timeRemaining = state.totalTime;

        updateAll();

        // Service worker registration
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(() => {});
          });
        }
      }

      init();
    })();
  </script>
</body>
</html>
