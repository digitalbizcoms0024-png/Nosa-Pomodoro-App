<!DOCTYPE html>
<html lang="en" data-theme="light" data-mode="focus">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#e74c3c">
  <meta name="description" content="A focused pomodoro timer to boost your productivity">
  <title>Pomodoro Timer</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Ccircle cx='256' cy='280' r='200' fill='%23e74c3c'/%3E%3Ccircle cx='256' cy='280' r='170' fill='%23c0392b'/%3E%3Ccircle cx='256' cy='280' r='160' fill='%23e74c3c'/%3E%3Crect x='250' y='130' width='12' height='100' rx='6' fill='%23fff'/%3E%3Crect x='250' y='230' width='12' height='60' rx='6' fill='%23fff' transform='rotate(30 256 280)'/%3E%3Cellipse cx='256' cy='100' rx='12' ry='20' fill='%2327ae60'/%3E%3Cellipse cx='240' cy='95' rx='18' ry='10' fill='%2327ae60' transform='rotate(-30 240 95)'/%3E%3Cellipse cx='272' cy='95' rx='18' ry='10' fill='%2327ae60' transform='rotate(30 272 95)'/%3E%3C/svg%3E">
  <script>
    (function(){var t=localStorage.getItem('pomodoro-theme');if(t)document.documentElement.setAttribute('data-theme',t)})();
  </script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.10);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 9999px;
      --transition: 600ms ease;
    }

    /* Light Focus */
    html[data-theme="light"][data-mode="focus"] {
      --bg: #fdf6f4;
      --surface: #ffffff;
      --primary: #e74c3c;
      --primary-hover: #c0392b;
      --text: #2c2c2c;
      --text-secondary: #666666;
      --ring-track: #f0d5d1;
      --border: #e8e0de;
      --chart-primary: #e74c3c;
      --chart-secondary: #3498db;
      --chart-accent: #f39c12;
      --chart-grid: #e8e0de;
      --chart-text: #2c2c2c;
      --chart-success: #27ae60;
    }

    /* Light Break */
    html[data-theme="light"][data-mode="break"],
    html[data-theme="light"][data-mode="longbreak"] {
      --bg: #f4fdf6;
      --surface: #ffffff;
      --primary: #27ae60;
      --primary-hover: #1e8449;
      --text: #2c2c2c;
      --text-secondary: #666666;
      --ring-track: #c8e6c9;
      --border: #d5e8d7;
    }

    /* Dark Focus */
    html[data-theme="dark"][data-mode="focus"] {
      --bg: #1a1215;
      --surface: #2d2024;
      --primary: #e74c3c;
      --primary-hover: #ff6b5a;
      --text: #f0e6e6;
      --text-secondary: #a89999;
      --ring-track: #4a2a2a;
      --border: #3d2a2e;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.16);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.20);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.24);
      --chart-primary: #e74c3c;
      --chart-secondary: #5dade2;
      --chart-accent: #f5b041;
      --chart-grid: #3d2a2e;
      --chart-text: #f0e6e6;
      --chart-success: #2ecc71;
    }

    /* Dark Break */
    html[data-theme="dark"][data-mode="break"],
    html[data-theme="dark"][data-mode="longbreak"] {
      --bg: #121a15;
      --surface: #1e2d22;
      --primary: #2ecc71;
      --primary-hover: #58d68d;
      --text: #e6f0e8;
      --text-secondary: #8fb898;
      --ring-track: #1e3d24;
      --border: #2a3d2e;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.16);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.20);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.24);
    }

    /* Premium Theme: Ocean */
    html[data-theme="ocean"][data-mode="focus"] {
      --bg: #f0f8ff;
      --surface: #ffffff;
      --primary: #2980b9;
      --primary-hover: #1f6a9e;
      --text: #2c2c2c;
      --text-secondary: #666666;
      --ring-track: #cce5f6;
      --border: #d4e6f3;
      --chart-primary: #2980b9;
      --chart-secondary: #16a085;
      --chart-accent: #e67e22;
      --chart-grid: #d4e6f3;
      --chart-text: #2c2c2c;
      --chart-success: #27ae60;
    }

    html[data-theme="ocean"][data-mode="break"],
    html[data-theme="ocean"][data-mode="longbreak"] {
      --bg: #f0f8ff;
      --surface: #ffffff;
      --primary: #16a085;
      --primary-hover: #138d75;
      --text: #2c2c2c;
      --text-secondary: #666666;
      --ring-track: #c8e6e0;
      --border: #d4e8e3;
    }

    /* Premium Theme: Forest */
    html[data-theme="forest"][data-mode="focus"] {
      --bg: #f4f8f4;
      --surface: #ffffff;
      --primary: #27ae60;
      --primary-hover: #1e8449;
      --text: #2c2c2c;
      --text-secondary: #666666;
      --ring-track: #c8e6c9;
      --border: #d5e8d7;
      --chart-primary: #27ae60;
      --chart-secondary: #2980b9;
      --chart-accent: #f39c12;
      --chart-grid: #d5e8d7;
      --chart-text: #2c2c2c;
      --chart-success: #2ecc71;
    }

    html[data-theme="forest"][data-mode="break"],
    html[data-theme="forest"][data-mode="longbreak"] {
      --bg: #f4f8f4;
      --surface: #ffffff;
      --primary: #2ecc71;
      --primary-hover: #28b463;
      --text: #2c2c2c;
      --text-secondary: #666666;
      --ring-track: #d0edd1;
      --border: #d9edd9;
    }

    /* Premium Theme: Sunset */
    html[data-theme="sunset"][data-mode="focus"] {
      --bg: #fff5ee;
      --surface: #ffffff;
      --primary: #ff6b6b;
      --primary-hover: #e85555;
      --text: #2c2c2c;
      --text-secondary: #666666;
      --ring-track: #ffd6d6;
      --border: #ffe0d9;
      --chart-primary: #ff6b6b;
      --chart-secondary: #f39c12;
      --chart-accent: #9b59b6;
      --chart-grid: #ffe0d9;
      --chart-text: #2c2c2c;
      --chart-success: #27ae60;
    }

    html[data-theme="sunset"][data-mode="break"],
    html[data-theme="sunset"][data-mode="longbreak"] {
      --bg: #fff5ee;
      --surface: #ffffff;
      --primary: #f39c12;
      --primary-hover: #d68910;
      --text: #2c2c2c;
      --text-secondary: #666666;
      --ring-track: #fce4c3;
      --border: #fae8d0;
    }

    /* Premium Theme: Lavender */
    html[data-theme="lavender"][data-mode="focus"] {
      --bg: #f8f5ff;
      --surface: #ffffff;
      --primary: #9b59b6;
      --primary-hover: #884ea0;
      --text: #2c2c2c;
      --text-secondary: #666666;
      --ring-track: #e8daef;
      --border: #ebdff0;
      --chart-primary: #9b59b6;
      --chart-secondary: #3498db;
      --chart-accent: #e74c3c;
      --chart-grid: #ebdff0;
      --chart-text: #2c2c2c;
      --chart-success: #27ae60;
    }

    html[data-theme="lavender"][data-mode="break"],
    html[data-theme="lavender"][data-mode="longbreak"] {
      --bg: #f8f5ff;
      --surface: #ffffff;
      --primary: #8e44ad;
      --primary-hover: #7d3c98;
      --text: #2c2c2c;
      --text-secondary: #666666;
      --ring-track: #e0d0e8;
      --border: #e5d9ed;
    }

    /* Premium Theme: Charcoal */
    html[data-theme="charcoal"][data-mode="focus"] {
      --bg: #1a1a1a;
      --surface: #2a2a2a;
      --primary: #ff7675;
      --primary-hover: #ff9190;
      --text: #f0f0f0;
      --text-secondary: #a0a0a0;
      --ring-track: #4a2a2a;
      --border: #3d3d3d;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.16);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.20);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.24);
      --chart-primary: #ff7675;
      --chart-secondary: #74b9ff;
      --chart-accent: #ffeaa7;
      --chart-grid: #3d3d3d;
      --chart-text: #f0f0f0;
      --chart-success: #55efc4;
    }

    html[data-theme="charcoal"][data-mode="break"],
    html[data-theme="charcoal"][data-mode="longbreak"] {
      --bg: #1a1a1a;
      --surface: #2a2a2a;
      --primary: #55efc4;
      --primary-hover: #6ff5d0;
      --text: #f0f0f0;
      --text-secondary: #a0a0a0;
      --ring-track: #1e3d34;
      --border: #3d3d3d;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.16);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.20);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.24);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background var(--transition), color var(--transition);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      -webkit-font-smoothing: antialiased;
    }

    .app {
      width: 100%;
      max-width: 420px;
      padding: 16px 20px 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      animation: fadeIn 400ms ease;
    }

    /* Header */
    .header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
      transition: color var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo svg { width: 28px; height: 28px; }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: var(--surface);
      color: var(--text-secondary);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background var(--transition), color var(--transition), box-shadow var(--transition);
      box-shadow: var(--shadow-sm);
      touch-action: manipulation;
    }

    .icon-btn:hover { color: var(--primary); box-shadow: var(--shadow-md); }
    .icon-btn svg { width: 20px; height: 20px; }

    /* Mode tabs */
    .mode-tabs {
      display: flex;
      background: var(--surface);
      border-radius: var(--radius-full);
      padding: 4px;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), box-shadow var(--transition);
      width: 100%;
      max-width: 340px;
    }

    .mode-tab {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.8125rem;
      font-weight: 600;
      padding: 8px 4px;
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: background 300ms ease, color 300ms ease;
      touch-action: manipulation;
      white-space: nowrap;
    }

    .mode-tab:hover {
      color: var(--text);
    }

    .mode-tab.active {
      background: var(--primary);
      color: #fff;
      box-shadow: var(--shadow-sm);
    }

    /* Active icon button (page nav highlight) */
    .icon-btn.active { color: var(--primary); }

    /* Tooltip for icon buttons */
    .icon-btn[data-tooltip],
    .theme-toggle-fixed[data-tooltip] {
      position: relative;
    }

    .icon-btn[data-tooltip]::after,
    .theme-toggle-fixed[data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--text);
      color: var(--bg);
      font-size: 0.6875rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 6px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 150ms ease;
      z-index: 60;
    }

    .icon-btn[data-tooltip]:hover::after,
    .theme-toggle-fixed[data-tooltip]:hover::after {
      opacity: 1;
    }

    /* Fixed dark mode toggle */
    .theme-toggle-fixed {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 50;
      width: 40px;
      height: 40px;
      border: none;
      background: var(--surface);
      color: var(--text-secondary);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background var(--transition), color var(--transition), box-shadow var(--transition);
      box-shadow: var(--shadow-md);
      touch-action: manipulation;
    }

    .theme-toggle-fixed:hover { color: var(--primary); box-shadow: var(--shadow-lg); }
    .theme-toggle-fixed svg { width: 20px; height: 20px; }

    /* Page sections */
    .page-section {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
    }

    /* Mode indicator (sr-only, kept for aria-live) */
    .mode-label {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
    }

    /* Timer ring */
    .timer-container {
      position: relative;
      width: clamp(260px, 68vw, 340px);
      height: clamp(260px, 68vw, 340px);
    }

    .timer-svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg) scaleX(-1);
    }

    .ring-track {
      fill: none;
      stroke: #ffffff !important;
      stroke-width: 8;
    }

    .ring-progress {
      fill: none;
      stroke: var(--primary);
      stroke-width: 8;
      stroke-linecap: round;
      stroke-dasharray: 565.49;
      stroke-dashoffset: 0;
      transition: stroke var(--transition), stroke-dashoffset 0.3s linear;
    }

    .timer-display {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .time-text {
      font-size: clamp(3.5rem, 15vw, 6rem);
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      line-height: 1;
      color: var(--text);
      transition: color var(--transition);
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn {
      height: 48px;
      padding: 0 28px;
      border: none;
      border-radius: var(--radius-full);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background var(--transition), color var(--transition), box-shadow var(--transition), transform 100ms ease;
      touch-action: manipulation;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn:active { transform: scale(0.96); }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover { background: var(--primary-hover); box-shadow: var(--shadow-lg); }

    .btn-secondary {
      background: var(--surface);
      color: var(--primary);
      box-shadow: var(--shadow-sm);
      border: 2px solid var(--primary);
    }

    .btn-secondary:hover { box-shadow: var(--shadow-md); }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      padding: 0 16px;
    }

    .btn-ghost:hover { color: var(--text); background: var(--surface); }

    .hidden { display: none !important; }

    /* Session dots */
    .session-dots {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--ring-track);
      transition: background var(--transition), transform 200ms ease;
    }

    .dot.completed {
      background: var(--primary);
      transform: scale(1.15);
    }

    .dot.active {
      background: var(--primary);
      animation: pulse 1.5s ease infinite;
    }

    /* Task List */
    .tasks-section {
      width: 100%;
      max-width: 340px;
      margin-top: 8px;
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), box-shadow var(--transition);
      animation: slideUp 400ms ease both;
    }

    .tasks-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 0.8125rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .tasks-header:hover {
      color: var(--text);
    }

    .tasks-toggle-icon {
      transition: transform 200ms ease;
    }

    .tasks-section.expanded .tasks-toggle-icon {
      transform: rotate(180deg);
    }

    .tasks-body {
      display: none;
      flex-direction: column;
      gap: 8px;
    }

    .tasks-section.expanded .tasks-body {
      display: flex;
      margin-top: 12px;
    }

    .task-input-row {
      display: flex;
      gap: 8px;
    }

    .task-input-row input {
      flex: 1;
      height: 38px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0 12px;
      font-size: 0.875rem;
      background: var(--surface);
      color: var(--text);
      transition: border-color 200ms ease;
    }

    .task-input-row input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .task-input-row input::placeholder {
      color: var(--text-secondary);
    }

    .task-input-row button {
      padding: 0 16px;
      height: 38px;
      font-size: 0.875rem;
    }

    .task-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 200px;
      overflow-y: auto;
    }

    .task-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--surface);
      border-radius: var(--radius-sm);
      transition: background 150ms ease, opacity 150ms ease;
      animation: slideUp 200ms ease;
    }

    .task-item:hover {
      background: var(--ring-track);
    }

    .project-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-bottom: 1px solid var(--border);
    }

    .project-dropdown {
      flex: 1;
      position: relative;
    }
    .project-dropdown-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 0.85rem;
      cursor: pointer;
      transition: border-color 200ms ease;
    }
    .project-dropdown-btn:hover { border-color: var(--primary); }
    .project-dropdown-menu {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: var(--shadow-md);
      z-index: 50;
      max-height: 200px;
      overflow-y: auto;
    }
    .project-dropdown-menu.open { display: block; }
    .project-dropdown-option {
      padding: 8px 12px;
      font-size: 0.85rem;
      color: var(--text-primary);
      cursor: pointer;
      transition: background 100ms ease;
    }
    .project-dropdown-option:first-child { border-radius: 7px 7px 0 0; }
    .project-dropdown-option:last-child { border-radius: 0 0 7px 7px; }
    .project-dropdown-option:hover { background: var(--bg-secondary); }
    .project-dropdown-option.active {
      color: var(--primary);
      font-weight: 600;
    }

    .btn-icon {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
    }

    .btn-icon:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .project-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
    }

    .project-item .project-name {
      flex: 1;
      font-size: 0.9rem;
    }

    .project-item .btn-icon {
      opacity: 0.6;
    }

    .project-item .btn-icon:hover {
      opacity: 1;
    }

    .task-project-badge {
      font-size: 0.7rem;
      padding: 1px 6px;
      border-radius: 4px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .task-checkbox {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
      cursor: pointer;
    }

    .task-text {
      flex: 1;
      font-size: 0.9rem;
      color: var(--text);
      word-break: break-word;
    }

    .task-item.completed .task-text {
      text-decoration: line-through;
      color: var(--text-secondary);
    }

    .task-delete {
      opacity: 0;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      font-size: 0.75rem;
      transition: opacity 150ms ease, color 150ms ease;
    }

    .task-item:hover .task-delete {
      opacity: 1;
    }

    .task-delete:hover {
      color: #e74c3c;
    }

    .tasks-empty {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.8125rem;
      padding: 12px;
    }

    /* Today's progress */
    .today-progress {
      width: 100%;
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), box-shadow var(--transition);
      animation: slideUp 400ms ease both;
    }

    .today-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
    }

    .today-title {
      font-size: 0.8125rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      transition: color var(--transition);
    }

    .today-summary {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
      transition: color var(--transition);
    }

    .today-summary strong {
      color: var(--primary);
      font-weight: 700;
      transition: color var(--transition);
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--ring-track);
      border-radius: 4px;
      overflow: hidden;
      transition: background var(--transition);
    }

    .progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 400ms ease, background var(--transition);
      min-width: 0;
    }

    .today-detail {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
      transition: color var(--transition);
    }

    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      width: 100%;
    }

    .stat-card {
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 14px 8px;
      text-align: center;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), box-shadow var(--transition);
      animation: slideUp 400ms ease both;
    }

    .stat-card:nth-child(2) { animation-delay: 60ms; }
    .stat-card:nth-child(3) { animation-delay: 120ms; }
    .stat-card:nth-child(4) { animation-delay: 180ms; }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      font-variant-numeric: tabular-nums;
      transition: color var(--transition);
    }

    .stat-label {
      font-size: 0.6875rem;
      color: var(--text-secondary);
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: color var(--transition);
    }

    /* Weekly chart */
    .weekly-chart {
      width: 100%;
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), box-shadow var(--transition);
      animation: slideUp 400ms ease both;
      animation-delay: 240ms;
    }

    .weekly-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 24px;
    }

    .weekly-title {
      font-size: 0.8125rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      transition: color var(--transition);
    }

    .weekly-total {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
      transition: color var(--transition);
    }

    .weekly-total strong {
      color: var(--primary);
      font-weight: 700;
      transition: color var(--transition);
    }

    .chart-bars {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      height: 80px;
      width: 100%;
    }

    .chart-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      height: 100%;
    }

    .chart-bar-wrap {
      flex: 1;
      width: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    .chart-bar {
      width: 100%;
      max-width: 32px;
      background: var(--primary);
      border-radius: 4px 4px 2px 2px;
      min-height: 2px;
      transition: height 400ms ease, background var(--transition);
      position: relative;
    }

    .chart-bar.empty {
      background: var(--ring-track);
      height: 2px !important;
    }

    .chart-bar-value {
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.625rem;
      font-weight: 600;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      transition: color var(--transition);
    }

    .chart-day {
      font-size: 0.625rem;
      color: var(--text-secondary);
      font-weight: 500;
      transition: color var(--transition);
    }

    .chart-day.today {
      color: var(--primary);
      font-weight: 700;
    }

    /* Settings dialog */
    dialog {
      border: none;
      border-radius: var(--radius-lg);
      background: var(--surface);
      color: var(--text);
      padding: 0;
      max-width: 380px;
      width: calc(100% - 32px);
      box-shadow: var(--shadow-lg);
      animation: slideUp 300ms ease;
      margin: auto;
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
    }

    .quick-dialog {
      max-width: 340px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      padding: 0;
    }

    .quick-dialog::backdrop {
      background: rgba(0,0,0,0.5);
    }

    .dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px 0;
    }

    .dialog-header h2 {
      font-size: 1.125rem;
      font-weight: 700;
    }

    .dialog-body {
      padding: 20px 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field label {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .field input[type="number"],
    .field input[type="text"] {
      height: 42px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0 12px;
      font-size: 1rem;
      background: var(--bg);
      color: var(--text);
      transition: border-color 200ms ease;
      width: 100%;
    }

    .field input[type="number"]:focus,
    .field input[type="text"]:focus {
      outline: none;
      border-color: var(--primary);
    }

    .field select {
      height: 42px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0 12px;
      font-size: 1rem;
      background: var(--bg);
      color: var(--text);
      transition: border-color 200ms ease;
      width: 100%;
      cursor: pointer;
    }

    .field select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .field-row {
      display: flex;
      gap: 12px;
    }

    .field-row .field {
      flex: 1;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0;
    }

    .toggle-row span {
      font-size: 0.875rem;
      font-weight: 500;
    }

    .toggle {
      position: relative;
      width: 48px;
      height: 28px;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      inset: 0;
      background: var(--border);
      border-radius: 14px;
      cursor: pointer;
      transition: background 200ms ease;
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      left: 3px;
      bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: transform 200ms ease;
    }

    .toggle input:checked + .toggle-slider {
      background: var(--primary);
    }

    .toggle input:checked + .toggle-slider::before {
      transform: translateX(20px);
    }

    .dialog-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      padding-top: 8px;
    }

    /* Theme selector grid */
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    @media (min-width: 400px) {
      .theme-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .theme-card {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px 12px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 200ms ease;
    }

    .theme-card:hover {
      background: var(--surface);
      border-color: var(--primary);
    }

    .theme-card.active {
      border-color: var(--primary);
      background: var(--surface);
    }

    .theme-card.locked {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .theme-card.locked:hover {
      border-color: var(--border);
    }

    .theme-swatch {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
    }

    .theme-card-name {
      font-size: 0.875rem;
      font-weight: 500;
      text-align: center;
    }

    .theme-card-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      font-size: 9px;
      font-weight: 700;
      padding: 2px 6px;
      background: var(--primary);
      color: var(--surface);
      border-radius: 4px;
      text-transform: uppercase;
    }

    /* Chime selector grid */
    .chime-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chime-card {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 200ms ease;
    }

    .chime-card:hover {
      background: var(--surface);
      border-color: var(--primary);
    }

    .chime-card.active {
      border-color: var(--primary);
      background: var(--surface);
    }

    .chime-card.locked {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .chime-card.locked:hover {
      border-color: var(--border);
      background: var(--bg);
    }

    .chime-card-name {
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--text);
      flex: 1;
    }

    .chime-card-badge {
      background: var(--primary);
      color: white;
      font-size: 0.625rem;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 8px;
      margin-right: 8px;
    }

    .chime-preview-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 50%;
      cursor: pointer;
      transition: all 200ms ease;
    }

    .chime-preview-btn:hover {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .chime-preview-btn svg {
      width: 16px;
      height: 16px;
    }

    /* CSV export dialog */
    #exportDialog input[type="date"] {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      width: 100%;
    }

    #exportDialog input[type="date"]::-webkit-calendar-picker-indicator {
      filter: var(--date-picker-filter, none);
    }

    [data-theme="dark"] #exportDialog input[type="date"]::-webkit-calendar-picker-indicator,
    [data-theme="ocean"] #exportDialog input[type="date"]::-webkit-calendar-picker-indicator,
    [data-theme="forest"] #exportDialog input[type="date"]::-webkit-calendar-picker-indicator,
    [data-theme="sunset"] #exportDialog input[type="date"]::-webkit-calendar-picker-indicator,
    [data-theme="lavender"] #exportDialog input[type="date"]::-webkit-calendar-picker-indicator,
    [data-theme="charcoal"] #exportDialog input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }

    /* Keyboard hint â€” hidden on touch-only devices */
    .kbd-hint {
      font-size: 0.6875rem;
      color: var(--text-secondary);
      text-align: center;
      opacity: 0.7;
      transition: color var(--transition);
      display: none;
    }

    @media (hover: hover) {
      .kbd-hint { display: block; }
    }

    /* Animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Confetti celebration */
    .confetti-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 200;
      overflow: hidden;
    }

    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 10px;
      top: -20px;
      animation: confettiFall 3s ease-out forwards;
    }

    .celebration-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      z-index: 199;
      animation: fadeIn 200ms ease;
    }

    .celebration-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--surface);
      color: var(--text);
      padding: 24px 32px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      z-index: 201;
      text-align: center;
      animation: celebrationPop 400ms cubic-bezier(0.175, 0.885, 0.32, 1.275);
      max-width: 320px;
    }

    .celebration-message .celebration-emoji {
      font-size: 3rem;
      margin-bottom: 12px;
      display: block;
    }

    .celebration-message .celebration-text {
      font-size: 1.125rem;
      font-weight: 600;
      line-height: 1.4;
    }

    @keyframes confettiFall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    @keyframes celebrationPop {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
      .confetti-overlay,
      .confetti-piece {
        display: none !important;
      }
    }

    /* Auth button */
    .auth-btn {
      height: 36px;
      padding: 0 14px;
      border: none;
      background: var(--surface);
      color: var(--text);
      border-radius: var(--radius-full);
      font-size: 0.8125rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), color var(--transition), box-shadow var(--transition);
      touch-action: manipulation;
      white-space: nowrap;
    }

    .auth-btn:hover { box-shadow: var(--shadow-md); }

    .auth-btn svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    /* User avatar */
    .user-avatar-btn {
      width: 36px;
      height: 36px;
      border: 2px solid var(--primary);
      border-radius: 50%;
      padding: 0;
      background: var(--surface);
      cursor: pointer;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: border-color var(--transition), box-shadow var(--transition), background var(--transition);
      touch-action: manipulation;
      position: relative;
    }

    .user-avatar-btn:hover { box-shadow: var(--shadow-md); }

    .user-avatar-btn img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      display: block;
    }

    /* User dropdown */
    .user-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--surface);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      padding: 8px 0;
      min-width: 180px;
      z-index: 100;
      animation: slideUp 200ms ease;
      transition: background var(--transition);
    }

    .user-menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 10px 16px;
      border: none;
      background: none;
      color: var(--text);
      font-size: 0.875rem;
      cursor: pointer;
      transition: background 150ms ease, color var(--transition);
      text-align: left;
    }

    .user-menu-item:hover { background: var(--ring-track); }

    .user-menu-item svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      color: var(--text-secondary);
    }

    .user-menu-name {
      padding: 8px 16px 4px;
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text);
      transition: color var(--transition);
    }

    .user-menu-email {
      padding: 0 16px 8px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      margin-bottom: 4px;
      transition: color var(--transition), border-color var(--transition);
    }

    .user-menu-backdrop {
      position: fixed;
      inset: 0;
      z-index: 99;
    }

    /* Auth prompt card */
    .auth-prompt {
      width: 100%;
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 28px 24px;
      text-align: center;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), box-shadow var(--transition);
      animation: slideUp 400ms ease both;
    }

    .auth-prompt-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      color: var(--primary);
      transition: color var(--transition);
    }

    .auth-prompt-text {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
      line-height: 1.5;
      transition: color var(--transition);
    }

    .auth-prompt .auth-btn {
      margin: 0 auto;
      height: 42px;
      padding: 0 20px;
      font-size: 0.875rem;
      background: var(--primary);
      color: #fff;
      box-shadow: var(--shadow-md);
    }

    .auth-prompt .auth-btn:hover {
      box-shadow: var(--shadow-lg);
    }

    .auth-prompt .auth-btn svg {
      color: #fff;
    }

    /* Leaderboard */
    .leaderboard {
      width: 100%;
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), box-shadow var(--transition);
      animation: slideUp 400ms ease both;
      animation-delay: 300ms;
    }

    .leaderboard-title {
      font-size: 0.8125rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 12px;
      transition: color var(--transition);
    }

    .leaderboard-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .leaderboard-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      transition: background 150ms ease;
    }

    .leaderboard-row:hover {
      background: var(--ring-track);
    }

    .leaderboard-row.current-user {
      background: var(--ring-track);
      outline: 2px solid var(--primary);
      outline-offset: -2px;
    }

    .leaderboard-rank {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-secondary);
      flex-shrink: 0;
      transition: color var(--transition);
    }

    .leaderboard-rank.gold { color: #f1c40f; }
    .leaderboard-rank.silver { color: #95a5a6; }
    .leaderboard-rank.bronze { color: #cd6133; }

    .leaderboard-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      background: var(--ring-track);
    }

    .leaderboard-name {
      flex: 1;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: color var(--transition);
    }

    .leaderboard-minutes {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--primary);
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      transition: color var(--transition);
    }

    .leaderboard-divider {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
      transition: background var(--transition);
    }

    .leaderboard-empty {
      text-align: center;
      padding: 16px 0;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      transition: color var(--transition);
    }

    /* --- Pricing Page --- */
    #pricing-page {
      max-width: 900px;
      width: calc(100% - 32px);
    }

    .pricing-body {
      padding: 24px;
    }

    .pricing-subtitle {
      text-align: center;
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 24px;
      transition: color var(--transition);
    }

    .pricing-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (min-width: 768px) {
      .pricing-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .pricing-card {
      position: relative;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      padding: 20px;
      display: flex;
      flex-direction: column;
      transition: all var(--transition);
    }

    .pricing-card.recommended {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary);
      transform: scale(1.02);
    }

    .pricing-tier-name {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text);
      transition: color var(--transition);
    }

    .pricing-badge {
      display: inline-block;
      font-size: 0.6875rem;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .pricing-badge.recommended-badge {
      background: var(--primary);
      color: white;
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
    }

    .pricing-badge.trial-badge {
      background: var(--ring-track);
      color: var(--text);
      transition: background var(--transition), color var(--transition);
    }

    .pricing-badge.best-value-badge {
      background: #f39c12;
      color: white;
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
    }

    .pricing-price {
      margin-bottom: 20px;
    }

    .pricing-amount {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text);
      transition: color var(--transition);
    }

    .pricing-period {
      font-size: 0.875rem;
      color: var(--text-secondary);
      transition: color var(--transition);
    }

    .pricing-features {
      list-style: none;
      margin-bottom: 20px;
      flex: 1;
    }

    .pricing-features li {
      font-size: 0.8125rem;
      color: var(--text);
      padding: 6px 0;
      line-height: 1.4;
      transition: color var(--transition);
    }

    .pricing-btn {
      width: 100%;
      padding: 10px 16px;
      font-size: 0.875rem;
      font-weight: 600;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 200ms ease;
    }

    .pricing-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pricing-guarantee {
      text-align: center;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      transition: color var(--transition);
    }

    /* --- Upgrade Prompt --- */
    #upgrade-prompt {
      max-width: 420px;
    }

    .upgrade-feature-name {
      font-weight: 600;
      color: var(--primary);
      transition: color var(--transition);
    }

    .upgrade-comparison {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .upgrade-tier {
      background: var(--ring-track);
      border-radius: var(--radius-sm);
      padding: 16px;
      text-align: center;
      transition: background var(--transition);
    }

    .upgrade-tier h4 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
      transition: color var(--transition);
    }

    .upgrade-price {
      font-size: 1.125rem;
      margin-bottom: 4px;
      color: var(--text);
      transition: color var(--transition);
    }

    .upgrade-savings {
      font-size: 0.75rem;
      color: var(--primary);
      font-weight: 600;
      transition: color var(--transition);
    }

    /* --- Audio Controls --- */
    .audio-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      transition: all 300ms ease;
    }

    .audio-indicator.expanded {
      width: 280px;
      background: var(--surface);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
    }

    .audio-toggle-btn {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-full);
      background: var(--surface);
      color: var(--primary);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
      transition: background 300ms ease, color var(--transition), box-shadow 300ms ease;
      position: relative;
    }

    .audio-toggle-btn:hover {
      background: var(--primary);
      color: #fff;
    }

    .audio-indicator.expanded .audio-toggle-btn {
      box-shadow: none;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      width: 100%;
      justify-content: flex-start;
      padding-left: 16px;
    }

    .audio-indicator.playing .audio-toggle-btn::after {
      content: '';
      position: absolute;
      bottom: 4px;
      right: 4px;
      width: 8px;
      height: 8px;
      background: var(--primary);
      border-radius: 50%;
      animation: audio-pulse 1.5s ease-in-out infinite;
    }

    .audio-indicator.expanded.playing .audio-toggle-btn::after {
      display: none;
    }

    @keyframes audio-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }

    .audio-panel {
      display: none;
      flex-direction: column;
      gap: 12px;
      padding: 12px 16px 16px;
    }

    .audio-indicator.expanded .audio-panel {
      display: flex;
    }

    .audio-categories {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .audio-cat-btn {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.6875rem;
      cursor: pointer;
      transition: background 200ms ease, color 200ms ease, border-color 200ms ease;
      white-space: nowrap;
    }

    .audio-cat-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .audio-cat-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .audio-cat-btn.audio-cat-premium::after {
      content: 'PRO';
      font-size: 8px;
      font-weight: 700;
      background: var(--primary);
      color: var(--surface);
      padding: 1px 4px;
      border-radius: 3px;
      margin-left: 4px;
      vertical-align: super;
    }

    .audio-station {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .audio-station-name {
      flex: 1;
      text-align: center;
      font-size: 0.8125rem;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      transition: color var(--transition);
    }

    .audio-nav-btn {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      background: transparent;
      color: var(--text-secondary);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: color 200ms ease, background 200ms ease;
    }

    .audio-nav-btn:hover {
      color: var(--text);
      background: var(--border);
    }

    .audio-play-btn {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-full);
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      align-self: center;
      transition: background 200ms ease;
    }

    .audio-play-btn:hover {
      background: var(--primary-hover);
    }

    .audio-volume {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .audio-volume input[type="range"] {
      flex: 1;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--border);
      border-radius: 2px;
      outline: none;
      transition: background var(--transition);
    }

    .audio-volume input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: none;
      transition: background var(--transition);
    }

    .audio-volume input[type="range"]::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: none;
    }

    .audio-volume input[type="range"]::-moz-range-track {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
    }

    @media (min-width: 480px) {
      .app { padding: 24px 24px 48px; gap: 28px; }
      .stat-card { padding: 16px 12px; }
      .stat-value { font-size: 1.75rem; }
      .chart-bars { height: 100px; }
    }

    @media (min-width: 768px) {
      .app { max-width: 560px; padding: 32px 24px 56px; gap: 32px; }
      .timer-container { width: 360px; height: 360px; }
    }

    @media (min-width: 1024px) {
      .app { max-width: 640px; }
    }

    @media (max-width: 479px) {
      .audio-indicator {
        bottom: 16px;
        right: 16px;
      }
      .audio-indicator.expanded {
        width: calc(100vw - 32px);
        max-width: 300px;
      }
    }

    /* Analytics Dialog */
    #analyticsDialog {
      max-width: 600px;
      width: 95vw;
      max-height: 85vh;
    }

    .analytics-tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--border);
      padding: 0 20px;
      position: sticky;
      top: 0;
      background: var(--surface);
      z-index: 1;
    }

    .analytics-tab {
      background: none;
      border: none;
      color: var(--text-secondary);
      padding: 10px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: color 0.2s, border-color 0.2s;
    }

    .analytics-tab:hover {
      color: var(--text);
    }

    .analytics-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      font-weight: 600;
    }

    .analytics-body {
      padding: 20px;
      overflow-y: auto;
    }

    .analytics-panel {
      min-height: 200px;
    }

    .analytics-loading {
      text-align: center;
      color: var(--text-secondary);
      padding: 40px 0;
    }

    .productivity-gauge {
      text-align: center;
      margin-bottom: 20px;
    }

    .gauge-svg {
      width: 180px;
      height: 180px;
    }

    .score-up {
      color: var(--chart-success);
    }

    .score-down {
      color: #e74c3c;
    }

    .score-same {
      color: var(--text-secondary);
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .summary-card {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .summary-value {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .summary-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .summary-comparison {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .focus-recommendation {
      background: var(--bg-secondary);
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .chart-container {
      position: relative;
      height: 250px;
      margin-bottom: 20px;
    }

    .analytics-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .analytics-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .project-chart-container {
      margin-bottom: 32px;
    }

    @media (max-width: 600px) {
      .summary-cards {
        grid-template-columns: 1fr;
      }

      .chart-container {
        height: 200px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="logo" aria-label="Pomodoro Timer">
        <svg viewBox="0 0 512 512" aria-hidden="true">
          <circle cx="256" cy="280" r="200" fill="currentColor"/>
          <circle cx="256" cy="280" r="170" fill="currentColor" opacity="0.7"/>
          <circle cx="256" cy="280" r="160" fill="currentColor"/>
          <rect x="250" y="130" width="12" height="100" rx="6" fill="#fff"/>
          <rect x="250" y="230" width="12" height="60" rx="6" fill="#fff" transform="rotate(30 256 280)"/>
          <ellipse cx="256" cy="100" rx="12" ry="20" fill="#27ae60"/>
          <ellipse cx="240" cy="95" rx="18" ry="10" fill="#27ae60" transform="rotate(-30 240 95)"/>
          <ellipse cx="272" cy="95" rx="18" ry="10" fill="#27ae60" transform="rotate(30 272 95)"/>
        </svg>
        Pomodoro
      </div>
      <div class="header-actions">
        <button class="auth-btn" id="signInBtn" aria-label="Sign in with Google" title="Sign in">
          <svg viewBox="0 0 24 24" fill="none"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18A10.96 10.96 0 0 0 1 12c0 1.77.42 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
          Sign In
        </button>
        <button class="icon-btn" id="statsBtn" aria-label="Stats" data-tooltip="Stats">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
          </svg>
        </button>
        <button class="icon-btn" id="analyticsBtn" aria-label="Analytics" data-tooltip="Analytics">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M7 12h10M7 16h10M7 8h10"/>
          </svg>
        </button>
        <button class="icon-btn hidden" id="leaderboardBtn" aria-label="Leaderboard" data-tooltip="Leaderboard">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 22V8a2 2 0 0 0-2-2H6v0a2 2 0 0 0-2 2v4a4 4 0 0 0 4 4h0"/><path d="M14 22V8a2 2 0 0 1 2-2h2v0a2 2 0 0 1 2 2v4a4 4 0 0 1-4 4h0"/>
          </svg>
        </button>
        <button class="btn btn-primary" id="upgrade-btn" aria-label="Upgrade to Premium" style="font-size: 0.8125rem; padding: 6px 12px;">Upgrade</button>
        <span id="premium-badge" style="display:none; font-size: 0.8125rem; color: var(--primary); font-weight: 600;">â˜… Premium</span>
        <button class="icon-btn" id="settingsBtn" aria-label="Open settings" data-tooltip="Settings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
        </button>
        <div class="hidden" id="userAvatarWrap" style="position:relative;">
          <button class="user-avatar-btn" id="userAvatarBtn" aria-label="Account menu" title="Account">
            <img id="userAvatarImg" src="" alt="" referrerpolicy="no-referrer">
          </button>
        </div>
      </div>
    </header>

    <div id="pageTimer" class="page-section">
    <div class="mode-tabs" role="tablist" aria-label="Timer mode">
      <button class="mode-tab active" role="tab" data-mode="focus" aria-selected="true">Focus</button>
      <button class="mode-tab" role="tab" data-mode="break" aria-selected="false">Short Break</button>
      <button class="mode-tab" role="tab" data-mode="longbreak" aria-selected="false">Long Break</button>
    </div>
    <div class="mode-label" id="modeLabel" aria-live="polite">Focus Time</div>

    <div class="timer-container" role="timer" aria-label="Timer">
      <svg class="timer-svg" viewBox="0 0 200 200">
        <circle class="ring-track" cx="100" cy="100" r="90"/>
        <circle class="ring-progress" id="progressRing" cx="100" cy="100" r="90"
                stroke-dasharray="565.49" stroke-dashoffset="0"/>
      </svg>
      <div class="timer-display">
        <span class="time-text" id="timeDisplay">25:00</span>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" id="startBtn">Start</button>
      <button class="btn btn-secondary hidden" id="pauseBtn">Pause</button>
      <button class="btn btn-ghost" id="resetBtn">Reset</button>
    </div>

    <div class="session-dots" id="sessionDots" aria-label="Session progress">
      <div class="dot" data-dot="0"></div>
      <div class="dot" data-dot="1"></div>
      <div class="dot" data-dot="2"></div>
      <div class="dot" data-dot="3"></div>
    </div>

    <div class="tasks-section expanded" id="tasksSection">
      <div class="tasks-header" id="tasksHeader">
        <span>Tasks (<span id="taskCount">0</span>)</span>
        <svg class="tasks-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </div>
      <div class="project-bar" id="projectBar" style="display:none;">
        <div class="project-dropdown" id="projectDropdown">
          <button class="project-dropdown-btn" id="projectDropdownBtn" aria-label="Filter by project" type="button">
            <span id="projectDropdownLabel">All Tasks</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="project-dropdown-menu" id="projectDropdownMenu"></div>
        </div>
        <button class="btn-icon" id="manageProjectsBtn" aria-label="Manage projects" title="Manage projects">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
        </button>
      </div>
      <div class="tasks-body">
        <div class="task-input-row">
          <input type="text" id="taskInput" placeholder="What are you working on?" maxlength="100">
          <button class="btn btn-primary" id="addTaskBtn">Add</button>
        </div>
        <ul class="task-list" id="taskList"></ul>
      </div>
    </div>

    <div class="auth-prompt hidden" id="authPrompt">
      <svg class="auth-prompt-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
      <div class="auth-prompt-text">Sign in with Google to track your stats and compete on the leaderboard</div>
      <button class="auth-btn" id="authPromptBtn" aria-label="Sign in with Google">
        <svg viewBox="0 0 24 24" fill="none"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z" fill="#fff"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#fff"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18A10.96 10.96 0 0 0 1 12c0 1.77.42 3.45 1.18 4.93l3.66-2.84z" fill="#fff"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#fff"/></svg>
        Sign in with Google
      </button>
    </div>

    <div class="kbd-hint" aria-hidden="true">Space: start/pause &middot; R: reset &middot; Esc: close settings</div>
    </div>

    </div>
  </div>

  <button class="theme-toggle-fixed" id="themeToggle" aria-label="Choose theme" data-tooltip="Theme">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/>
    </svg>
  </button>

  <div id="celebrationContainer"></div>

  <dialog id="settingsDialog" aria-labelledby="settingsTitle">
    <div class="dialog-header">
      <h2 id="settingsTitle">Settings</h2>
      <button class="icon-btn" id="closeSettings" aria-label="Close settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <form class="dialog-body" id="settingsForm">
      <div class="field">
        <label for="focusDuration">Focus Duration (min)</label>
        <input type="number" id="focusDuration" min="1" max="120" value="25">
      </div>
      <div class="field">
        <label for="breakDuration">Break Duration (min)</label>
        <input type="number" id="breakDuration" min="1" max="30" value="5">
      </div>
      <div class="field">
        <label for="longBreakDuration">Long Break Duration (min)</label>
        <input type="number" id="longBreakDuration" min="1" max="60" value="15">
      </div>
      <div class="field">
        <label for="longBreakInterval">Long Break Interval</label>
        <input type="number" id="longBreakInterval" min="2" max="10" value="4">
      </div>
      <div class="field-row">
        <div class="field">
          <label for="dailyGoalInput">Daily Goal</label>
          <input type="number" id="dailyGoalInput" min="1" max="480" value="100">
        </div>
        <div class="field">
          <label for="dailyGoalUnit">Unit</label>
          <select id="dailyGoalUnit">
            <option value="minutes">Minutes</option>
            <option value="hours">Hours</option>
            <option value="pomodoros">Pomodoros</option>
          </select>
        </div>
      </div>
      <div class="toggle-row">
        <span>Auto-start next session</span>
        <label class="toggle">
          <input type="checkbox" id="autoStart">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="toggle-row">
        <span>Sound</span>
        <label class="toggle">
          <input type="checkbox" id="soundEnabled" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="toggle-row" id="chimeSettingRow">
        <span>Timer Sound</span>
        <button type="button" class="btn btn-ghost btn-sm" id="openChimeSelector">Classic Bell &gt;</button>
      </div>
      <div class="dialog-actions">
        <button type="button" class="btn btn-ghost" id="cancelSettings">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </dialog>

  <dialog id="statsDialog" aria-labelledby="statsTitle">
    <div class="dialog-header">
      <h2 id="statsTitle">Stats</h2>
      <button class="icon-btn" id="closeStats" aria-label="Close stats">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="dialog-body">
      <div class="today-progress" id="todayProgress">
        <div class="today-header">
          <span class="today-title">Today's Progress</span>
          <span class="today-summary"><strong id="todayMinutes">0</strong> <span id="todayMinutesUnit">min</span> focused</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="today-detail">
          <span id="todayDetailLeft"><span id="todaySessions">0</span> sessions</span>
          <span>Goal: <span id="dailyGoal">100</span> <span id="dailyGoalUnitLabel">min</span></span>
        </div>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="statTodayMin">0</div>
          <div class="stat-label" id="statTodayMinLabel">Min Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statTodaySessions">0</div>
          <div class="stat-label">Sessions</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statWeekTotal">0</div>
          <div class="stat-label" id="statWeekTotalLabel">Min This Week</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statBestStreak">0</div>
          <div class="stat-label">Best Streak</div>
        </div>
      </div>

      <div class="weekly-chart" id="weeklyChart">
        <div class="weekly-header">
          <span class="weekly-title">This Week</span>
          <span class="weekly-total"><strong id="weekTotalMin">0</strong> <span id="weekTotalUnit">min</span> total</span>
        </div>
        <div class="chart-bars" id="chartBars"></div>
      </div>
      <button type="button" class="btn btn-ghost" id="openExport" style="margin-top: 12px; width: 100%;">
        Export CSV
      </button>
    </div>
  </dialog>

  <dialog id="leaderboardDialog" aria-labelledby="leaderboardTitle">
    <div class="dialog-header">
      <h2 id="leaderboardTitle">Leaderboard</h2>
      <button class="icon-btn" id="closeLeaderboard" aria-label="Close leaderboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="dialog-body">
      <div class="leaderboard" id="leaderboard">
        <ul class="leaderboard-list" id="leaderboardList"></ul>
      </div>
    </div>
  </dialog>

  <!-- Pricing Page -->
  <dialog id="pricing-page" aria-labelledby="pricingTitle">
    <div class="dialog-header">
      <h2 id="pricingTitle">Choose Your Plan</h2>
      <button class="icon-btn" id="closePricing" aria-label="Close pricing">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="dialog-body pricing-body">
      <p class="pricing-subtitle">Start with a 7-day free trial. Cancel anytime.</p>
      <div class="pricing-grid">
        <!-- Free Tier -->
        <div class="pricing-card" id="free-tier-card">
          <h3 class="pricing-tier-name">Free</h3>
          <div class="pricing-price">
            <span class="pricing-amount">$0</span>
          </div>
          <ul class="pricing-features">
            <li>âœ“ Basic Timer</li>
            <li>âœ“ Focus/Break/Long Break</li>
            <li>âœ“ Task List</li>
            <li>âœ“ Daily Stats</li>
            <li>âœ“ Light/Dark Theme</li>
          </ul>
          <button class="pricing-btn btn-ghost" disabled>Current Plan</button>
        </div>

        <!-- Monthly Tier -->
        <div class="pricing-card">
          <h3 class="pricing-tier-name">Premium Monthly</h3>
          <div class="pricing-badge trial-badge">7-day free trial</div>
          <div class="pricing-price">
            <span class="pricing-amount">$2</span>
            <span class="pricing-period">/month</span>
          </div>
          <ul class="pricing-features">
            <li>âœ“ Everything in Free</li>
            <li>âœ“ Projects</li>
            <li>âœ“ Smart Insights</li>
            <li>âœ“ Focus Forecast</li>
            <li>âœ“ Project Analytics</li>
            <li>âœ“ Yearly Report</li>
            <li>âœ“ CSV Export</li>
            <li>âœ“ Custom Themes & Sounds</li>
            <li>âœ“ Todoist Import</li>
            <li>âœ“ Webhook Triggers</li>
            <li>âœ“ <strong>No Ads Ever</strong></li>
          </ul>
          <button class="pricing-btn btn-primary" id="checkout-monthly">Start Free Trial</button>
        </div>

        <!-- Yearly Tier (Recommended) -->
        <div class="pricing-card recommended">
          <div class="pricing-badge recommended-badge">Recommended</div>
          <h3 class="pricing-tier-name">Premium Yearly</h3>
          <div class="pricing-badge trial-badge">Save 37% Â· 7-day free trial</div>
          <div class="pricing-price">
            <span class="pricing-amount">$15</span>
            <span class="pricing-period">/year</span>
          </div>
          <ul class="pricing-features">
            <li>âœ“ Everything in Free</li>
            <li>âœ“ Projects</li>
            <li>âœ“ Smart Insights</li>
            <li>âœ“ Focus Forecast</li>
            <li>âœ“ Project Analytics</li>
            <li>âœ“ Yearly Report</li>
            <li>âœ“ CSV Export</li>
            <li>âœ“ Custom Themes & Sounds</li>
            <li>âœ“ Todoist Import</li>
            <li>âœ“ Webhook Triggers</li>
            <li>âœ“ <strong>No Ads Ever</strong></li>
          </ul>
          <button class="pricing-btn btn-primary" id="checkout-yearly">Start Free Trial</button>
        </div>

        <!-- Lifetime Tier -->
        <div class="pricing-card">
          <div class="pricing-badge best-value-badge">Best Value</div>
          <h3 class="pricing-tier-name">Lifetime</h3>
          <div class="pricing-price">
            <span class="pricing-amount">$47</span>
            <span class="pricing-period">one-time</span>
          </div>
          <ul class="pricing-features">
            <li>âœ“ Everything in Free</li>
            <li>âœ“ Projects</li>
            <li>âœ“ Smart Insights</li>
            <li>âœ“ Focus Forecast</li>
            <li>âœ“ Project Analytics</li>
            <li>âœ“ Yearly Report</li>
            <li>âœ“ CSV Export</li>
            <li>âœ“ Custom Themes & Sounds</li>
            <li>âœ“ Todoist Import</li>
            <li>âœ“ Webhook Triggers</li>
            <li>âœ“ <strong>No Ads Ever</strong></li>
            <li>âœ“ <strong>Pay once, own forever</strong></li>
          </ul>
          <button class="pricing-btn btn-primary" id="checkout-lifetime">Get Lifetime Access</button>
        </div>
      </div>
      <p class="pricing-guarantee">ðŸ”’ No Ads Ever â€¢ Cancel anytime â€¢ Secure payment via Stripe</p>
    </div>
  </dialog>

  <!-- Upgrade Prompt Modal -->
  <dialog id="upgrade-prompt" aria-labelledby="upgradePromptTitle">
    <div class="dialog-header">
      <h2 id="upgradePromptTitle">Unlock <span class="upgrade-feature-name">this feature</span></h2>
      <button class="icon-btn" id="closeUpgradePrompt" aria-label="Close upgrade prompt">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="dialog-body">
      <p style="margin-bottom: 20px; color: var(--text-secondary);">This is a premium feature. Upgrade to access <span class="upgrade-feature-name">this feature</span> and 10 more premium features.</p>
      <div class="upgrade-comparison">
        <div class="upgrade-tier">
          <h4>Monthly</h4>
          <div class="upgrade-price"><strong>$2</strong>/mo</div>
          <div class="upgrade-savings">Try it out</div>
        </div>
        <div class="upgrade-tier">
          <h4>Yearly</h4>
          <div class="upgrade-price"><strong>$15</strong>/yr</div>
          <div class="upgrade-savings">Save 37%</div>
        </div>
        <div class="upgrade-tier">
          <h4>Lifetime</h4>
          <div class="upgrade-price"><strong>$47</strong> once</div>
          <div class="upgrade-savings">Best Value</div>
        </div>
      </div>
      <div class="dialog-actions">
        <button class="btn btn-ghost" id="upgrade-prompt-dismiss">Maybe Later</button>
        <button class="btn btn-primary" id="upgrade-prompt-view-plans">View Plans</button>
      </div>
    </div>
  </dialog>

  <!-- Project Dialog -->
  <dialog id="projectDialog" aria-labelledby="projectDialogTitle">
    <div class="dialog-header">
      <h2 id="projectDialogTitle">Create Project</h2>
      <button class="icon-btn dialog-close" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <form id="projectForm">
      <div class="dialog-body">
        <div class="field">
          <label for="projectNameInput">Project Name</label>
          <input type="text" id="projectNameInput" required minlength="1" maxlength="50" autocomplete="off" placeholder="e.g., Work, Side Project">
        </div>
        <div class="dialog-actions">
          <button type="button" class="btn btn-ghost" id="projectCancelBtn">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Manage Projects Dialog -->
  <dialog id="manageProjectsDialog" aria-labelledby="manageProjectsTitle">
    <div class="dialog-header">
      <h2 id="manageProjectsTitle">Manage Projects</h2>
      <button class="icon-btn dialog-close" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="dialog-body">
      <ul id="projectListManage" class="task-list" style="margin:0;max-height:300px;overflow-y:auto;"></ul>
      <div class="dialog-actions">
        <button class="btn btn-ghost" id="closeManageProjectsBtn">Done</button>
        <button class="btn btn-primary" id="newProjectBtn">New Project</button>
      </div>
    </div>
  </dialog>

  <!-- Theme Selector Dialog -->
  <dialog id="themeDialog" aria-labelledby="themeTitle">
    <div class="dialog-header">
      <h2 id="themeTitle">Choose Theme</h2>
      <button class="icon-btn" id="closeTheme" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="dialog-body">
      <div class="theme-grid" id="themeGrid"></div>
    </div>
  </dialog>

  <!-- Chime Selector Dialog -->
  <dialog id="chimeDialog" aria-labelledby="chimeTitle">
    <div class="dialog-header">
      <h2 id="chimeTitle">Timer Sound</h2>
      <button class="icon-btn" id="closeChime" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="dialog-body chime-grid" id="chimeGrid"></div>
  </dialog>

  <!-- CSV Export Dialog -->
  <dialog id="exportDialog" aria-labelledby="exportTitle">
    <div class="dialog-header">
      <h2 id="exportTitle">Export Sessions</h2>
      <button class="icon-btn" id="closeExport" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="dialog-body">
      <p class="export-description" style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 16px;">Download your focus session history as a CSV file.</p>
      <div class="field">
        <label for="exportStartDate">Start Date</label>
        <input type="date" id="exportStartDate">
      </div>
      <div class="field">
        <label for="exportEndDate">End Date</label>
        <input type="date" id="exportEndDate">
      </div>
      <div id="exportStatus" style="font-size: 0.875rem; color: var(--text-secondary); min-height: 20px; margin-top: 12px;"></div>
      <div class="dialog-actions">
        <button type="button" class="btn btn-ghost" id="cancelExport">Cancel</button>
        <button type="button" class="btn btn-primary" id="exportCsvBtn">Export CSV</button>
      </div>
    </div>
  </dialog>

  <!-- Analytics Dialog -->
  <dialog id="analyticsDialog" aria-labelledby="analyticsTitle">
    <div class="dialog-header">
      <h2 id="analyticsTitle">Analytics</h2>
      <button class="icon-btn" id="closeAnalytics" aria-label="Close analytics">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="analytics-tabs">
      <button class="analytics-tab active" data-tab-button="overview">Overview</button>
      <button class="analytics-tab" data-tab-button="projects">Projects</button>
      <button class="analytics-tab" data-tab-button="forecast">Forecast</button>
      <button class="analytics-tab" data-tab-button="yearly">Yearly</button>
    </div>
    <div class="dialog-body analytics-body">
      <div class="analytics-panel" data-tab-panel="overview" style="display:block">
        <div class="analytics-loading">Loading analytics...</div>
      </div>
      <div class="analytics-panel" data-tab-panel="projects" style="display:none">
        <div class="analytics-loading">Loading project data...</div>
      </div>
      <div class="analytics-panel" data-tab-panel="forecast" style="display:none">
        <div class="analytics-loading">Loading forecast...</div>
      </div>
      <div class="analytics-panel" data-tab-panel="yearly" style="display:none">
        <div class="analytics-loading">Loading yearly report...</div>
      </div>
    </div>
  </dialog>

  <!-- Audio Controls -->
  <div id="audioIndicator" class="audio-indicator" aria-label="Audio controls">
    <button id="audioTogglePanel" class="audio-toggle-btn" aria-label="Toggle audio panel">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
      </svg>
    </button>
    <div id="audioPanel" class="audio-panel">
      <div class="audio-categories" id="audioCategories"></div>
      <div class="audio-station">
        <button id="audioPrev" class="audio-nav-btn" aria-label="Previous station">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
        </button>
        <span id="audioStationName" class="audio-station-name">Station Name</span>
        <button id="audioNext" class="audio-nav-btn" aria-label="Next station">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </button>
      </div>
      <button id="audioPlayPause" class="audio-play-btn" aria-label="Play audio">
        <svg id="audioPlayIcon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <polygon points="5 3 19 12 5 21 5 3"/>
        </svg>
        <svg id="audioPauseIcon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display:none">
          <rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>
        </svg>
      </button>
      <div class="audio-volume">
        <button id="audioMuteBtn" class="audio-nav-btn" aria-label="Mute">
          <svg id="audioSpeakerIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
          </svg>
          <svg id="audioMutedIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>
          </svg>
        </button>
        <input type="range" id="audioVolumeSlider" min="0" max="100" value="70" aria-label="Volume">
      </div>
    </div>
  </div>

  <!-- Background Audio -->
  <audio id="bgAudio" preload="none" crossorigin="anonymous"></audio>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-functions-compat.js"></script>
  <script>
    // Firebase config â€” replace these placeholder values with your project's config
    const firebaseConfig = {
      apiKey: "AIzaSyBJIAgGQQHhKFO4xXFVg25pb1nb8nY3e9M",
      authDomain: "pomodoro-timer-82980.firebaseapp.com",
      projectId: "pomodoro-timer-82980",
      storageBucket: "pomodoro-timer-82980.firebasestorage.app",
      messagingSenderId: "785507725684",
      appId: "1:785507725684:web:90549bfb8776be5920bc21",
      measurementId: "G-G14JMRPL39"
    };
    firebase.initializeApp(firebaseConfig);
    const fbAuth = firebase.auth();
    const fbDb = firebase.firestore();
    const fbFunctions = firebase.functions();
    fbDb.enablePersistence({ synchronizeTabs: true }).catch(() => {});
  </script>
  <script>
    (() => {
      'use strict';

      // --- Constants ---
      const CIRCUMFERENCE = 2 * Math.PI * 90; // ~565.49
      const STORAGE_KEYS = {
        settings: 'pomodoro-settings',
        stats: 'pomodoro-stats',
        theme: 'pomodoro-theme',
        tasks: 'pomodoro-tasks',
        projects: 'pomodoro-projects',
      };
      const CONFETTI_COLORS = ['#e74c3c', '#f39c12', '#2ecc71', '#3498db', '#9b59b6', '#1abc9c', '#e91e63'];
      const STRIPE_PRICES = {
        monthly: 'price_REPLACE_WITH_MONTHLY_PRICE_ID',
        yearly: 'price_REPLACE_WITH_YEARLY_PRICE_ID',
        lifetime: 'price_REPLACE_WITH_LIFETIME_PRICE_ID'
      };
      const PREMIUM_STATUSES = ['active', 'trialing', 'past_due', 'lifetime'];

      // --- DOM refs ---
      const $ = (s) => document.querySelector(s);
      const root = document.documentElement;
      const modeLabel = $('#modeLabel');
      const timeDisplay = $('#timeDisplay');
      const progressRing = $('#progressRing');
      const startBtn = $('#startBtn');
      const pauseBtn = $('#pauseBtn');
      const resetBtn = $('#resetBtn');
      const sessionDotsEl = $('#sessionDots');
      const todayMinutesEl = $('#todayMinutes');
      const todayMinutesUnit = $('#todayMinutesUnit');
      const todaySessionsEl = $('#todaySessions');
      const todayDetailLeft = $('#todayDetailLeft');
      const progressFill = $('#progressFill');
      const dailyGoalEl = $('#dailyGoal');
      const dailyGoalUnitLabel = $('#dailyGoalUnitLabel');
      const statTodayMin = $('#statTodayMin');
      const statTodayMinLabel = $('#statTodayMinLabel');
      const statTodaySessions = $('#statTodaySessions');
      const statWeekTotal = $('#statWeekTotal');
      const statWeekTotalLabel = $('#statWeekTotalLabel');
      const statBestStreak = $('#statBestStreak');
      const weekTotalMin = $('#weekTotalMin');
      const weekTotalUnit = $('#weekTotalUnit');
      const chartBars = $('#chartBars');
      const modeTabs = document.querySelectorAll('.mode-tab');
      const themeToggle = $('#themeToggle');
      const themeDialog = $('#themeDialog');
      const themeGrid = $('#themeGrid');
      const closeThemeBtn = $('#closeTheme');
      const chimeDialog = $('#chimeDialog');
      const chimeGrid = $('#chimeGrid');
      const closeChimeBtn = $('#closeChime');
      const openChimeSelectorBtn = $('#openChimeSelector');
      const exportDialog = $('#exportDialog');
      const openExportBtn = $('#openExport');
      const closeExportBtn = $('#closeExport');
      const cancelExportBtn = $('#cancelExport');
      const exportCsvBtn = $('#exportCsvBtn');
      const analyticsDialog = $('#analyticsDialog');
      const closeAnalyticsBtn = $('#closeAnalytics');
      const analyticsBtn = $('#analyticsBtn');
      const settingsBtn = $('#settingsBtn');
      const settingsDialog = $('#settingsDialog');
      const settingsForm = $('#settingsForm');
      const closeSettingsBtn = $('#closeSettings');
      const cancelSettingsBtn = $('#cancelSettings');
      const themeColorMeta = $('meta[name="theme-color"]');
      const signInBtn = $('#signInBtn');
      const userAvatarWrap = $('#userAvatarWrap');
      const userAvatarBtn = $('#userAvatarBtn');
      const userAvatarImg = $('#userAvatarImg');
      const authPrompt = $('#authPrompt');
      const authPromptBtn = $('#authPromptBtn');
      const todayProgressEl = $('#todayProgress');
      const statsEl = $('.stats');
      const weeklyChartEl = $('#weeklyChart');
      const leaderboardEl = $('#leaderboard');
      const leaderboardList = $('#leaderboardList');
      const statsBtn = $('#statsBtn');
      const leaderboardBtn = $('#leaderboardBtn');
      const statsDialog = $('#statsDialog');
      const closeStatsBtn = $('#closeStats');
      const leaderboardDialog = $('#leaderboardDialog');
      const closeLeaderboardBtn = $('#closeLeaderboard');
      const pricingPage = $('#pricing-page');
      const closePricingBtn = $('#closePricing');
      const upgradePrompt = $('#upgrade-prompt');
      const closeUpgradePromptBtn = $('#closeUpgradePrompt');
      const celebrationContainer = $('#celebrationContainer');
      const tasksSection = $('#tasksSection');
      const tasksHeader = $('#tasksHeader');
      const taskInput = $('#taskInput');
      const addTaskBtn = $('#addTaskBtn');
      const taskList = $('#taskList');
      const taskCount = $('#taskCount');

      // Project UI refs
      const projectDialog = $('#projectDialog');
      const projectForm = $('#projectForm');
      const projectNameInput = $('#projectNameInput');
      const projectDropdownBtn = $('#projectDropdownBtn');
      const projectDropdownMenu = $('#projectDropdownMenu');
      const manageProjectsDialog = $('#manageProjectsDialog');
      const projectListManage = $('#projectListManage');

      // Audio UI refs
      const audioIndicatorEl = $('#audioIndicator');
      const audioTogglePanelBtn = $('#audioTogglePanel');
      const audioPanelEl = $('#audioPanel');
      const audioCategoriesEl = $('#audioCategories');
      const audioStationNameEl = $('#audioStationName');
      const audioPrevBtn = $('#audioPrev');
      const audioNextBtn = $('#audioNext');
      const audioPlayPauseBtn = $('#audioPlayPause');
      const audioPlayIconEl = $('#audioPlayIcon');
      const audioPauseIconEl = $('#audioPauseIcon');
      const audioMuteBtnEl = $('#audioMuteBtn');
      const audioSpeakerIconEl = $('#audioSpeakerIcon');
      const audioMutedIconEl = $('#audioMutedIcon');
      const audioVolumeSliderEl = $('#audioVolumeSlider');

      // --- Default settings ---
      const DEFAULTS = {
        focusDuration: 25,
        breakDuration: 5,
        longBreakDuration: 15,
        longBreakInterval: 4,
        autoStart: false,
        soundEnabled: true,
        dailyGoal: 100,
        dailyGoalUnit: 'minutes', // 'minutes' | 'hours' | 'pomodoros'
        audioVolume: 70,
        audioMuted: false,
        audioCategory: 'ambient',
        audioStationIndex: 0,
      };

      // --- Audio station data ---
      const AUDIO_STATIONS = {
        ambient: [
          { name: 'Drone Zone', url: 'https://ice5.somafm.com/dronezone-256-mp3', genre: 'Ambient Drone' },
          { name: 'Deep Space One', url: 'https://ice1.somafm.com/deepspaceone-128-mp3', genre: 'Deep Ambient' },
          { name: 'Space Station Soma', url: 'https://ice1.somafm.com/spacestation-128-mp3', genre: 'Space Music' },
          { name: 'Mission Control', url: 'https://ice1.somafm.com/missioncontrol-128-mp3', genre: 'Downtempo Space' },
        ],
        binaural: [
          { name: 'Drone Zone (Focus)', url: 'https://ice5.somafm.com/dronezone-256-mp3', genre: 'Focus Enhancement' },
          { name: 'Deep Space One (Concentration)', url: 'https://ice1.somafm.com/deepspaceone-128-mp3', genre: 'Deep Focus' },
          { name: 'Dark Zone', url: 'https://ice1.somafm.com/darkzone-256-mp3', genre: 'Dark Ambient' },
        ],
        lofi: [
          { name: 'Fluid', url: 'https://ice1.somafm.com/fluid-128-mp3', genre: 'Lo-fi Hip Hop' },
          { name: 'Beat Blender', url: 'https://ice1.somafm.com/beatblender-128-mp3', genre: 'Chill Beats' },
          { name: 'Groove Salad Classic', url: 'https://ice1.somafm.com/gsclassic-128-mp3', genre: 'Downtempo' },
        ],
        classical: [
          { name: 'Synphaera', url: 'https://ice1.somafm.com/synphaera-128-mp3', genre: 'Ambient Symphonic' },
          { name: 'n5MD Radio', url: 'https://ice1.somafm.com/n5md-128-mp3', genre: 'Ambient/Post-Rock' },
        ],
        nature: [
          { name: 'Drone Zone', url: 'https://ice5.somafm.com/dronezone-256-mp3', genre: 'Meditative Drone' },
          { name: 'Deep Space One', url: 'https://ice1.somafm.com/deepspaceone-128-mp3', genre: 'Deep Ambient' },
        ],
      };

      const AUDIO_CATEGORY_LABELS = {
        ambient: 'Ambient',
        binaural: 'Focus Beats',
        lofi: 'Lo-fi',
        classical: 'Orchestral',
        nature: 'Soundscapes',
      };

      const PREMIUM_AUDIO_CATEGORIES = ['lofi', 'classical', 'nature'];

      const THEMES = [
        { id: 'light', name: 'Light', color: '#e74c3c', premium: false },
        { id: 'dark', name: 'Dark', color: '#e74c3c', premium: false },
        { id: 'ocean', name: 'Ocean', color: '#2980b9', premium: true },
        { id: 'forest', name: 'Forest', color: '#27ae60', premium: true },
        { id: 'sunset', name: 'Sunset', color: '#ff6b6b', premium: true },
        { id: 'lavender', name: 'Lavender', color: '#9b59b6', premium: true },
        { id: 'charcoal', name: 'Charcoal', color: '#ff7675', premium: true },
      ];

      // --- Chime sounds ---
      const CHIME_SOUNDS = {
        bell: {
          name: 'Classic Bell',
          premium: false,
          notes: [523.25, 659.25, 783.99], // C5, E5, G5 ascending
          type: 'sine',
          spacing: 0.15,
          duration: 0.4,
          gain: 0.3
        },
        soft: {
          name: 'Soft Chime',
          premium: false,
          notes: [440, 554.37, 659.25], // A4, C#5, E5 (A major chord)
          type: 'sine',
          spacing: 0.2,
          duration: 0.6,
          gain: 0.2
        },
        digital: {
          name: 'Digital Pulse',
          premium: false,
          notes: [880, 880], // Two quick beeps
          type: 'square',
          spacing: 0.12,
          duration: 0.15,
          gain: 0.15
        },
        gong: {
          name: 'Meditation Gong',
          premium: true,
          notes: [130.81, 196, 261.63], // Low resonant tone
          type: 'sine',
          spacing: 0.3,
          duration: 1.0,
          gain: 0.25
        },
        singing: {
          name: 'Singing Bowl',
          premium: true,
          notes: [261.63, 392, 523.25, 783.99], // Overtone-rich pattern
          type: 'sine',
          spacing: 0.25,
          duration: 0.8,
          gain: 0.2
        },
        crystal: {
          name: 'Crystal Chime',
          premium: true,
          notes: [1046.5, 987.77, 880, 783.99], // High tinkling notes descending
          type: 'triangle',
          spacing: 0.1,
          duration: 0.5,
          gain: 0.2
        },
      };

      // --- Audio ducking constants ---
      const DUCK_RATIO = 0.2;          // Duck to 20% of current volume
      const DUCK_FADE_DOWN_MS = 100;   // Quick fade down when chime starts
      const DUCK_FADE_UP_MS = 300;     // Slower fade up after chime ends
      const DUCK_DELAY_MS = 800;       // Restore after chime completes (chime is 0.7s + buffer)

      // --- State ---
      const state = {
        mode: 'focus', // 'focus' | 'break' | 'longbreak'
        status: 'idle', // 'idle' | 'running' | 'paused'
        timeRemaining: 0,
        totalTime: 0,
        endTime: 0,
        intervalId: null,
        completedInCycle: 0,
        settings: { ...DEFAULTS },
        stats: { totalPomodoros: 0, dailyCounts: {}, dailyMinutes: {}, bestStreak: 0 },
        user: null, // Firebase user object
        userMenuOpen: false,
        tasks: [], // [{ id, title, completed }]
        projects: [], // [{ id, name, createdAt }]
        activeProjectId: null,
        currentTaskId: null,
        sessionStartTime: null,
        audio: {
          isPlaying: false,
          currentCategory: 'ambient',
          currentStationIndex: 0,
          volume: 0.7,
          isMuted: false,
          isExpanded: false,
        },
        subscription: {
          status: 'none',
          tier: null,
          customerId: null,
          currentPeriodEnd: null,
          cancelAtPeriodEnd: false,
          gracePeriod: false
        }
      };

      // --- Storage ---
      function loadSettings() {
        try {
          const raw = localStorage.getItem(STORAGE_KEYS.settings);
          if (raw) Object.assign(state.settings, JSON.parse(raw));
        } catch {}
      }

      function saveSettings() {
        localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(state.settings));
      }

      function loadStats() {
        try {
          const raw = localStorage.getItem(STORAGE_KEYS.stats);
          if (raw) Object.assign(state.stats, JSON.parse(raw));
        } catch {}
      }

      function saveStats() {
        localStorage.setItem(STORAGE_KEYS.stats, JSON.stringify(state.stats));
      }

      function loadTheme() {
        const saved = localStorage.getItem(STORAGE_KEYS.theme);
        if (saved) return saved;
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      function saveTheme(theme) {
        localStorage.setItem(STORAGE_KEYS.theme, theme);
      }

      function showThemeSelector() {
        themeGrid.innerHTML = '';
        const currentTheme = root.dataset.theme || 'light';

        THEMES.forEach(theme => {
          const card = document.createElement('button');
          card.className = 'theme-card';
          if (theme.id === currentTheme) card.classList.add('active');

          const isLocked = theme.premium && !isPremium();
          if (isLocked) card.classList.add('locked');

          const swatch = document.createElement('div');
          swatch.className = 'theme-swatch';
          swatch.style.background = theme.color;

          const name = document.createElement('div');
          name.className = 'theme-card-name';
          name.textContent = theme.name;

          card.appendChild(swatch);
          card.appendChild(name);

          if (isLocked) {
            const badge = document.createElement('div');
            badge.className = 'theme-card-badge';
            badge.textContent = 'Premium';
            card.appendChild(badge);
          }

          card.addEventListener('click', () => {
            if (isLocked) {
              requirePremium('Premium Themes');
              return;
            }
            applyTheme(theme.id);
            document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
          });

          themeGrid.appendChild(card);
        });

        themeDialog.showModal();
      }

      function applyTheme(themeId) {
        root.dataset.theme = themeId;
        saveTheme(themeId);
      }

      function showChimeSelector() {
        chimeGrid.innerHTML = '';
        const selectedChime = state.settings.selectedChime || 'bell';

        Object.entries(CHIME_SOUNDS).forEach(([id, chime]) => {
          const card = document.createElement('button');
          card.className = 'chime-card';
          if (id === selectedChime) card.classList.add('active');

          const isLocked = chime.premium && !isPremium();
          if (isLocked) card.classList.add('locked');

          const name = document.createElement('div');
          name.className = 'chime-card-name';
          name.textContent = chime.name;

          const previewBtn = document.createElement('button');
          previewBtn.className = 'chime-preview-btn';
          previewBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 5L6 9H2v6h4l5 4V5z"/>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
          </svg>`;
          previewBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (chime.premium && !isPremium()) {
              requirePremium('Premium Sounds');
              return;
            }
            previewChime(id);
          });

          card.appendChild(name);
          if (isLocked) {
            const badge = document.createElement('div');
            badge.className = 'chime-card-badge';
            badge.textContent = 'Premium';
            card.appendChild(badge);
          }
          card.appendChild(previewBtn);

          card.addEventListener('click', () => {
            if (chime.premium && !isPremium()) {
              requirePremium('Premium Sounds');
              return;
            }
            state.settings.selectedChime = id;
            saveSettings();
            document.querySelectorAll('.chime-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            updateChimeSettingLabel();
            chimeDialog.close();
          });

          chimeGrid.appendChild(card);
        });

        chimeDialog.showModal();
      }

      function updateChimeSettingLabel() {
        if (openChimeSelectorBtn) {
          const selectedChime = state.settings.selectedChime || 'bell';
          const chime = CHIME_SOUNDS[selectedChime];
          openChimeSelectorBtn.textContent = chime ? `${chime.name} >` : 'Classic Bell >';
        }
      }

      // --- CSV Export ---
      function showExportDialog() {
        if (!requirePremium('CSV Export')) return;

        // Set default date range: start = first day of current month, end = today
        const now = new Date();
        const startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        const endDate = now;

        const formatDate = (d) => {
          const year = d.getFullYear();
          const month = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        };

        $('#exportStartDate').value = formatDate(startDate);
        $('#exportEndDate').value = formatDate(endDate);
        $('#exportStatus').textContent = '';

        exportDialog.showModal();
      }

      async function exportSessionsCSV() {
        const startInput = document.getElementById('exportStartDate');
        const endInput = document.getElementById('exportEndDate');
        const statusEl = document.getElementById('exportStatus');

        if (!startInput.value || !endInput.value) {
          statusEl.textContent = 'Please select both dates.';
          return;
        }

        const startDate = new Date(startInput.value + 'T00:00:00');
        const endDate = new Date(endInput.value + 'T23:59:59');

        if (startDate > endDate) {
          statusEl.textContent = 'Start date must be before end date.';
          return;
        }

        if (!state.user) {
          statusEl.textContent = 'Please sign in to export.';
          return;
        }

        statusEl.textContent = 'Fetching sessions...';

        try {
          const uid = state.user.uid;
          const sessionsRef = fbDb.collection('users').doc(uid).collection('sessions');
          const query = sessionsRef
            .where('startedAt', '>=', startDate)
            .where('startedAt', '<=', endDate)
            .orderBy('startedAt', 'desc')
            .limit(10000);

          const snapshot = await query.get();

          if (snapshot.empty) {
            statusEl.textContent = 'No sessions found in this date range.';
            return;
          }

          // Build project name lookup
          const projectMap = {};
          (state.projects || []).forEach(p => { projectMap[p.id] = p.name; });

          // Build session rows
          const sessions = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            const startedAt = data.startedAt?.toDate ? data.startedAt.toDate() : new Date(data.startedAt);
            sessions.push([
              startedAt.toISOString(),
              data.duration || '',
              data.projectId ? (projectMap[data.projectId] || 'Unknown Project') : 'No Project',
              data.hourOfDay != null ? data.hourOfDay : '',
              data.dayOfWeek != null ? ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][data.dayOfWeek] : '',
            ]);
          });

          generateAndDownloadCSV(sessions, startInput.value, endInput.value);
          statusEl.textContent = `Exported ${sessions.length} sessions.`;

          // Close dialog after short delay
          setTimeout(() => exportDialog.close(), 1500);
        } catch (err) {
          console.error('Export failed:', err);
          if (err.message && err.message.includes('index')) {
            statusEl.textContent = 'Firestore index needed. Check console for setup link.';
          } else {
            statusEl.textContent = 'Export failed. Please try again.';
          }
        }
      }

      function escapeCSVField(field) {
        if (field == null) return '';
        const str = String(field);
        if (str.includes(',') || str.includes('\n') || str.includes('"')) {
          return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
      }

      function generateAndDownloadCSV(rows, startDate, endDate) {
        const headers = ['Date', 'Duration (min)', 'Project', 'Hour of Day', 'Day of Week'];
        const csvRows = [headers.map(escapeCSVField)];
        rows.forEach(row => csvRows.push(row.map(escapeCSVField)));

        // UTF-8 BOM for Excel compatibility + CSV content
        const csvContent = '\uFEFF' + csvRows.map(r => r.join(',')).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        const link = document.createElement('a');
        link.href = url;
        link.download = 'pomodoro-sessions-' + startDate + '-to-' + endDate + '.csv';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      // --- Analytics ---
      const chartInstances = {};

      function getChartColors() {
        const style = getComputedStyle(document.documentElement);
        return {
          primary: style.getPropertyValue('--chart-primary').trim(),
          secondary: style.getPropertyValue('--chart-secondary').trim(),
          accent: style.getPropertyValue('--chart-accent').trim(),
          grid: style.getPropertyValue('--chart-grid').trim(),
          text: style.getPropertyValue('--chart-text').trim(),
          success: style.getPropertyValue('--chart-success').trim()
        };
      }

      function renderChart(canvasId, config) {
        if (chartInstances[canvasId]) {
          chartInstances[canvasId].destroy();
        }
        const ctx = document.getElementById(canvasId).getContext('2d');
        chartInstances[canvasId] = new Chart(ctx, config);
        return chartInstances[canvasId];
      }

      function getWeekBounds(weeksAgo = 0) {
        const now = new Date();
        const dayOfWeek = now.getDay();
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - dayOfWeek - (weeksAgo * 7));
        startOfWeek.setHours(0, 0, 0, 0);

        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        endOfWeek.setHours(23, 59, 59, 999);

        return { startOfWeek, endOfWeek };
      }

      async function fetchSessions(startDate, endDate) {
        if (!state.user) return [];

        try {
          const uid = state.user.uid;
          const sessionsRef = fbDb.collection('users').doc(uid).collection('sessions');
          const query = sessionsRef
            .where('timestamp', '>=', startDate)
            .where('timestamp', '<=', endDate)
            .orderBy('timestamp', 'asc');

          const snapshot = await query.get();
          return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (err) {
          console.error('Error fetching sessions:', err);
          return [];
        }
      }

      function openAnalyticsDialog() {
        if (!requirePremium('Analytics')) return;

        analyticsDialog.showModal();

        // Load initial tab (Overview) if not already loaded
        const activePanel = analyticsDialog.querySelector('.analytics-panel[style*="display:block"], .analytics-panel[style*="display: block"]');
        if (activePanel && activePanel.querySelector('.analytics-loading')) {
          const tabName = activePanel.dataset.tabPanel;
          renderAnalyticsTab(tabName);
        }
      }

      function switchAnalyticsTab(tabName) {
        // Update tab buttons
        const tabButtons = analyticsDialog.querySelectorAll('.analytics-tab');
        tabButtons.forEach(btn => {
          if (btn.dataset.tabButton === tabName) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });

        // Update tab panels
        const tabPanels = analyticsDialog.querySelectorAll('.analytics-panel');
        tabPanels.forEach(panel => {
          if (panel.dataset.tabPanel === tabName) {
            panel.style.display = 'block';

            // Lazy render: if panel has loading state, render content
            if (panel.querySelector('.analytics-loading')) {
              renderAnalyticsTab(tabName);
            }
          } else {
            panel.style.display = 'none';
          }
        });
      }

      function renderAnalyticsTab(tabName) {
        switch(tabName) {
          case 'overview':
            renderOverviewTab();
            break;
          case 'projects':
            renderProjectsTab();
            break;
          case 'forecast':
          case 'yearly':
            // To be implemented in future plans
            break;
        }
      }

      // --- Analytics: Overview Tab ---

      function calculateProductivityScore(sessions) {
        if (sessions.length === 0) return 0;

        // 40% total focus time (300 min = 5 hours in a week = max)
        const totalMinutes = sessions.reduce((sum, s) => sum + (s.minutesCompleted || 0), 0);
        const timeScore = Math.min(40, (totalMinutes / 300) * 40);

        // 30% consistency (7 active days = max)
        const uniqueDays = new Set(sessions.map(s => {
          const d = s.timestamp.toDate();
          return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
        })).size;
        const consistencyScore = (uniqueDays / 7) * 30;

        // 30% session quality (45 min average session = max)
        const avgSessionMinutes = totalMinutes / sessions.length;
        const qualityScore = Math.min(30, (avgSessionMinutes / 45) * 30);

        return Math.round(timeScore + consistencyScore + qualityScore);
      }

      function getScoreLabel(score) {
        if (score >= 90) return 'Crushing it!';
        if (score >= 70) return 'On fire';
        if (score >= 50) return 'Building momentum';
        if (score >= 30) return 'Getting started';
        return 'Every session counts';
      }

      function getScoreColor(score) {
        if (score >= 70) return '#2ecc71'; // green
        if (score >= 50) return '#f39c12'; // yellow
        return '#e74c3c'; // red
      }

      function renderProductivityGauge(score, comparison) {
        const color = getScoreColor(score);
        const label = getScoreLabel(score);
        const circumference = 2 * Math.PI * 70; // radius = 70
        const offset = circumference - (score / 100) * circumference;

        let comparisonHtml = '';
        if (comparison !== null) {
          const diff = score - comparison;
          if (diff > 0) {
            comparisonHtml = `<span class="score-up">+${diff} vs last week</span>`;
          } else if (diff < 0) {
            comparisonHtml = `<span class="score-down">${diff} vs last week</span>`;
          } else {
            comparisonHtml = `<span class="score-same">Same as last week</span>`;
          }
        }

        return `
          <div class="productivity-gauge">
            <svg class="gauge-svg" viewBox="0 0 160 160">
              <circle cx="80" cy="80" r="70" fill="none" stroke="#e0e0e0" stroke-width="12"/>
              <circle cx="80" cy="80" r="70" fill="none" stroke="${color}" stroke-width="12"
                      stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                      transform="rotate(-90 80 80)" stroke-linecap="round"/>
              <text x="80" y="75" text-anchor="middle" font-size="36" font-weight="bold" fill="currentColor">${score}</text>
              <text x="80" y="95" text-anchor="middle" font-size="14" fill="var(--text-secondary)">${label}</text>
            </svg>
            <div style="text-align: center; margin-top: 8px; font-size: 14px;">
              ${comparisonHtml}
            </div>
          </div>
        `;
      }

      function renderWeeklySummary(thisWeek, lastWeek, fourWeekAvg) {
        const thisWeekMinutes = thisWeek.reduce((sum, s) => sum + (s.minutesCompleted || 0), 0);
        const lastWeekMinutes = lastWeek.reduce((sum, s) => sum + (s.minutesCompleted || 0), 0);
        const thisWeekSessions = thisWeek.length;
        const lastWeekSessions = lastWeek.length;
        const avgSession = thisWeekSessions > 0 ? Math.round(thisWeekMinutes / thisWeekSessions) : 0;

        const timeVsLast = thisWeekMinutes - lastWeekMinutes;
        const timeVsAvg = thisWeekMinutes - fourWeekAvg;
        const sessionsVsLast = thisWeekSessions - lastWeekSessions;

        function formatChange(value, suffix = '') {
          if (value > 0) return `<span class="score-up">+${value}${suffix}</span>`;
          if (value < 0) return `<span class="score-down">${value}${suffix}</span>`;
          return `<span class="score-same">â€”</span>`;
        }

        return `
          <div class="summary-cards">
            <div class="summary-card">
              <div class="summary-value">${thisWeekMinutes} min</div>
              <div class="summary-label">Total Focus</div>
              <div class="summary-comparison">
                ${formatChange(timeVsLast, ' min')} vs last week<br>
                ${formatChange(timeVsAvg, ' min')} vs 4-wk avg
              </div>
            </div>
            <div class="summary-card">
              <div class="summary-value">${thisWeekSessions}</div>
              <div class="summary-label">Sessions</div>
              <div class="summary-comparison">
                ${formatChange(sessionsVsLast)} vs last week
              </div>
            </div>
            <div class="summary-card">
              <div class="summary-value">${avgSession} min</div>
              <div class="summary-label">Avg Session</div>
              <div class="summary-comparison">This week</div>
            </div>
          </div>
        `;
      }

      function analyzeBestFocusHours(sessions) {
        const hourlyMinutes = new Array(24).fill(0);

        sessions.forEach(s => {
          const hour = s.timestamp.toDate().getHours();
          hourlyMinutes[hour] += s.minutesCompleted || 0;
        });

        // Find best 2-hour window
        let bestWindow = { start: 0, total: 0 };
        for (let i = 0; i < 24; i++) {
          const windowTotal = hourlyMinutes[i] + (hourlyMinutes[(i + 1) % 24] || 0);
          if (windowTotal > bestWindow.total) {
            bestWindow = { start: i, total: windowTotal };
          }
        }

        const formatHour = (h) => {
          const period = h >= 12 ? 'PM' : 'AM';
          const hour12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
          return `${hour12}${period}`;
        };

        const recommendation = bestWindow.total > 0
          ? `Your peak focus window is ${formatHour(bestWindow.start)}-${formatHour((bestWindow.start + 2) % 24)}. Consider scheduling deep work during these hours.`
          : 'Complete more sessions to see your best focus hours.';

        return { hourlyMinutes, recommendation };
      }

      function renderFocusHoursChart(hourlyMinutes) {
        const colors = getChartColors();
        const maxMinutes = Math.max(...hourlyMinutes, 1);

        const labels = Array.from({ length: 24 }, (_, i) => {
          const period = i >= 12 ? 'PM' : 'AM';
          const hour12 = i === 0 ? 12 : i > 12 ? i - 12 : i;
          return `${hour12}${period}`;
        });

        const config = {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Focus Minutes',
              data: hourlyMinutes,
              backgroundColor: colors.primary,
              borderRadius: 4,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.parsed.y} min`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: colors.grid },
                ticks: { color: colors.text }
              },
              x: {
                grid: { display: false },
                ticks: { color: colors.text }
              }
            }
          }
        };

        return config;
      }

      async function renderOverviewTab() {
        const panel = analyticsDialog.querySelector('[data-tab-panel="overview"]');
        if (!panel) return;

        panel.innerHTML = '<div class="analytics-loading">Loading overview...</div>';

        try {
          // Fetch all required data in parallel
          const thisWeekBounds = getWeekBounds(0);
          const lastWeekBounds = getWeekBounds(1);
          const fourWeeksAgoBounds = getWeekBounds(4);

          const [thisWeekSessions, lastWeekSessions, fourWeekSessions] = await Promise.all([
            fetchSessions(thisWeekBounds.startOfWeek, thisWeekBounds.endOfWeek),
            fetchSessions(lastWeekBounds.startOfWeek, lastWeekBounds.endOfWeek),
            fetchSessions(fourWeeksAgoBounds.startOfWeek, thisWeekBounds.endOfWeek)
          ]);

          // Calculate metrics
          const thisWeekScore = calculateProductivityScore(thisWeekSessions);
          const lastWeekScore = calculateProductivityScore(lastWeekSessions);
          const fourWeekAvgMinutes = fourWeekSessions.length > 0
            ? Math.round(fourWeekSessions.reduce((sum, s) => sum + (s.minutesCompleted || 0), 0) / 4)
            : 0;

          const { hourlyMinutes, recommendation } = analyzeBestFocusHours(thisWeekSessions);

          // Render all sections
          const gaugeHtml = renderProductivityGauge(thisWeekScore, lastWeekScore);
          const summaryHtml = renderWeeklySummary(thisWeekSessions, lastWeekSessions, fourWeekAvgMinutes);

          panel.innerHTML = `
            <div class="overview-content">
              <h3 style="margin-top: 0; margin-bottom: 16px;">Productivity Score</h3>
              ${gaugeHtml}

              <h3 style="margin-top: 24px; margin-bottom: 16px;">Weekly Summary</h3>
              ${summaryHtml}

              <h3 style="margin-top: 24px; margin-bottom: 8px;">Best Focus Hours</h3>
              <p class="focus-recommendation">${recommendation}</p>
              <div class="chart-container">
                <canvas id="focusHoursChart"></canvas>
              </div>
            </div>
          `;

          // Render chart after DOM update
          setTimeout(() => {
            renderChart('focusHoursChart', renderFocusHoursChart(hourlyMinutes));
          }, 0);

        } catch (err) {
          console.error('Error rendering overview:', err);
          panel.innerHTML = '<div class="analytics-loading">Error loading overview. Please try again.</div>';
        }
      }

      // --- Analytics: Projects Tab ---

      async function renderProjectsTab() {
        const panel = analyticsDialog.querySelector('[data-tab-panel="projects"]');
        if (!panel) return;

        panel.innerHTML = '<div class="analytics-loading">Loading projects...</div>';

        try {
          // Fetch last 4 weeks of sessions
          const fourWeeksAgo = getWeekBounds(4);
          const now = getWeekBounds(0);
          const sessions = await fetchSessions(fourWeeksAgo.startOfWeek, now.endOfWeek);

          if (sessions.length === 0) {
            panel.innerHTML = `
              <div class="analytics-empty">
                <p style="margin: 0 0 8px 0; font-size: 16px;">No session data yet</p>
                <p style="margin: 0; font-size: 14px;">Complete some focus sessions to see your project breakdown</p>
              </div>
            `;
            return;
          }

          // Build project name lookup
          const projectLookup = {};
          state.projects.forEach(p => {
            projectLookup[p.id] = p.name;
          });

          // Aggregate time per project
          const projectMinutes = {};
          sessions.forEach(s => {
            const projectId = s.projectId || 'none';
            const projectName = projectId === 'none' ? 'No Project' : (projectLookup[projectId] || 'Unknown Project');
            if (!projectMinutes[projectName]) {
              projectMinutes[projectName] = 0;
            }
            projectMinutes[projectName] += (s.minutesCompleted || 0);
          });

          // Sort projects by time (descending)
          const sortedProjects = Object.entries(projectMinutes)
            .sort((a, b) => b[1] - a[1]);

          // Top 5 projects for trend chart
          const top5Projects = sortedProjects.slice(0, 5);

          // Group by week + project for trend line chart
          const weeklyData = {};
          sessions.forEach(s => {
            const date = s.timestamp.toDate();
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - date.getDay()); // Sunday
            weekStart.setHours(0, 0, 0, 0);
            const weekKey = weekStart.toISOString().split('T')[0];

            const projectId = s.projectId || 'none';
            const projectName = projectId === 'none' ? 'No Project' : (projectLookup[projectId] || 'Unknown Project');

            if (!weeklyData[weekKey]) {
              weeklyData[weekKey] = {};
            }
            if (!weeklyData[weekKey][projectName]) {
              weeklyData[weekKey][projectName] = 0;
            }
            weeklyData[weekKey][projectName] += (s.minutesCompleted || 0);
          });

          const sortedWeeks = Object.keys(weeklyData).sort();

          panel.innerHTML = `
            <div class="projects-content">
              <div class="project-chart-container">
                <h3 style="margin-top: 0; margin-bottom: 8px;">Project Time Allocation</h3>
                <p class="analytics-subtitle">Total time spent per project (last 4 weeks)</p>
                <div class="chart-container">
                  <canvas id="projectDonutChart"></canvas>
                </div>
              </div>

              <div class="project-chart-container">
                <h3 style="margin-top: 0; margin-bottom: 8px;">Weekly Project Trends</h3>
                <p class="analytics-subtitle">Top 5 projects tracked week-by-week</p>
                <div class="chart-container">
                  <canvas id="projectTrendChart"></canvas>
                </div>
              </div>
            </div>
          `;

          const colors = getChartColors();
          const palette = [colors.primary, colors.secondary, colors.accent, colors.success, '#e056fd', '#7ed6df', '#ffbe76', '#badc58'];

          // Render charts after DOM update
          setTimeout(() => {
            // Donut chart
            const donutData = sortedProjects.map(([name, minutes]) => minutes);
            const donutLabels = sortedProjects.map(([name, minutes]) => name);
            const donutColors = sortedProjects.map((_, i) => palette[i % palette.length]);

            const totalMinutes = donutData.reduce((sum, m) => sum + m, 0);

            renderChart('projectDonutChart', {
              type: 'doughnut',
              data: {
                labels: donutLabels,
                datasets: [{
                  data: donutData,
                  backgroundColor: donutColors,
                  borderWidth: 0
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: {
                      color: colors.text,
                      usePointStyle: true,
                      padding: 12
                    }
                  },
                  tooltip: {
                    callbacks: {
                      label: (ctx) => {
                        const minutes = ctx.parsed;
                        const percentage = ((minutes / totalMinutes) * 100).toFixed(1);
                        return `${ctx.label}: ${minutes} min (${percentage}%)`;
                      }
                    }
                  }
                }
              }
            });

            // Trend line chart
            const trendDatasets = top5Projects.map(([projectName, _], idx) => {
              const data = sortedWeeks.map(weekKey => {
                return weeklyData[weekKey][projectName] || 0;
              });

              return {
                label: projectName,
                data: data,
                borderColor: palette[idx % palette.length],
                backgroundColor: palette[idx % palette.length],
                tension: 0.3,
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: false
              };
            });

            const weekLabels = sortedWeeks.map(weekKey => {
              const d = new Date(weekKey);
              return `${d.getMonth() + 1}/${d.getDate()}`;
            });

            renderChart('projectTrendChart', {
              type: 'line',
              data: {
                labels: weekLabels,
                datasets: trendDatasets
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: {
                      color: colors.text,
                      usePointStyle: true,
                      padding: 12
                    }
                  },
                  tooltip: {
                    callbacks: {
                      label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y} min`
                    }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: { color: colors.grid },
                    ticks: {
                      color: colors.text,
                      callback: (value) => `${value} min`
                    }
                  },
                  x: {
                    grid: { display: false },
                    ticks: { color: colors.text }
                  }
                }
              }
            });
          }, 0);

        } catch (err) {
          console.error('Error rendering projects tab:', err);
          panel.innerHTML = '<div class="analytics-loading">Error loading projects. Please try again.</div>';
        }
      }

      // --- Tasks ---
      function loadTasks() {
        try {
          const raw = localStorage.getItem(STORAGE_KEYS.tasks);
          if (raw) state.tasks = JSON.parse(raw);
        } catch {}
      }

      function saveTasks() {
        localStorage.setItem(STORAGE_KEYS.tasks, JSON.stringify(state.tasks));
      }

      function loadProjects() {
        try {
          const raw = localStorage.getItem(STORAGE_KEYS.projects);
          if (raw) state.projects = JSON.parse(raw);
        } catch {}
      }

      function saveProjects() {
        localStorage.setItem(STORAGE_KEYS.projects, JSON.stringify(state.projects));
      }

      function addTask() {
        const title = taskInput.value.trim();
        if (!title || state.tasks.length >= 10) return;

        state.tasks.push({
          id: Date.now().toString(),
          title,
          completed: false,
          projectId: state.activeProjectId || null,
        });
        saveTasks();
        taskInput.value = '';
        renderTasks();
      }

      function toggleTask(id) {
        const task = state.tasks.find(t => t.id === id);
        if (task) {
          task.completed = !task.completed;
          saveTasks();
          renderTasks();
        }
      }

      function deleteTask(id) {
        state.tasks = state.tasks.filter(t => t.id !== id);
        saveTasks();
        renderTasks();
      }

      function renderTasks() {
        // Filter tasks if premium user has active project
        let tasksToShow = state.tasks;
        if (isPremium() && state.activeProjectId) {
          tasksToShow = state.tasks.filter(t => t.projectId === state.activeProjectId);
        }

        taskCount.textContent = tasksToShow.filter(t => !t.completed).length;
        taskList.innerHTML = '';

        if (tasksToShow.length === 0) {
          taskList.innerHTML = '<li class="tasks-empty">No tasks yet</li>';
          return;
        }

        // Sort: incomplete first, then completed
        const sorted = [...tasksToShow].sort((a, b) => a.completed - b.completed);

        sorted.forEach(task => {
          const li = document.createElement('li');
          li.className = 'task-item' + (task.completed ? ' completed' : '');

          // Add project badge if task has a project and we're not filtering
          const project = task.projectId ? state.projects.find(p => p.id === task.projectId) : null;
          const projectLabel = (project && !state.activeProjectId) ? `<span class="task-project-badge">${project.name.replace(/</g, '&lt;')}</span>` : '';

          li.innerHTML = `
            <input type="checkbox" class="task-checkbox" data-id="${task.id}" ${task.completed ? 'checked' : ''}>
            <span class="task-text">${task.title.replace(/</g, '&lt;')}</span>
            ${projectLabel}
            <button class="task-delete" data-id="${task.id}">remove</button>
          `;
          taskList.appendChild(li);
        });
      }

      // --- Project Management ---

      function renderProjectDropdown() {
        const menu = document.getElementById('projectDropdownMenu');
        const label = document.getElementById('projectDropdownLabel');
        menu.innerHTML = '';

        // "All Tasks" option
        const allDiv = document.createElement('div');
        allDiv.className = 'project-dropdown-option' + (!state.activeProjectId ? ' active' : '');
        allDiv.textContent = 'All Tasks';
        allDiv.dataset.value = '';
        menu.appendChild(allDiv);

        // Sort projects alphabetically
        const sorted = [...state.projects].sort((a, b) => a.name.localeCompare(b.name));
        sorted.forEach(project => {
          const div = document.createElement('div');
          div.className = 'project-dropdown-option' + (project.id === state.activeProjectId ? ' active' : '');
          div.textContent = project.name;
          div.dataset.value = project.id;
          menu.appendChild(div);
        });

        // Update label
        const active = state.projects.find(p => p.id === state.activeProjectId);
        label.textContent = active ? active.name : 'All Tasks';
      }

      function renderManageProjectsList() {
        projectListManage.innerHTML = '';

        if (state.projects.length === 0) {
          projectListManage.innerHTML = '<li style="padding:16px;text-align:center;color:var(--text-secondary);">No projects yet</li>';
          return;
        }

        state.projects.forEach(project => {
          const li = document.createElement('li');
          li.className = 'project-item';
          li.innerHTML = `
            <span class="project-name">${project.name.replace(/</g, '&lt;')}</span>
            <button class="btn-icon" data-action="edit" data-id="${project.id}" aria-label="Edit project">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </button>
            <button class="btn-icon" data-action="delete" data-id="${project.id}" aria-label="Delete project">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
            </button>
          `;
          projectListManage.appendChild(li);
        });
      }

      function createProject(name) {
        if (!requirePremium('Projects')) return;
        if (state.projects.length >= 100) {
          alert('Maximum 100 projects');
          return;
        }

        state.projects.push({
          id: crypto.randomUUID(),
          name: name.trim(),
          createdAt: Date.now()
        });

        saveProjects();
        saveProjectsToFirestore();
        renderProjectDropdown();
        renderManageProjectsList();
      }

      function renameProject(projectId, newName) {
        if (!requirePremium('Projects')) return;

        const project = state.projects.find(p => p.id === projectId);
        if (project) {
          project.name = newName.trim();
          saveProjects();
          saveProjectsToFirestore();
          renderProjectDropdown();
          renderManageProjectsList();
        }
      }

      function deleteProject(projectId) {
        if (!requirePremium('Projects')) return;
        if (!confirm('Delete this project? Tasks will be unassigned.')) return;

        // Unassign tasks from this project
        state.tasks.forEach(t => {
          if (t.projectId === projectId) {
            t.projectId = null;
          }
        });

        // Remove project
        state.projects = state.projects.filter(p => p.id !== projectId);

        // Clear active project if it's the deleted one
        if (state.activeProjectId === projectId) {
          state.activeProjectId = null;
        }

        saveProjects();
        saveTasks();
        saveProjectsToFirestore();
        renderProjectDropdown();
        renderTasks();
        renderManageProjectsList();
      }

      // --- Helpers ---
      function dateKeyLocal(date = new Date()) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }

      function todayKey() {
        return dateKeyLocal(new Date());
      }

      function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
      }

      function getDurationForMode(mode) {
        switch (mode) {
          case 'focus': return state.settings.focusDuration * 60;
          case 'break': return state.settings.breakDuration * 60;
          case 'longbreak': return state.settings.longBreakDuration * 60;
        }
      }

      function getModeName(mode) {
        switch (mode) {
          case 'focus': return 'Focus Time';
          case 'break': return 'Break';
          case 'longbreak': return 'Long Break';
        }
      }

      function getThemeColor() {
        const theme = root.dataset.theme;
        const mode = root.dataset.mode;
        if (mode === 'focus') return '#e74c3c';
        if (theme === 'dark') return '#2ecc71';
        return '#27ae60';
      }

      // --- Streak calculation ---
      function calculateStreak() {
        const counts = state.stats.dailyCounts;
        let streak = 0;
        const d = new Date();
        // Check today first
        const today = dateKeyLocal(d);
        if (!counts[today] || counts[today] < 1) {
          // Check if yesterday has counts (streak not broken yet today)
          d.setDate(d.getDate() - 1);
        }
        while (true) {
          const key = dateKeyLocal(d);
          if (counts[key] && counts[key] >= 1) {
            streak++;
            d.setDate(d.getDate() - 1);
          } else {
            break;
          }
        }
        return streak;
      }

      // --- Sound (Web Audio API) ---
      let audioCtx = null;

      function getAudioCtx() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        return audioCtx;
      }

      function playChime(type) {
        if (!state.settings.soundEnabled) return;

        // Duck background audio before chime
        duckBackgroundAudio();

        try {
          const ctx = getAudioCtx();
          const now = ctx.currentTime;
          const selectedChimeId = state.settings.selectedChime || 'bell';
          const chime = CHIME_SOUNDS[selectedChimeId] || CHIME_SOUNDS.bell;

          // For break completion, reverse the notes
          const notes = type === 'break' ? [...chime.notes].reverse() : chime.notes;

          notes.forEach((freq, i) => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = chime.type;
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0, now + i * chime.spacing);
            gain.gain.linearRampToValueAtTime(chime.gain, now + i * chime.spacing + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, now + i * chime.spacing + chime.duration);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start(now + i * chime.spacing);
            osc.stop(now + i * chime.spacing + chime.duration);
          });
        } catch {}
      }

      function previewChime(chimeId) {
        const chime = CHIME_SOUNDS[chimeId];
        if (!chime) return;
        try {
          const ctx = getAudioCtx();
          const now = ctx.currentTime;
          chime.notes.forEach((freq, i) => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = chime.type;
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0, now + i * chime.spacing);
            gain.gain.linearRampToValueAtTime(chime.gain, now + i * chime.spacing + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, now + i * chime.spacing + chime.duration);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start(now + i * chime.spacing);
            osc.stop(now + i * chime.spacing + chime.duration);
          });
        } catch {}
      }

      // --- Celebration ---
      function showCelebration(message) {
        // Respect reduced motion preference
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        // Clear any existing celebration
        celebrationContainer.innerHTML = '';

        // Create backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'celebration-backdrop';

        // Create message modal
        const modal = document.createElement('div');
        modal.className = 'celebration-message';
        modal.setAttribute('role', 'alert');
        modal.setAttribute('aria-live', 'polite');
        modal.innerHTML = `
          <span class="celebration-emoji" aria-hidden="true">ðŸŽ‰</span>
          <span class="celebration-text">${message}</span>
        `;

        // Create confetti overlay (only if motion is allowed)
        if (!prefersReducedMotion) {
          const confettiOverlay = document.createElement('div');
          confettiOverlay.className = 'confetti-overlay';

          for (let i = 0; i < 50; i++) {
            const piece = document.createElement('div');
            piece.className = 'confetti-piece';
            piece.style.left = Math.random() * 100 + '%';
            piece.style.backgroundColor = CONFETTI_COLORS[Math.floor(Math.random() * CONFETTI_COLORS.length)];
            piece.style.width = (Math.random() * 8 + 6) + 'px';
            piece.style.height = (Math.random() * 8 + 6) + 'px';
            piece.style.animationDelay = (Math.random() * 0.5) + 's';
            piece.style.animationDuration = (Math.random() * 1 + 2.5) + 's';
            piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
            confettiOverlay.appendChild(piece);
          }

          celebrationContainer.appendChild(confettiOverlay);
        }

        celebrationContainer.appendChild(backdrop);
        celebrationContainer.appendChild(modal);

        // Dismiss function
        function dismiss() {
          celebrationContainer.innerHTML = '';
        }

        // Click backdrop to dismiss
        backdrop.addEventListener('click', dismiss);

        // Auto-dismiss after 4 seconds
        setTimeout(dismiss, 4000);
      }

      // --- Notifications ---
      function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
      }

      function sendNotification(title, body) {
        if ('Notification' in window && Notification.permission === 'granted') {
          try { new Notification(title, { body, icon: 'data:image/svg+xml,...' }); } catch {}
        }
      }

      // --- UI Updates ---
      function updateTimerDisplay() {
        const text = formatTime(state.timeRemaining);
        timeDisplay.textContent = text;
      }

      function updateProgressRing() {
        const fraction = state.totalTime > 0
          ? state.timeRemaining / state.totalTime
          : 1;
        const offset = CIRCUMFERENCE * (1 - fraction);
        progressRing.style.strokeDashoffset = offset;
      }

      function updateControls() {
        if (state.status === 'running') {
          startBtn.classList.add('hidden');
          pauseBtn.classList.remove('hidden');
        } else {
          startBtn.classList.remove('hidden');
          pauseBtn.classList.add('hidden');
          startBtn.textContent = state.status === 'paused' ? 'Resume' : 'Start';
        }
      }

      function updateModeIndicator() {
        modeLabel.textContent = getModeName(state.mode);
        root.dataset.mode = state.mode;
        themeColorMeta.content = getThemeColor();
        modeTabs.forEach((tab) => {
          const isActive = tab.dataset.mode === state.mode;
          tab.classList.toggle('active', isActive);
          tab.setAttribute('aria-selected', isActive);
        });
      }

      function updateSessionDots() {
        const dots = sessionDotsEl.querySelectorAll('.dot');
        const interval = state.settings.longBreakInterval;

        dots.forEach((dot, i) => {
          dot.classList.remove('completed', 'active');
          if (i >= interval) {
            dot.style.display = 'none';
          } else {
            dot.style.display = '';
            if (i < state.completedInCycle) {
              dot.classList.add('completed');
            } else if (i === state.completedInCycle && state.mode === 'focus' && state.status === 'running') {
              dot.classList.add('active');
            }
          }
        });
      }

      function getWeekData() {
        const days = [];
        const d = new Date();
        for (let i = 6; i >= 0; i--) {
          const date = new Date(d);
          date.setDate(d.getDate() - i);
          const key = dateKeyLocal(date);
          const dayName = date.toLocaleDateString('en', { weekday: 'short' }).slice(0, 3);
          days.push({
            key,
            dayName,
            minutes: state.stats.dailyMinutes[key] || 0,
            sessions: state.stats.dailyCounts[key] || 0,
            isToday: i === 0,
          });
        }
        return days;
      }

      function getWeekTotalMinutes() {
        return getWeekData().reduce((sum, d) => sum + d.minutes, 0);
      }

      function getDailyGoal() {
        return state.settings.dailyGoal;
      }

      // Format minutes based on unit setting (returns { value, unit, label })
      function formatTimeByUnit(minutes) {
        const unit = state.settings.dailyGoalUnit;
        if (unit === 'hours') {
          const hrs = Math.round(minutes / 6) / 10; // one decimal place
          return { value: hrs, unit: hrs === 1 ? 'hr' : 'hrs', label: 'Hrs' };
        }
        return { value: minutes, unit: 'min', label: 'Min' };
      }

      function updateBestStreak() {
        const current = calculateStreak();
        if (current > state.stats.bestStreak) {
          state.stats.bestStreak = current;
          saveStats();
        }
      }

      function updateTodayProgress() {
        const today = todayKey();
        const minutes = state.stats.dailyMinutes[today] || 0;
        const sessions = state.stats.dailyCounts[today] || 0;
        const goal = getDailyGoal();
        const unit = state.settings.dailyGoalUnit;
        const formatted = formatTimeByUnit(minutes);

        let pct;
        let goalUnitLabel;
        if (unit === 'hours') {
          pct = Math.min(100, Math.round((minutes / (goal * 60)) * 100));
          goalUnitLabel = goal === 1 ? 'hr' : 'hrs';
        } else if (unit === 'pomodoros') {
          pct = Math.min(100, Math.round((sessions / goal) * 100));
          goalUnitLabel = goal === 1 ? 'pomodoro' : 'pomodoros';
        } else {
          pct = Math.min(100, Math.round((minutes / goal) * 100));
          goalUnitLabel = 'min';
        }

        todayMinutesEl.textContent = formatted.value;
        todayMinutesUnit.textContent = formatted.unit;
        // Show value matching the selected unit under progress bar
        if (unit === 'hours') {
          todayDetailLeft.innerHTML = `<span>${formatted.value}</span> ${formatted.unit}`;
        } else if (unit === 'pomodoros') {
          todayDetailLeft.innerHTML = `<span>${sessions}</span> ${sessions === 1 ? 'pomodoro' : 'pomodoros'}`;
        } else {
          todayDetailLeft.innerHTML = `<span>${minutes}</span> min`;
        }
        dailyGoalEl.textContent = goal;
        dailyGoalUnitLabel.textContent = goalUnitLabel;
        progressFill.style.width = pct + '%';
      }

      function updateWeeklyChart() {
        const week = getWeekData();
        const maxMin = Math.max(...week.map((d) => d.minutes), 1);
        const weekTotal = week.reduce((s, d) => s + d.minutes, 0);
        const formatted = formatTimeByUnit(weekTotal);

        weekTotalMin.textContent = formatted.value;
        weekTotalUnit.textContent = formatted.unit;
        chartBars.innerHTML = '';

        week.forEach((day) => {
          const col = document.createElement('div');
          col.className = 'chart-col';

          const barWrap = document.createElement('div');
          barWrap.className = 'chart-bar-wrap';

          const bar = document.createElement('div');
          const heightPct = day.minutes > 0 ? Math.max(8, (day.minutes / maxMin) * 100) : 0;
          bar.className = 'chart-bar' + (day.minutes === 0 ? ' empty' : '');
          bar.style.height = heightPct + '%';

          if (day.minutes > 0) {
            const val = document.createElement('span');
            val.className = 'chart-bar-value';
            const dayFormatted = formatTimeByUnit(day.minutes);
            val.textContent = dayFormatted.value;
            bar.appendChild(val);
          }

          barWrap.appendChild(bar);
          col.appendChild(barWrap);

          const label = document.createElement('span');
          label.className = 'chart-day' + (day.isToday ? ' today' : '');
          label.textContent = day.dayName;
          col.appendChild(label);

          chartBars.appendChild(col);
        });
      }

      function updateStats() {
        const today = todayKey();
        const sessions = state.stats.dailyCounts[today] || 0;
        const minutes = state.stats.dailyMinutes[today] || 0;
        const weekMinutes = getWeekTotalMinutes();

        const todayFormatted = formatTimeByUnit(minutes);
        const weekFormatted = formatTimeByUnit(weekMinutes);

        statTodayMin.textContent = todayFormatted.value;
        statTodayMinLabel.textContent = todayFormatted.label + ' Today';
        statTodaySessions.textContent = sessions;
        statWeekTotal.textContent = weekFormatted.value;
        statWeekTotalLabel.textContent = weekFormatted.label + ' This Week';
        updateBestStreak();
        statBestStreak.textContent = state.stats.bestStreak;

        updateTodayProgress();
        updateWeeklyChart();
      }

      function updateDocumentTitle() {
        if (state.status === 'running' || state.status === 'paused') {
          document.title = `${formatTime(state.timeRemaining)} â€” ${getModeName(state.mode)}`;
        } else {
          document.title = 'Pomodoro Timer';
        }
      }

      // --- Dialog openers for Stats / Leaderboard ---
      function openStatsDialog() {
        if (!state.user) {
          // Show sign-in prompt for stats
          const msg = document.createElement('dialog');
          msg.className = 'quick-dialog';
          msg.innerHTML = `
            <div class="dialog-body" style="text-align: center; padding: 24px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 48px; height: 48px; margin-bottom: 12px;">
                <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
              </svg>
              <h3 style="margin-bottom: 8px;">Sign in to view stats</h3>
              <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.875rem;">Track your focus sessions, streaks, and weekly trends by signing in with Google.</p>
              <div class="dialog-actions" style="justify-content: center;">
                <button class="btn btn-ghost" id="statsPromptClose">Close</button>
                <button class="btn btn-primary" id="statsPromptSignIn">Sign In</button>
              </div>
            </div>
          `;
          document.body.appendChild(msg);
          msg.showModal();
          msg.querySelector('#statsPromptClose').addEventListener('click', () => { msg.close(); msg.remove(); });
          msg.querySelector('#statsPromptSignIn').addEventListener('click', () => { msg.close(); msg.remove(); signInWithGoogle(); });
          msg.addEventListener('click', (e) => { if (e.target === msg) { msg.close(); msg.remove(); } });
          return;
        }
        updateStats();
        statsDialog.showModal();
        statsBtn.classList.add('active');
      }

      function openLeaderboardDialog() {
        loadLeaderboard();
        leaderboardDialog.showModal();
        leaderboardBtn.classList.add('active');
      }

      // --- Auth UI ---
      function updateAuthUI() {
        const loggedIn = !!state.user;
        signInBtn.classList.toggle('hidden', loggedIn);
        userAvatarWrap.classList.toggle('hidden', !loggedIn);
        authPrompt.classList.toggle('hidden', loggedIn);
        leaderboardBtn.classList.toggle('hidden', !loggedIn);
        if (loggedIn) {
          userAvatarImg.src = state.user.photoURL || '';
          userAvatarImg.alt = state.user.displayName || '';
        }
      }

      function showUserMenu() {
        if (state.userMenuOpen) { hideUserMenu(); return; }
        state.userMenuOpen = true;
        // Remove existing menu
        const old = document.querySelector('.user-menu-backdrop');
        if (old) old.remove();

        const backdrop = document.createElement('div');
        backdrop.className = 'user-menu-backdrop';
        backdrop.addEventListener('click', hideUserMenu);

        const menu = document.createElement('div');
        menu.className = 'user-menu';

        const nameDiv = document.createElement('div');
        nameDiv.className = 'user-menu-name';
        nameDiv.textContent = state.user.displayName || 'User';
        menu.appendChild(nameDiv);

        const emailDiv = document.createElement('div');
        emailDiv.className = 'user-menu-email';
        emailDiv.textContent = state.user.email || '';
        menu.appendChild(emailDiv);

        // Add Manage Subscription button if premium and not lifetime
        if (isPremium() && state.subscription.status !== 'lifetime') {
          const manageSubItem = document.createElement('button');
          manageSubItem.className = 'user-menu-item';
          manageSubItem.id = 'manage-subscription-btn';
          manageSubItem.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Manage Subscription';
          manageSubItem.addEventListener('click', () => {
            hideUserMenu();
            openCustomerPortal();
          });
          menu.appendChild(manageSubItem);
        }

        // Add Upgrade button if not premium
        if (!isPremium()) {
          const upgradeItem = document.createElement('button');
          upgradeItem.className = 'user-menu-item';
          upgradeItem.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>Upgrade to Premium';
          upgradeItem.addEventListener('click', () => {
            hideUserMenu();
            showPricingPage();
          });
          menu.appendChild(upgradeItem);
        }

        const signOutItem = document.createElement('button');
        signOutItem.className = 'user-menu-item';
        signOutItem.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Sign out';
        signOutItem.addEventListener('click', () => {
          hideUserMenu();
          fbAuth.signOut();
        });
        menu.appendChild(signOutItem);

        document.body.appendChild(backdrop);
        userAvatarWrap.appendChild(menu);
      }

      function hideUserMenu() {
        state.userMenuOpen = false;
        const backdrop = document.querySelector('.user-menu-backdrop');
        if (backdrop) backdrop.remove();
        const menu = document.querySelector('.user-menu');
        if (menu) menu.remove();
      }

      let isNewSignIn = false; // Track fresh sign-ins vs page refreshes

      function signInWithGoogle() {
        isNewSignIn = true; // Mark as fresh sign-in
        const provider = new firebase.auth.GoogleAuthProvider();
        fbAuth.signInWithPopup(provider).catch(() => { isNewSignIn = false; });
      }

      // --- Subscription Management ---
      function listenToSubscription(uid) {
        fbDb.doc(`users/${uid}/subscription`).onSnapshot((doc) => {
          if (doc.exists) {
            const data = doc.data();
            state.subscription = {
              status: data.status || 'none',
              tier: data.status === 'lifetime' ? 'lifetime' : (data.priceId ? getTierFromPriceId(data.priceId) : null),
              customerId: data.customerId || null,
              currentPeriodEnd: data.currentPeriodEnd || null,
              cancelAtPeriodEnd: data.cancelAtPeriodEnd || false,
              gracePeriod: data.status === 'past_due'
            };
          } else {
            state.subscription = { status: 'none', tier: null, customerId: null, currentPeriodEnd: null, cancelAtPeriodEnd: false, gracePeriod: false };
          }
          localStorage.setItem('subscriptionStatus', state.subscription.status);
          updatePremiumUI();
        });
      }

      function isPremium() {
        if (window.__testPremium) return true;
        return PREMIUM_STATUSES.includes(state.subscription.status);
      }

      function requirePremium(featureName) {
        if (isPremium()) return true;
        showUpgradePrompt(featureName);
        return false;
      }

      function getTierFromPriceId(priceId) {
        if (priceId === STRIPE_PRICES.monthly) return 'monthly';
        if (priceId === STRIPE_PRICES.yearly) return 'yearly';
        if (priceId === STRIPE_PRICES.lifetime) return 'lifetime';
        return null;
      }

      async function startCheckout(priceId, mode) {
        if (!state.user) {
          signInWithGoogle();
          return;
        }
        try {
          const createCheckoutSession = fbFunctions.httpsCallable('createCheckoutSession');
          const result = await createCheckoutSession({ priceId, mode });
          window.location.href = result.data.url;
        } catch (error) {
          console.error('Checkout error:', error);
          alert('Failed to start checkout. Please try again.');
        }
      }

      async function openCustomerPortal() {
        try {
          const createPortalSession = fbFunctions.httpsCallable('createPortalSession');
          const result = await createPortalSession();
          window.location.href = result.data.url;
        } catch (error) {
          console.error('Portal error:', error);
          alert('Failed to open subscription management.');
        }
      }

      function updatePremiumUI() {
        const premium = isPremium();
        const badge = document.getElementById('premium-badge');
        if (badge) {
          badge.style.display = premium ? '' : 'none';
          badge.textContent = state.subscription.status === 'lifetime' ? 'â˜… Lifetime' : 'â˜… Premium';
        }
        const manageBtn = document.getElementById('manage-subscription-btn');
        if (manageBtn) {
          manageBtn.style.display = (premium && state.subscription.status !== 'lifetime') ? '' : 'none';
        }
        const upgradeBtn = document.getElementById('upgrade-btn');
        if (upgradeBtn) {
          upgradeBtn.style.display = premium ? 'none' : '';
        }
        const projectBar = document.getElementById('projectBar');
        if (projectBar) {
          projectBar.style.display = premium ? '' : 'none';
        }
      }

      function showUpgradePrompt(featureName) {
        const prompt = document.getElementById('upgrade-prompt');
        if (!prompt) return;
        const featureEls = prompt.querySelectorAll('.upgrade-feature-name');
        featureEls.forEach(el => el.textContent = featureName || 'this feature');
        prompt.showModal();
      }

      function showPricingPage() {
        const page = document.getElementById('pricing-page');
        if (page) page.showModal();
      }

      function hidePricingPage() {
        const page = document.getElementById('pricing-page');
        if (page) page.close();
      }

      function hideUpgradePrompt() {
        const prompt = document.getElementById('upgrade-prompt');
        if (prompt) prompt.close();
      }

      // --- Premium UI Event Listeners ---
      document.getElementById('upgrade-btn').addEventListener('click', showPricingPage);
      document.getElementById('closePricing').addEventListener('click', hidePricingPage);
      document.getElementById('checkout-monthly').addEventListener('click', () => startCheckout(STRIPE_PRICES.monthly, 'subscription'));
      document.getElementById('checkout-yearly').addEventListener('click', () => startCheckout(STRIPE_PRICES.yearly, 'subscription'));
      document.getElementById('checkout-lifetime').addEventListener('click', () => startCheckout(STRIPE_PRICES.lifetime, 'payment'));
      document.getElementById('closeUpgradePrompt').addEventListener('click', hideUpgradePrompt);
      document.getElementById('upgrade-prompt-dismiss').addEventListener('click', hideUpgradePrompt);
      document.getElementById('upgrade-prompt-view-plans').addEventListener('click', () => { hideUpgradePrompt(); showPricingPage(); });

      // Close pricing/upgrade dialogs on backdrop click
      document.getElementById('pricing-page').addEventListener('click', (e) => { if (e.target === e.currentTarget) hidePricingPage(); });
      document.getElementById('upgrade-prompt').addEventListener('click', (e) => { if (e.target === e.currentTarget) hideUpgradePrompt(); });

      // --- Firestore Sync ---
      async function syncStatsToFirestore() {
        if (!state.user) return;
        const uid = state.user.uid;
        const ref = fbDb.collection('users').doc(uid);
        try {
          const doc = await ref.get();
          const cloud = doc.exists ? doc.data() : {};
          // Merge local into cloud
          const mergedDailyCounts = { ...(cloud.dailyCounts || {}) };
          const mergedDailyMinutes = { ...(cloud.dailyMinutes || {}) };
          const localCounts = state.stats.dailyCounts || {};
          const localMinutes = state.stats.dailyMinutes || {};
          for (const key of Object.keys(localCounts)) {
            mergedDailyCounts[key] = (mergedDailyCounts[key] || 0) + (localCounts[key] || 0);
          }
          for (const key of Object.keys(localMinutes)) {
            mergedDailyMinutes[key] = (mergedDailyMinutes[key] || 0) + (localMinutes[key] || 0);
          }
          const totalSessions = Object.values(mergedDailyCounts).reduce((a, b) => a + b, 0);
          const totalMinutes = Object.values(mergedDailyMinutes).reduce((a, b) => a + b, 0);
          const bestStreak = Math.max(state.stats.bestStreak || 0, cloud.bestStreak || 0);

          await ref.set({
            displayName: state.user.displayName || '',
            photoURL: state.user.photoURL || '',
            totalMinutes,
            totalSessions,
            bestStreak,
            dailyCounts: mergedDailyCounts,
            dailyMinutes: mergedDailyMinutes,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          }, { merge: true });

          // Update local state from merged cloud data and clear local
          // so we don't double-count on next sign-in
          state.stats.dailyCounts = {};
          state.stats.dailyMinutes = {};
          state.stats.totalPomodoros = 0;
          state.stats.bestStreak = 0;
          saveStats();
        } catch {}
      }

      async function pullStatsFromFirestore() {
        if (!state.user) return;
        const uid = state.user.uid;
        try {
          const doc = await fbDb.collection('users').doc(uid).get();
          if (doc.exists) {
            const data = doc.data();
            state.stats.dailyCounts = data.dailyCounts || {};
            state.stats.dailyMinutes = data.dailyMinutes || {};
            state.stats.totalPomodoros = data.totalSessions || 0;
            state.stats.bestStreak = data.bestStreak || 0;
            saveStats();
            updateStats();
          }
        } catch {}
      }

      async function updateFirestoreOnComplete() {
        if (!state.user) return;
        const uid = state.user.uid;
        const ref = fbDb.collection('users').doc(uid);
        const today = todayKey();
        try {
          const doc = await ref.get();
          const cloud = doc.exists ? doc.data() : {};
          const dailyCounts = cloud.dailyCounts || {};
          const dailyMinutes = cloud.dailyMinutes || {};
          dailyCounts[today] = (dailyCounts[today] || 0) + 1;
          dailyMinutes[today] = (dailyMinutes[today] || 0) + state.settings.focusDuration;
          const totalSessions = Object.values(dailyCounts).reduce((a, b) => a + b, 0);
          const totalMinutes = Object.values(dailyMinutes).reduce((a, b) => a + b, 0);
          const bestStreak = Math.max(state.stats.bestStreak || 0, cloud.bestStreak || 0);

          await ref.set({
            displayName: state.user.displayName || '',
            photoURL: state.user.photoURL || '',
            totalMinutes,
            totalSessions,
            bestStreak,
            dailyCounts,
            dailyMinutes,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          }, { merge: true });
        } catch {}
      }

      async function recordSessionData() {
        if (!state.user || state.mode !== 'focus') return;
        const uid = state.user.uid;
        const today = todayKey();

        try {
          // Generate unique session ID
          const sessionId = crypto.randomUUID();

          // Create batch for atomic write
          const batch = fbDb.batch();

          // Session document in subcollection
          const sessionRef = fbDb.collection('users').doc(uid).collection('sessions').doc(sessionId);
          const sessionData = {
            startedAt: new Date(state.sessionStartTime || Date.now() - state.settings.focusDuration * 60 * 1000),
            duration: state.settings.focusDuration,
            projectId: state.activeProjectId || null,
            taskId: state.currentTaskId || null,
            hourOfDay: new Date().getHours(),
            dayOfWeek: new Date().getDay(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          batch.set(sessionRef, sessionData);

          // Aggregate stats update using atomic increments
          const userRef = fbDb.collection('users').doc(uid);
          const userUpdate = {
            [`dailyCounts.${today}`]: firebase.firestore.FieldValue.increment(1),
            [`dailyMinutes.${today}`]: firebase.firestore.FieldValue.increment(state.settings.focusDuration),
            totalSessions: firebase.firestore.FieldValue.increment(1),
            totalMinutes: firebase.firestore.FieldValue.increment(state.settings.focusDuration),
            displayName: state.user.displayName || '',
            photoURL: state.user.photoURL || '',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          };
          batch.set(userRef, userUpdate, { merge: true });

          // Commit atomic batch
          await batch.commit();
        } catch (err) {
          console.error('Failed to record session data:', err);
        }
      }

      async function saveProjectsToFirestore() {
        if (!state.user) return;
        const uid = state.user.uid;
        try {
          await fbDb.collection('users').doc(uid).set({
            projects: state.projects,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        } catch {}
      }

      async function loadProjectsFromFirestore() {
        if (!state.user) return;
        const uid = state.user.uid;
        try {
          const doc = await fbDb.collection('users').doc(uid).get();
          if (doc.exists) {
            const data = doc.data();
            state.projects = data.projects || [];
            saveProjects(); // Cache locally
            renderProjectDropdown(); // Update dropdown when cloud data loads
          }
        } catch {}
      }

      // --- Leaderboard ---
      async function loadLeaderboard() {
        if (!state.user) return;
        try {
          const snap = await fbDb.collection('users')
            .orderBy('totalMinutes', 'desc')
            .limit(10)
            .get();

          leaderboardList.innerHTML = '';
          let currentInTop10 = false;
          let rank = 0;

          snap.forEach((doc) => {
            rank++;
            const d = doc.data();
            const isCurrent = doc.id === state.user.uid;
            if (isCurrent) currentInTop10 = true;
            leaderboardList.appendChild(createLeaderboardRow(rank, d, isCurrent));
          });

          if (rank === 0) {
            const li = document.createElement('li');
            li.className = 'leaderboard-empty';
            li.textContent = 'No data yet. Complete a focus session!';
            leaderboardList.appendChild(li);
            return;
          }

          // If current user not in top 10, find their rank and append
          if (!currentInTop10) {
            const userDoc = await fbDb.collection('users').doc(state.user.uid).get();
            if (userDoc.exists) {
              const userData = userDoc.data();
              const userMinutes = userData.totalMinutes || 0;
              // Count how many users have more minutes
              const countSnap = await fbDb.collection('users')
                .where('totalMinutes', '>', userMinutes)
                .get();
              const userRank = countSnap.size + 1;

              const divider = document.createElement('li');
              divider.className = 'leaderboard-divider';
              divider.setAttribute('aria-hidden', 'true');
              leaderboardList.appendChild(divider);
              leaderboardList.appendChild(createLeaderboardRow(userRank, userData, true));
            }
          }
        } catch {}
      }

      function createLeaderboardRow(rank, data, isCurrent) {
        const li = document.createElement('li');
        li.className = 'leaderboard-row' + (isCurrent ? ' current-user' : '');

        const rankEl = document.createElement('span');
        rankEl.className = 'leaderboard-rank';
        if (rank === 1) rankEl.classList.add('gold');
        else if (rank === 2) rankEl.classList.add('silver');
        else if (rank === 3) rankEl.classList.add('bronze');
        rankEl.textContent = rank;

        const avatar = document.createElement('img');
        avatar.className = 'leaderboard-avatar';
        avatar.src = data.photoURL || '';
        avatar.alt = '';
        avatar.referrerPolicy = 'no-referrer';
        avatar.onerror = function() { this.style.display = 'none'; };

        const name = document.createElement('span');
        name.className = 'leaderboard-name';
        name.textContent = data.displayName || 'Anonymous';

        const mins = document.createElement('span');
        mins.className = 'leaderboard-minutes';
        mins.textContent = (data.totalMinutes || 0) + ' min';

        li.appendChild(rankEl);
        li.appendChild(avatar);
        li.appendChild(name);
        li.appendChild(mins);
        return li;
      }

      function updateThemeIcons() {
        // Theme toggle is now a palette icon â€” no sun/moon toggling needed
      }

      function updateAll() {
        updateTimerDisplay();
        updateProgressRing();
        updateControls();
        updateModeIndicator();
        updateSessionDots();
        updateStats();
        updateDocumentTitle();
        updateThemeIcons();
        updateAuthUI();
      }

      // --- Timer Engine ---
      function tick() {
        if (state.status !== 'running') return;
        const now = Date.now();
        const remaining = Math.round((state.endTime - now) / 1000);
        state.timeRemaining = Math.max(0, remaining);

        updateTimerDisplay();
        updateProgressRing();
        updateDocumentTitle();

        if (state.timeRemaining <= 0) {
          complete();
        }
      }

      function start() {
        if (state.status === 'running') return;
        requestNotificationPermission();

        if (state.status === 'idle') {
          state.totalTime = getDurationForMode(state.mode);
          state.timeRemaining = state.totalTime;

          // Capture session start time and current task for analytics
          state.sessionStartTime = Date.now();
          state.currentTaskId = state.tasks.find(t => !t.completed)?.id || null;
        }

        state.endTime = Date.now() + state.timeRemaining * 1000;
        state.status = 'running';
        state.intervalId = setInterval(tick, 250);

        updateAll();
      }

      function pause() {
        if (state.status !== 'running') return;
        clearInterval(state.intervalId);
        state.intervalId = null;
        // Recalculate exact remaining
        state.timeRemaining = Math.max(0, Math.round((state.endTime - Date.now()) / 1000));
        state.status = 'paused';
        updateAll();
      }

      function reset() {
        clearInterval(state.intervalId);
        state.intervalId = null;
        state.status = 'idle';
        state.totalTime = getDurationForMode(state.mode);
        state.timeRemaining = state.totalTime;
        updateAll();
      }

      function complete() {
        clearInterval(state.intervalId);
        state.intervalId = null;
        state.status = 'idle';
        state.timeRemaining = 0;

        updateTimerDisplay();
        updateProgressRing();

        if (state.mode === 'focus') {
          // Check if first pomodoro of day BEFORE incrementing
          const today = todayKey();
          const isFirstOfDay = !state.stats.dailyCounts[today] || state.stats.dailyCounts[today] === 0;

          // Completed a pomodoro
          state.completedInCycle++;
          state.stats.totalPomodoros++;
          state.stats.dailyCounts[today] = (state.stats.dailyCounts[today] || 0) + 1;
          state.stats.dailyMinutes[today] = (state.stats.dailyMinutes[today] || 0) + state.settings.focusDuration;
          saveStats();

          playChime('focus');
          sendNotification('Pomodoro Complete!', 'Time for a break.');
          recordSessionData().then(() => loadLeaderboard());

          // Show celebration for first pomodoro of the day
          if (isFirstOfDay) {
            showCelebration("You just completed your 1st pomodoro, keep going!");
          }

          // Switch to break
          if (state.completedInCycle >= state.settings.longBreakInterval) {
            switchMode('longbreak');
          } else {
            switchMode('break');
          }
        } else {
          // Break complete
          playChime('break');
          sendNotification('Break Over!', 'Time to focus.');

          if (state.mode === 'longbreak') {
            state.completedInCycle = 0;
          }
          switchMode('focus');
        }

        if (state.settings.autoStart) {
          start();
        } else {
          updateAll();
        }
      }

      function switchMode(newMode) {
        state.mode = newMode;
        state.totalTime = getDurationForMode(newMode);
        state.timeRemaining = state.totalTime;
        state.status = 'idle';
        updateModeIndicator();
      }

      // --- Audio ---
      let bgAudio = null;

      // Ducking state
      let duckingState = {
        originalVolume: null,
        isActive: false,
        restoreTimerId: null,
        fadeAnimationId: null
      };

      function initAudio() {
        bgAudio = document.getElementById('bgAudio');

        // Restore audio settings
        state.audio.volume = state.settings.audioVolume / 100;
        state.audio.currentCategory = state.settings.audioCategory || 'ambient';
        // Fallback if saved category no longer exists or is premium and user lost premium
        if (!AUDIO_STATIONS[state.audio.currentCategory] ||
            (PREMIUM_AUDIO_CATEGORIES.includes(state.audio.currentCategory) && !isPremium())) {
          state.audio.currentCategory = 'ambient';
          state.audio.currentStationIndex = 0;
        }
        state.audio.currentStationIndex = state.settings.audioStationIndex || 0;
        state.audio.isMuted = state.settings.audioMuted || false;

        bgAudio.volume = state.audio.volume;
        bgAudio.muted = state.audio.isMuted;

        // Event listeners
        bgAudio.addEventListener('error', handleAudioError);
        bgAudio.addEventListener('play', () => {
          state.audio.isPlaying = true;
          updateAudioUI();
        });
        bgAudio.addEventListener('pause', () => {
          state.audio.isPlaying = false;
          updateAudioUI();
        });
        bgAudio.addEventListener('ended', () => {
          nextAudioStation();
        });

        // Populate category buttons
        if (audioCategoriesEl) {
          audioCategoriesEl.innerHTML = '';
          for (const [key, label] of Object.entries(AUDIO_CATEGORY_LABELS)) {
            const btn = document.createElement('button');
            btn.className = 'audio-cat-btn' + (key === state.audio.currentCategory ? ' active' : '');
            btn.textContent = label;
            btn.dataset.category = key;
            if (PREMIUM_AUDIO_CATEGORIES.includes(key) && !isPremium()) {
              btn.classList.add('audio-cat-premium');
            }
            btn.addEventListener('click', () => switchAudioCategory(key));
            audioCategoriesEl.appendChild(btn);
          }
        }

        // Set initial volume slider
        if (audioVolumeSliderEl) {
          audioVolumeSliderEl.value = Math.round(state.audio.volume * 100);
        }

        updateAudioUI();
      }

      function handleAudioError(e) {
        const errorCodes = {
          1: 'Playback aborted',
          2: 'Network error',
          3: 'Decoding error',
          4: 'Format not supported'
        };
        const error = bgAudio.error;
        console.error('Audio error:', errorCodes[error?.code] || 'Unknown error');

        if (error?.code === 2) {
          // Network error - notify user
          if (typeof sendNotification === 'function') {
            sendNotification('Stream unavailable', 'Try another station');
          }
        }
      }

      function toggleAudioPlayback() {
        if (!bgAudio) return;

        if (bgAudio.paused) {
          // Set source if not already set
          if (!bgAudio.src) {
            const station = getCurrentAudioStation();
            if (station) {
              bgAudio.src = station.url;
            }
          }
          // Must call play() synchronously from user interaction
          bgAudio.play().catch(err => {
            console.error('Playback failed:', err);
            if (err.name === 'NotAllowedError') {
              console.warn('User interaction required to start audio');
            }
          });
        } else {
          bgAudio.pause();
        }
      }

      function setAudioVolume(value) {
        // Cancel ducking if user changes volume manually
        cancelDucking();

        // value: 0-100
        const normalizedVolume = Math.max(0, Math.min(100, value)) / 100;
        state.audio.volume = normalizedVolume;
        if (bgAudio) {
          bgAudio.volume = normalizedVolume;
        }
        state.settings.audioVolume = value;
        saveSettings();
      }

      function toggleAudioMute() {
        if (!bgAudio) return;
        bgAudio.muted = !bgAudio.muted;
        state.audio.isMuted = bgAudio.muted;
        state.settings.audioMuted = bgAudio.muted;
        saveSettings();
        updateAudioUI();
      }

      function switchAudioCategory(category) {
        if (!AUDIO_STATIONS[category]) {
          console.error('Invalid audio category:', category);
          return;
        }

        // Premium gate for premium categories
        if (PREMIUM_AUDIO_CATEGORIES.includes(category) && !isPremium()) {
          showUpgradePrompt('Premium Audio');
          return;
        }

        const wasPlaying = state.audio.isPlaying;

        state.audio.currentCategory = category;
        state.audio.currentStationIndex = 0;
        state.settings.audioCategory = category;
        state.settings.audioStationIndex = 0;
        saveSettings();

        loadAudioStation();

        if (wasPlaying) {
          bgAudio.play().catch(err => console.error('Failed to play new category:', err));
        }

        updateAudioUI();
      }

      function nextAudioStation() {
        const stations = AUDIO_STATIONS[state.audio.currentCategory];
        if (!stations || stations.length === 0) return;

        state.audio.currentStationIndex = (state.audio.currentStationIndex + 1) % stations.length;
        state.settings.audioStationIndex = state.audio.currentStationIndex;
        saveSettings();

        loadAudioStation();
      }

      function prevAudioStation() {
        const stations = AUDIO_STATIONS[state.audio.currentCategory];
        if (!stations || stations.length === 0) return;

        state.audio.currentStationIndex = (state.audio.currentStationIndex - 1 + stations.length) % stations.length;
        state.settings.audioStationIndex = state.audio.currentStationIndex;
        saveSettings();

        loadAudioStation();
      }

      function loadAudioStation(station) {
        if (!bgAudio) return;

        if (!station) {
          station = getCurrentAudioStation();
        }

        if (!station) {
          console.error('No station to load');
          return;
        }

        const wasPlaying = state.audio.isPlaying;

        bgAudio.src = station.url;

        if (wasPlaying) {
          bgAudio.play().catch(err => console.error('Failed to load station:', err));
        }

        updateAudioUI();
      }

      function getCurrentAudioStation() {
        const stations = AUDIO_STATIONS[state.audio.currentCategory];
        if (!stations || stations.length === 0) return null;

        const index = Math.min(state.audio.currentStationIndex, stations.length - 1);
        return stations[index];
      }

      // --- Audio ducking functions ---
      /**
       * Smoothly transition audio volume over time
       * @param {number} targetVolume - Target volume (0.0 to 1.0)
       * @param {number} durationMs - Fade duration in milliseconds
       */
      function fadeVolumeTo(targetVolume, durationMs) {
        if (!bgAudio || bgAudio.paused) return;

        // Cancel any ongoing fade
        if (duckingState.fadeAnimationId) {
          cancelAnimationFrame(duckingState.fadeAnimationId);
        }

        const startVolume = bgAudio.volume;
        const startTime = performance.now();

        function animate(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / durationMs, 1);

          // Exponential easing (ease-out) for natural sound
          const easedProgress = 1 - Math.pow(2, -10 * progress);

          // Interpolate volume
          const currentVolume = startVolume + (targetVolume - startVolume) * easedProgress;
          bgAudio.volume = Math.max(0, Math.min(1, currentVolume));

          if (progress < 1) {
            duckingState.fadeAnimationId = requestAnimationFrame(animate);
          } else {
            duckingState.fadeAnimationId = null;
          }
        }

        duckingState.fadeAnimationId = requestAnimationFrame(animate);
      }

      /**
       * Duck background audio volume when timer chime plays
       */
      function duckBackgroundAudio() {
        // Skip if audio isn't playing
        if (!bgAudio || bgAudio.paused) return;

        // Skip if already ducking
        if (duckingState.isActive) return;

        // Store original volume
        duckingState.originalVolume = bgAudio.volume;
        duckingState.isActive = true;

        // Duck to 20% of current volume
        const duckedVolume = duckingState.originalVolume * DUCK_RATIO;
        fadeVolumeTo(duckedVolume, DUCK_FADE_DOWN_MS);

        // Schedule restoration after chime completes
        duckingState.restoreTimerId = setTimeout(() => {
          restoreBackgroundAudio();
        }, DUCK_DELAY_MS);
      }

      /**
       * Restore background audio volume after chime finishes
       */
      function restoreBackgroundAudio() {
        if (!duckingState.isActive) return;

        // Restore to original volume
        if (duckingState.originalVolume !== null) {
          fadeVolumeTo(duckingState.originalVolume, DUCK_FADE_UP_MS);
        }

        // Reset state
        duckingState.originalVolume = null;
        duckingState.isActive = false;
        duckingState.restoreTimerId = null;
      }

      /**
       * Cancel ducking if user manually changes volume
       * Call this from volume slider event handler
       */
      function cancelDucking() {
        if (!duckingState.isActive) return;

        // Cancel scheduled restoration
        if (duckingState.restoreTimerId) {
          clearTimeout(duckingState.restoreTimerId);
          duckingState.restoreTimerId = null;
        }

        // Cancel ongoing fade animation
        if (duckingState.fadeAnimationId) {
          cancelAnimationFrame(duckingState.fadeAnimationId);
          duckingState.fadeAnimationId = null;
        }

        // Reset state
        duckingState.originalVolume = null;
        duckingState.isActive = false;
      }

      function updateAudioUI() {
        if (!audioIndicatorEl) return;

        const station = getCurrentAudioStation();

        // Update station name
        if (audioStationNameEl && station) {
          audioStationNameEl.textContent = station.name;
        }

        // Update play/pause icons
        if (audioPlayIconEl && audioPauseIconEl) {
          audioPlayIconEl.style.display = state.audio.isPlaying ? 'none' : '';
          audioPauseIconEl.style.display = state.audio.isPlaying ? '' : 'none';
        }

        // Update playing indicator on collapsed button
        if (state.audio.isPlaying) {
          audioIndicatorEl.classList.add('playing');
        } else {
          audioIndicatorEl.classList.remove('playing');
        }

        // Update active category pill
        if (audioCategoriesEl) {
          const catBtns = audioCategoriesEl.querySelectorAll('.audio-cat-btn');
          catBtns.forEach(btn => {
            if (btn.dataset.category === state.audio.currentCategory) {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
          });
        }

        // Update volume slider
        if (audioVolumeSliderEl) {
          audioVolumeSliderEl.value = Math.round(state.audio.volume * 100);
        }

        // Update mute icons
        if (audioSpeakerIconEl && audioMutedIconEl) {
          audioSpeakerIconEl.style.display = state.audio.isMuted ? 'none' : '';
          audioMutedIconEl.style.display = state.audio.isMuted ? '' : 'none';
        }
      }

      // --- Visibility change (catch-up on tab switch) ---
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && state.status === 'running') {
          tick();
        }
      });

      // --- Event listeners ---
      startBtn.addEventListener('click', start);
      pauseBtn.addEventListener('click', pause);
      resetBtn.addEventListener('click', reset);

      // Mode tabs
      modeTabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          const newMode = tab.dataset.mode;
          if (newMode === state.mode) return;
          clearInterval(state.intervalId);
          state.intervalId = null;
          switchMode(newMode);
          updateAll();
        });
      });

      // Theme selector
      themeToggle.addEventListener('click', () => {
        showThemeSelector();
      });

      closeThemeBtn.addEventListener('click', () => {
        themeDialog.close();
      });

      themeDialog.addEventListener('click', (e) => {
        if (e.target === themeDialog) themeDialog.close();
      });

      // Chime selector
      openChimeSelectorBtn.addEventListener('click', () => {
        showChimeSelector();
      });

      closeChimeBtn.addEventListener('click', () => {
        chimeDialog.close();
      });

      chimeDialog.addEventListener('click', (e) => {
        if (e.target === chimeDialog) chimeDialog.close();
      });

      // CSV export
      openExportBtn.addEventListener('click', () => {
        statsDialog.close();
        showExportDialog();
      });

      closeExportBtn.addEventListener('click', () => {
        exportDialog.close();
      });

      cancelExportBtn.addEventListener('click', () => {
        exportDialog.close();
      });

      exportCsvBtn.addEventListener('click', () => {
        exportSessionsCSV();
      });

      exportDialog.addEventListener('click', (e) => {
        if (e.target === exportDialog) exportDialog.close();
      });

      // Analytics
      analyticsBtn.addEventListener('click', () => {
        openAnalyticsDialog();
      });

      closeAnalyticsBtn.addEventListener('click', () => {
        analyticsDialog.close();
      });

      analyticsDialog.addEventListener('click', (e) => {
        if (e.target === analyticsDialog) analyticsDialog.close();
      });

      // Tab switching
      const analyticsTabButtons = analyticsDialog.querySelectorAll('.analytics-tab');
      analyticsTabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          switchAnalyticsTab(btn.dataset.tabButton);
        });
      });

      // Settings
      settingsBtn.addEventListener('click', () => {
        $('#focusDuration').value = state.settings.focusDuration;
        $('#breakDuration').value = state.settings.breakDuration;
        $('#longBreakDuration').value = state.settings.longBreakDuration;
        $('#longBreakInterval').value = state.settings.longBreakInterval;
        $('#dailyGoalInput').value = state.settings.dailyGoal;
        $('#dailyGoalUnit').value = state.settings.dailyGoalUnit;
        $('#autoStart').checked = state.settings.autoStart;
        $('#soundEnabled').checked = state.settings.soundEnabled;
        updateChimeSettingLabel();
        settingsDialog.showModal();
      });

      closeSettingsBtn.addEventListener('click', () => settingsDialog.close());
      cancelSettingsBtn.addEventListener('click', () => settingsDialog.close());

      settingsForm.addEventListener('submit', (e) => {
        e.preventDefault();
        state.settings.focusDuration = parseInt($('#focusDuration').value) || DEFAULTS.focusDuration;
        state.settings.breakDuration = parseInt($('#breakDuration').value) || DEFAULTS.breakDuration;
        state.settings.longBreakDuration = parseInt($('#longBreakDuration').value) || DEFAULTS.longBreakDuration;
        state.settings.longBreakInterval = parseInt($('#longBreakInterval').value) || DEFAULTS.longBreakInterval;
        state.settings.dailyGoal = parseInt($('#dailyGoalInput').value) || DEFAULTS.dailyGoal;
        state.settings.dailyGoalUnit = $('#dailyGoalUnit').value || DEFAULTS.dailyGoalUnit;
        state.settings.autoStart = $('#autoStart').checked;
        state.settings.soundEnabled = $('#soundEnabled').checked;
        saveSettings();

        // Update session dots count
        const dots = sessionDotsEl.querySelectorAll('.dot');
        const needed = state.settings.longBreakInterval;
        // Add dots if needed
        while (sessionDotsEl.children.length < needed) {
          const dot = document.createElement('div');
          dot.className = 'dot';
          dot.dataset.dot = sessionDotsEl.children.length;
          sessionDotsEl.appendChild(dot);
        }

        // If idle, reset timer to new duration
        if (state.status === 'idle') {
          state.totalTime = getDurationForMode(state.mode);
          state.timeRemaining = state.totalTime;
        }

        settingsDialog.close();
        updateAll();
      });

      // Close dialog on backdrop click
      settingsDialog.addEventListener('click', (e) => {
        if (e.target === settingsDialog) settingsDialog.close();
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Don't trigger shortcuts when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        // Don't trigger when dialog is open (except Escape)
        const anyDialogOpen = settingsDialog.open || pricingPage.open || upgradePrompt.open;
        if (anyDialogOpen && e.key !== 'Escape') return;

        switch (e.key) {
          case ' ':
            e.preventDefault();
            if (state.status === 'running') pause();
            else start();
            break;
          case 'r':
          case 'R':
            e.preventDefault();
            reset();
            break;
          case 'Escape':
            if (pricingPage.open) hidePricingPage();
            else if (upgradePrompt.open) hideUpgradePrompt();
            else if (analyticsDialog.open) analyticsDialog.close();
            else if (exportDialog.open) exportDialog.close();
            else if (chimeDialog.open) chimeDialog.close();
            else if (themeDialog.open) themeDialog.close();
            else if (settingsDialog.open) settingsDialog.close();
            break;
        }
      });

      // --- Stats / Leaderboard dialog buttons ---
      statsBtn.addEventListener('click', openStatsDialog);
      leaderboardBtn.addEventListener('click', openLeaderboardDialog);
      closeStatsBtn.addEventListener('click', () => statsDialog.close());
      closeLeaderboardBtn.addEventListener('click', () => leaderboardDialog.close());
      statsDialog.addEventListener('click', (e) => { if (e.target === statsDialog) statsDialog.close(); });
      leaderboardDialog.addEventListener('click', (e) => { if (e.target === leaderboardDialog) leaderboardDialog.close(); });
      statsDialog.addEventListener('close', () => statsBtn.classList.remove('active'));
      leaderboardDialog.addEventListener('close', () => leaderboardBtn.classList.remove('active'));

      // --- Task event listeners ---
      tasksHeader.addEventListener('click', () => {
        tasksSection.classList.toggle('expanded');
      });

      addTaskBtn.addEventListener('click', addTask);

      taskInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') addTask();
      });

      taskList.addEventListener('click', (e) => {
        const id = e.target.dataset.id;
        if (!id) return;

        if (e.target.classList.contains('task-delete')) {
          deleteTask(id);
        }
      });

      taskList.addEventListener('change', (e) => {
        if (e.target.classList.contains('task-checkbox')) {
          toggleTask(e.target.dataset.id);
        }
      });

      // --- Project event listeners ---
      projectDropdownBtn.addEventListener('click', () => {
        projectDropdownMenu.classList.toggle('open');
      });
      projectDropdownMenu.addEventListener('click', (e) => {
        const opt = e.target.closest('.project-dropdown-option');
        if (!opt) return;
        state.activeProjectId = opt.dataset.value || null;
        renderProjectDropdown();
        renderTasks();
        projectDropdownMenu.classList.remove('open');
      });
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.project-dropdown')) {
          projectDropdownMenu.classList.remove('open');
        }
      });

      document.getElementById('manageProjectsBtn').addEventListener('click', () => {
        if (!requirePremium('Projects')) return;
        renderManageProjectsList();
        manageProjectsDialog.showModal();
      });

      document.getElementById('closeManageProjectsBtn').addEventListener('click', () => manageProjectsDialog.close());
      manageProjectsDialog.querySelector('.dialog-close').addEventListener('click', () => manageProjectsDialog.close());
      manageProjectsDialog.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) manageProjectsDialog.close();
      });

      projectListManage.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        const id = btn.dataset.id;
        if (btn.dataset.action === 'edit') {
          const project = state.projects.find(p => p.id === id);
          if (!project) return;
          projectNameInput.value = project.name;
          projectDialog.querySelector('h2').textContent = 'Rename Project';
          projectDialog.dataset.editId = id;
          projectDialog.showModal();
        } else if (btn.dataset.action === 'delete') {
          deleteProject(id);
        }
      });

      document.getElementById('newProjectBtn').addEventListener('click', () => {
        projectNameInput.value = '';
        projectDialog.querySelector('h2').textContent = 'Create Project';
        delete projectDialog.dataset.editId;
        projectDialog.showModal();
      });

      projectForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = projectNameInput.value.trim();
        if (!name) return;
        if (projectDialog.dataset.editId) {
          renameProject(projectDialog.dataset.editId, name);
          delete projectDialog.dataset.editId;
        } else {
          createProject(name);
        }
        projectDialog.close();
      });

      document.getElementById('projectCancelBtn').addEventListener('click', () => projectDialog.close());
      projectDialog.querySelector('.dialog-close').addEventListener('click', () => projectDialog.close());
      projectDialog.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) projectDialog.close();
      });

      // --- Audio UI event listeners ---
      audioTogglePanelBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        audioIndicatorEl.classList.toggle('expanded');
        state.audio.isExpanded = audioIndicatorEl.classList.contains('expanded');
      });

      audioPlayPauseBtn.addEventListener('click', () => {
        toggleAudioPlayback();
      });

      audioPrevBtn.addEventListener('click', () => {
        prevAudioStation();
      });

      audioNextBtn.addEventListener('click', () => {
        nextAudioStation();
      });

      audioVolumeSliderEl.addEventListener('input', function() {
        setAudioVolume(parseInt(this.value));
      });

      audioMuteBtnEl.addEventListener('click', () => {
        toggleAudioMute();
      });

      // Close audio panel on outside click
      document.addEventListener('click', (e) => {
        if (state.audio.isExpanded && !audioIndicatorEl.contains(e.target)) {
          audioIndicatorEl.classList.remove('expanded');
          state.audio.isExpanded = false;
        }
      });

      // --- Auth event listeners ---
      signInBtn.addEventListener('click', signInWithGoogle);
      authPromptBtn.addEventListener('click', signInWithGoogle);
      userAvatarBtn.addEventListener('click', showUserMenu);

      // Firebase auth state observer
      fbAuth.onAuthStateChanged(async (user) => {
        state.user = user;
        updateAuthUI();
        if (user) {
          listenToSubscription(user.uid);
          if (isNewSignIn) {
            // Only merge local stats on fresh sign-in, not page refresh
            await syncStatsToFirestore();
            isNewSignIn = false;
          }
          // Pull latest data from Firestore
          await pullStatsFromFirestore();
          await loadProjectsFromFirestore();
          updateStats();
          loadLeaderboard();
        } else {
          // Reset subscription state on sign out
          state.subscription = { status: 'none', tier: null, customerId: null, currentPeriodEnd: null, cancelAtPeriodEnd: false, gracePeriod: false };
          localStorage.removeItem('subscriptionStatus');
          updatePremiumUI();
        }
      });

      // --- Init ---
      function init() {
        loadSettings();
        loadStats();
        loadTasks();
        loadProjects();
        renderTasks();
        renderProjectDropdown();

        const theme = loadTheme();
        root.dataset.theme = theme;

        state.mode = 'focus';
        state.totalTime = getDurationForMode('focus');
        state.timeRemaining = state.totalTime;

        initAudio();
        updateChimeSettingLabel();

        updateAll();
        updatePremiumUI();

        // Handle checkout return URLs
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('checkout') === 'success') {
          alert('Payment successful! Premium features are activating...');
          window.history.replaceState({}, '', window.location.pathname);
        } else if (urlParams.get('checkout') === 'canceled') {
          alert('Checkout canceled.');
          window.history.replaceState({}, '', window.location.pathname);
        }

        // Service worker registration
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(() => {});
          });
        }
      }

      init();
    })();
  </script>
</body>
</html>
