---
phase: 02-polish-and-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [index.html, sw.js]
autonomous: false

must_haves:
  truths:
    - "Music volume automatically lowers when timer chime plays"
    - "Music volume smoothly restores after chime finishes"
    - "Ducking does not occur when background audio is paused"
    - "Manual volume change during duck cancels the duck and uses new volume"
    - "Rapid chime triggers do not cause erratic volume behavior"
  artifacts:
    - path: "index.html"
      provides: "Volume ducking functions and playChime integration"
      contains: "duckBackgroundAudio"
    - path: "sw.js"
      provides: "Updated cache version"
      contains: "CACHE_NAME"
  key_links:
    - from: "playChime()"
      to: "duckBackgroundAudio()"
      via: "function call at top of playChime"
      pattern: "duckBackgroundAudio\\(\\)"
    - from: "setAudioVolume()"
      to: "cancelDucking()"
      via: "function call when user changes volume"
      pattern: "cancelDucking\\(\\)"
    - from: "duckBackgroundAudio()"
      to: "bgAudio.volume"
      via: "fadeVolumeTo() with RAF animation"
      pattern: "fadeVolumeTo"
---

<objective>
Implement automatic volume ducking so background music lowers smoothly when timer chime alerts play, then restores afterward.

Purpose: Makes the timer chime clearly audible over background music without requiring the user to manually adjust volume. This is the final requirement (AUDIO-05) for the background audio feature.
Output: Ducking functions integrated into index.html, service worker cache bumped.
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-polish-and-integration/02-RESEARCH.md
@index.html
@sw.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add volume ducking functions and integrate with playChime and setAudioVolume</name>
  <files>index.html, sw.js</files>
  <action>
Add volume ducking to index.html. All new code goes inside the existing IIFE, near the audio functions section (after the existing audio control functions like setAudioVolume, toggleAudioMute, etc.).

**1. Add ducking constants** (near the top of the audio section, after AUDIO_STATIONS):

```javascript
const DUCK_RATIO = 0.2;          // Duck to 20% of current volume
const DUCK_FADE_DOWN_MS = 100;   // Quick fade down when chime starts
const DUCK_FADE_UP_MS = 300;     // Slower fade up after chime ends
const DUCK_DELAY_MS = 800;       // Restore after chime completes (chime is 0.7s + buffer)
```

**2. Add ducking state** (near `let bgAudio = null;`):

```javascript
let duckingState = {
  originalVolume: null,
  isActive: false,
  restoreTimerId: null,
  fadeAnimationId: null
};
```

**3. Add fadeVolumeTo function:**
- Uses requestAnimationFrame for smooth volume transitions (not instant jumps)
- Exponential easing: `1 - Math.pow(2, -10 * progress)` for natural sound perception
- Cancels any ongoing fade before starting a new one
- Clamps volume to 0.0-1.0 range
- Guards against bgAudio being null or paused

**4. Add duckBackgroundAudio function:**
- Guards: return early if bgAudio is null, paused, or already ducking
- Stores original volume in duckingState
- Calls fadeVolumeTo() to duck to DUCK_RATIO of current volume over DUCK_FADE_DOWN_MS
- Schedules restoreBackgroundAudio() via setTimeout after DUCK_DELAY_MS

**5. Add restoreBackgroundAudio function:**
- Guards: return early if not currently ducking
- Calls fadeVolumeTo() to restore to original volume over DUCK_FADE_UP_MS
- Resets duckingState (originalVolume = null, isActive = false, restoreTimerId = null)

**6. Add cancelDucking function:**
- Guards: return early if not currently ducking
- Clears the restore timeout (clearTimeout)
- Cancels any ongoing fade animation (cancelAnimationFrame)
- Resets duckingState completely

**7. Integrate with playChime()** (line ~2164):
- Add `duckBackgroundAudio();` as the FIRST line inside playChime(), AFTER the soundEnabled check
- Do NOT modify the existing chime generation code

**8. Integrate with setAudioVolume()** (line ~2948):
- Add `cancelDucking();` at the start of the function, before modifying volume
- This ensures manual volume changes override any active ducking

**9. Bump service worker cache version in sw.js:**
- Find the current CACHE_NAME value and increment the version number by 1

Use the EXACT patterns from the research (Pattern 3: Smooth Volume Fade with RAF). Follow the complete ducking implementation from 02-RESEARCH.md.
  </action>
  <verify>
1. Open index.html in browser, verify no console errors on load
2. Grep index.html for "duckBackgroundAudio" -- should appear in function definition AND inside playChime()
3. Grep index.html for "cancelDucking" -- should appear in function definition AND inside setAudioVolume()
4. Grep index.html for "fadeVolumeTo" -- should appear in function definition
5. Grep index.html for "DUCK_RATIO" -- should appear as constant
6. Grep sw.js for updated CACHE_NAME version
  </verify>
  <done>
- duckBackgroundAudio(), restoreBackgroundAudio(), fadeVolumeTo(), and cancelDucking() functions exist in index.html
- playChime() calls duckBackgroundAudio() after soundEnabled check
- setAudioVolume() calls cancelDucking() before setting volume
- DUCK_RATIO, DUCK_FADE_DOWN_MS, DUCK_FADE_UP_MS, DUCK_DELAY_MS constants defined
- duckingState object tracks active ducking state
- Service worker cache version incremented
- No console errors on page load
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify volume ducking behavior</name>
  <what-built>Automatic volume ducking during timer chime alerts. When a chime plays (focus or break timer completes), background music volume smoothly ducks to 20% then restores after the chime finishes.</what-built>
  <how-to-verify>
1. Open the app in your browser (localhost or file://)
2. Start playing background audio (click audio indicator, select a category, hit play)
3. Set audio volume to a noticeable level
4. Start a focus timer and let it complete (or set a very short duration like 1 minute)
5. When the chime plays, observe: music should noticeably drop in volume, then smoothly return after the chime finishes
6. Test: pause background audio, trigger a chime -- volume should NOT change
7. Test: while music is ducked (during a chime), drag the volume slider -- ducking should cancel and use the new volume
8. Verify both focus and break chimes trigger ducking
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- AUDIO-05 requirement met: Music volume ducks automatically during timer chime alerts
- No regression in existing audio controls (play, pause, volume, mute, category switching)
- No regression in timer chime sounds (still plays correctly)
- Ducking handles edge cases: paused audio, rapid chimes, manual volume changes during duck
</verification>

<success_criteria>
- Background music volume visibly/audibly ducks when timer chime plays
- Volume restores smoothly after chime completes
- No audio artifacts, clicks, or erratic volume behavior
- User approves the behavior at checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/02-polish-and-integration/02-01-SUMMARY.md`
</output>
