---
phase: 04-data-foundation-and-projects
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified: [index.html, sw.js]
autonomous: false

must_haves:
  truths:
    - "Premium user can create a project via dialog and it appears in the dropdown"
    - "Premium user can rename and delete projects"
    - "Premium user can select active project from dropdown before starting a session"
    - "New tasks are auto-assigned to the active project"
    - "Premium user can filter task list by selecting a project"
    - "Free user sees upgrade prompt when attempting project actions"
    - "Completed focus session is attributed to selected project (recorded in session data)"
  artifacts:
    - path: "index.html"
      provides: "Project dialog HTML, project dropdown, project management functions"
      contains: "projectDialog"
    - path: "index.html"
      provides: "Task filtering by project, project assignment"
      contains: "activeProjectId"
  key_links:
    - from: "project dropdown (select#projectSelect)"
      to: "state.activeProjectId"
      via: "change event listener"
      pattern: "projectSelect.*addEventListener.*change"
    - from: "addTask()"
      to: "task.projectId"
      via: "state.activeProjectId assignment"
      pattern: "projectId.*activeProjectId"
    - from: "renderTasks()"
      to: "filtered task display"
      via: "filter by state.activeProjectId"
      pattern: "filter.*projectId.*activeProjectId"
    - from: "createProject()"
      to: "requirePremium('Projects')"
      via: "feature gate check"
      pattern: "requirePremium.*Projects"
---

<objective>
Add project management UI and integrate projects with the task system -- premium users can create projects, assign tasks, select active project, and filter their task list by project.

Purpose: PROJ-01 through PROJ-05 -- complete project-based task organization for premium users.
Output: Project dialog, dropdown selector, task-project assignment, task filtering, all gated behind premium.
</objective>

<execution_context>
@/Users/user/.claude/agents/gsd-executor.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-data-foundation-and-projects/04-RESEARCH.md
@.planning/phases/04-data-foundation-and-projects/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project dialog HTML, dropdown UI, and CSS</name>
  <files>index.html</files>
  <action>
    1. Add project management `<dialog>` element AFTER the existing `upgrade-prompt` dialog (line ~2105). Structure:
       ```html
       <dialog id="projectDialog" aria-labelledby="projectDialogTitle">
         <div class="dialog-header">
           <h2 id="projectDialogTitle">Create Project</h2>
           <button class="dialog-close" aria-label="Close">&times;</button>
         </div>
         <form id="projectForm">
           <label class="settings-label">
             Project Name
             <input type="text" id="projectNameInput" required minlength="1" maxlength="50" autocomplete="off" placeholder="e.g., Work, Side Project">
           </label>
           <div class="dialog-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
             <button type="button" class="btn" id="projectCancelBtn">Cancel</button>
             <button type="submit" class="btn btn-primary">Save</button>
           </div>
         </form>
       </dialog>
       ```

    2. Add a "Manage Projects" dialog for listing/editing/deleting projects:
       ```html
       <dialog id="manageProjectsDialog" aria-labelledby="manageProjectsTitle">
         <div class="dialog-header">
           <h2 id="manageProjectsTitle">Manage Projects</h2>
           <button class="dialog-close" aria-label="Close">&times;</button>
         </div>
         <ul id="projectListManage" class="task-list" style="margin:0 0 16px;max-height:300px;overflow-y:auto;"></ul>
         <div class="dialog-actions" style="display:flex;gap:8px;justify-content:flex-end;">
           <button class="btn btn-primary" id="newProjectBtn">New Project</button>
           <button class="btn" id="closeManageProjectsBtn">Done</button>
         </div>
       </dialog>
       ```

    3. Add project selector UI INSIDE the tasks section. Place it between the `tasks-header` div and the `tasks-body` div (around line 1801). Structure:
       ```html
       <div class="project-bar" id="projectBar" style="display:none;">
         <select id="projectSelect" aria-label="Filter by project">
           <option value="">All Tasks</option>
         </select>
         <button class="btn-icon" id="manageProjectsBtn" aria-label="Manage projects" title="Manage projects">
           <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
         </button>
       </div>
       ```
       The project bar is hidden by default and shown only for premium users via `updatePremiumUI()`.

    4. Add CSS for the project bar and dialog. Place in the existing `<style>` section near the task styles. Keep it minimal:
       ```css
       .project-bar {
         display: flex;
         align-items: center;
         gap: 8px;
         padding: 8px 16px;
         border-bottom: 1px solid var(--border);
       }
       .project-bar select {
         flex: 1;
         padding: 6px 8px;
         border-radius: 6px;
         border: 1px solid var(--border);
         background: var(--bg-secondary);
         color: var(--text-primary);
         font-size: 0.85rem;
       }
       .btn-icon {
         background: none;
         border: none;
         color: var(--text-secondary);
         cursor: pointer;
         padding: 4px;
         border-radius: 4px;
         display: flex;
         align-items: center;
       }
       .btn-icon:hover {
         background: var(--bg-secondary);
         color: var(--text-primary);
       }
       .project-item {
         display: flex;
         align-items: center;
         gap: 8px;
         padding: 8px 0;
       }
       .project-item .project-name {
         flex: 1;
         font-size: 0.9rem;
       }
       .project-item .btn-icon {
         opacity: 0.6;
       }
       .project-item .btn-icon:hover {
         opacity: 1;
       }
       ```

    5. In the `updatePremiumUI()` function, add logic to show/hide the project bar:
       ```javascript
       const projectBar = document.getElementById('projectBar');
       if (projectBar) {
         projectBar.style.display = premium ? '' : 'none';
       }
       ```
  </action>
  <verify>
    Search index.html for `projectDialog` -- dialog element must exist.
    Search for `manageProjectsDialog` -- manage dialog must exist.
    Search for `projectSelect` -- dropdown must exist.
    Search for `projectBar` -- container must exist with `display:none` default.
    Search for `project-bar` in CSS section.
    Search for `projectBar` in `updatePremiumUI` function.
  </verify>
  <done>
    Project creation dialog with form exists.
    Manage projects dialog with list exists.
    Project dropdown selector inside tasks section exists.
    Project bar hidden for free users, shown for premium.
    CSS styles for project UI match existing app theme.
  </done>
</task>

<task type="auto">
  <name>Task 2: Project management JS, task integration, and filtering</name>
  <files>index.html, sw.js</files>
  <action>
    1. Add DOM references near existing element references (line ~2250 area):
       ```javascript
       const projectDialog = $('#projectDialog');
       const projectForm = $('#projectForm');
       const projectNameInput = $('#projectNameInput');
       const projectSelect = $('#projectSelect');
       const manageProjectsDialog = $('#manageProjectsDialog');
       const projectListManage = $('#projectListManage');
       ```

    2. Create project management functions (place near the task functions section):

       `renderProjectDropdown()`:
       - Clear projectSelect, add "All Tasks" option (value="")
       - Sort `state.projects` alphabetically by name
       - For each project, create an `<option>` with value=project.id, text=project.name
       - Set `selected` on option matching `state.activeProjectId`

       `renderManageProjectsList()`:
       - Clear projectListManage
       - If no projects, show "No projects yet" message
       - For each project, create an `<li class="project-item">` with:
         - `<span class="project-name">${project.name}</span>`
         - Edit button (pencil icon SVG) with `data-id="${project.id}"`
         - Delete button (trash icon SVG) with `data-id="${project.id}"`

       `createProject(name)`:
       - Guard: `if (!requirePremium('Projects')) return;`
       - Guard: `if (state.projects.length >= 100) { alert('Maximum 100 projects'); return; }`
       - Push `{ id: crypto.randomUUID(), name: name.trim(), createdAt: Date.now() }` to `state.projects`
       - Call `saveProjects()` (localStorage) and `saveProjectsToFirestore()`
       - Call `renderProjectDropdown()` and `renderManageProjectsList()`

       `renameProject(projectId, newName)`:
       - Guard: `if (!requirePremium('Projects')) return;`
       - Find project in `state.projects`, update name
       - Call `saveProjects()` and `saveProjectsToFirestore()`
       - Call `renderProjectDropdown()` and `renderManageProjectsList()`

       `deleteProject(projectId)`:
       - Guard: `if (!requirePremium('Projects')) return;`
       - Confirm with user: `if (!confirm('Delete this project? Tasks will be unassigned.')) return;`
       - Unassign tasks: `state.tasks.forEach(t => { if (t.projectId === projectId) t.projectId = null; })`
       - Remove from array: `state.projects = state.projects.filter(p => p.id !== projectId)`
       - If `state.activeProjectId === projectId`, set to null
       - Call `saveProjects()`, `saveTasks()`, `saveProjectsToFirestore()`
       - Call `renderProjectDropdown()`, `renderTasks()`, `renderManageProjectsList()`

    3. Modify existing `addTask()` function (line ~2396):
       - Add `projectId` field to the task object: `projectId: state.activeProjectId || null`
       - This auto-assigns new tasks to the currently selected project

    4. Modify existing `renderTasks()` function (line ~2425):
       - Before rendering, filter if premium user has active project:
         ```javascript
         let tasksToShow = state.tasks;
         if (isPremium() && state.activeProjectId) {
           tasksToShow = state.tasks.filter(t => t.projectId === state.activeProjectId);
         }
         ```
       - Update taskCount to show filtered count: `taskCount.textContent = tasksToShow.filter(t => !t.completed).length;`
       - Use `tasksToShow` instead of `state.tasks` for the sorted/render loop
       - Add project badge to each task item if task has a projectId and no active filter:
         ```javascript
         const project = task.projectId ? state.projects.find(p => p.id === task.projectId) : null;
         const projectLabel = (project && !state.activeProjectId) ? `<span class="task-project-badge">${project.name.replace(/</g, '&lt;')}</span>` : '';
         ```
         Include `${projectLabel}` in the li innerHTML after the task-text span.

    5. Add CSS for the project badge on tasks:
       ```css
       .task-project-badge {
         font-size: 0.7rem;
         padding: 1px 6px;
         border-radius: 4px;
         background: var(--bg-secondary);
         color: var(--text-secondary);
         white-space: nowrap;
       }
       ```

    6. Register event listeners at the bottom of the IIFE (near existing task event listeners, line ~3838):

       Project dropdown change:
       ```javascript
       projectSelect.addEventListener('change', (e) => {
         state.activeProjectId = e.target.value || null;
         renderTasks();
       });
       ```

       Manage projects button:
       ```javascript
       document.getElementById('manageProjectsBtn').addEventListener('click', () => {
         if (!requirePremium('Projects')) return;
         renderManageProjectsList();
         manageProjectsDialog.showModal();
       });
       ```

       Manage projects dialog close/done:
       ```javascript
       document.getElementById('closeManageProjectsBtn').addEventListener('click', () => manageProjectsDialog.close());
       manageProjectsDialog.querySelector('.dialog-close').addEventListener('click', () => manageProjectsDialog.close());
       manageProjectsDialog.addEventListener('click', (e) => {
         if (e.target === e.currentTarget) manageProjectsDialog.close();
       });
       ```

       Manage projects list delegation (edit + delete):
       ```javascript
       projectListManage.addEventListener('click', (e) => {
         const btn = e.target.closest('[data-action]');
         if (!btn) return;
         const id = btn.dataset.id;
         if (btn.dataset.action === 'edit') {
           const project = state.projects.find(p => p.id === id);
           if (!project) return;
           projectNameInput.value = project.name;
           projectDialog.querySelector('h2').textContent = 'Rename Project';
           projectDialog.dataset.editId = id;
           projectDialog.showModal();
         } else if (btn.dataset.action === 'delete') {
           deleteProject(id);
         }
       });
       ```

       New project button:
       ```javascript
       document.getElementById('newProjectBtn').addEventListener('click', () => {
         projectNameInput.value = '';
         projectDialog.querySelector('h2').textContent = 'Create Project';
         delete projectDialog.dataset.editId;
         projectDialog.showModal();
       });
       ```

       Project dialog form submit:
       ```javascript
       projectForm.addEventListener('submit', (e) => {
         e.preventDefault();
         const name = projectNameInput.value.trim();
         if (!name) return;
         if (projectDialog.dataset.editId) {
           renameProject(projectDialog.dataset.editId, name);
           delete projectDialog.dataset.editId;
         } else {
           createProject(name);
         }
         projectDialog.close();
       });
       ```

       Project dialog cancel/close:
       ```javascript
       document.getElementById('projectCancelBtn').addEventListener('click', () => projectDialog.close());
       projectDialog.querySelector('.dialog-close').addEventListener('click', () => projectDialog.close());
       projectDialog.addEventListener('click', (e) => {
         if (e.target === e.currentTarget) projectDialog.close();
       });
       ```

    7. Call `renderProjectDropdown()` in the `init()` function, after `loadProjects()` and `renderTasks()`.

    8. Also call `renderProjectDropdown()` inside `loadProjectsFromFirestore()` after setting state.projects (so dropdown updates when user signs in and cloud data loads).

    9. Bump `CACHE_NAME` in sw.js from `'pomodoro-v40'` to `'pomodoro-v41'`.

    IMPORTANT: Use addEventListener for ALL event bindings (not inline onclick). This is a locked decision from Phase 3 -- the IIFE scoping prevents inline handlers from working.

    IMPORTANT: All project CRUD functions must call `requirePremium('Projects')` as first line. This triggers the upgrade prompt for free users.
  </action>
  <verify>
    Search for `createProject`, `renameProject`, `deleteProject` functions -- all must exist with `requirePremium('Projects')`.
    Search for `renderProjectDropdown` -- must exist and be called in init.
    Search for `projectId.*activeProjectId` in addTask -- tasks must get project assignment.
    Search for `filter.*projectId` in renderTasks -- filtering must work.
    Search for `task-project-badge` -- CSS must exist.
    Search for `projectSelect.*addEventListener` -- dropdown wired.
    Verify sw.js has `pomodoro-v41`.
    Verify no inline onclick handlers on any project UI elements.
  </verify>
  <done>
    Premium users can create/rename/delete projects via dialogs.
    Project dropdown selector visible for premium users in tasks section.
    New tasks auto-assigned to active project.
    Task list filters by selected project.
    Task items show project badge when not filtering.
    Free users get upgrade prompt on any project action.
    All event listeners use addEventListener (no inline onclick).
    Service worker cache bumped.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete project management system with session data recording. Premium users can create projects, assign tasks, filter by project, and all focus sessions record granular data to Firestore.</what-built>
  <how-to-verify>
    1. Open the app in browser (or run with local server)
    2. Verify the task section does NOT show a project dropdown when not signed in or when free user
    3. If you can simulate premium status (set localStorage subscriptionStatus to 'active'):
       a. Refresh -- project dropdown should appear above the task list
       b. Click the 3-dot menu next to the dropdown -- "Manage Projects" dialog opens
       c. Click "New Project" -- create dialog appears with name input
       d. Create a project named "Work" -- it appears in the dropdown
       e. Select "Work" in dropdown -- task list filters (shows only Work tasks, or empty)
       f. Add a task while "Work" is selected -- the task should be assigned to Work project
       g. Switch dropdown to "All Tasks" -- all tasks visible, Work tasks show "Work" badge
       h. In Manage Projects, click edit on "Work" -- rename it
       i. In Manage Projects, click delete -- confirms, removes project
    4. Check browser console for no errors
    5. If Firestore is connected: complete a focus session and verify session subcollection document was created (check Firebase Console > Firestore > users/{uid}/sessions)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Project CRUD: create, rename, delete all work for premium users with `requirePremium` gate
2. Project dropdown appears only for premium users, filters task list correctly
3. New tasks get `projectId` from `state.activeProjectId`
4. Task rendering shows project badge when not filtering by project
5. Session recording writes to `users/{uid}/sessions/{sessionId}` subcollection
6. Aggregate stats still update atomically (FieldValue.increment in batch)
7. Free users see upgrade prompt on project actions
8. All event listeners use addEventListener (no inline onclick)
9. Both dialogs dismiss via close button, ESC key, and backdrop click
</verification>

<success_criteria>
- Premium user can create a project and see it in the dropdown (PROJ-01)
- Tasks can be assigned to projects (PROJ-02)
- Active project can be selected before starting a focus session (PROJ-03)
- Focus session records include projectId attribution (PROJ-04)
- Task list can be filtered by project (PROJ-05)
- Free users get upgrade prompt, not broken UI
- No regressions in existing task or timer functionality
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-foundation-and-projects/04-02-SUMMARY.md`
</output>
