---
phase: 07-integrations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/src/todoist/oauth-init.ts
  - functions/src/todoist/oauth-callback.ts
  - functions/src/todoist/import-tasks.ts
  - functions/src/index.ts
  - index.html
autonomous: false
requirements:
  - INTG-01
user_setup:
  - service: todoist
    why: "OAuth integration for task import"
    env_vars:
      - name: TODOIST_CLIENT_ID
        source: "Todoist App Management Console (https://developer.todoist.com/appconsole.html) -> Create App -> Client ID"
      - name: TODOIST_CLIENT_SECRET
        source: "Todoist App Management Console -> Create App -> Client Secret"
      - name: TODOIST_REDIRECT_URI
        source: "Set to your Cloud Function URL: https://{region}-{project}.cloudfunctions.net/todoistOauthCallback — also register this exact URL in the Todoist app's OAuth Redirect URL field"
must_haves:
  truths:
    - "Premium user can click 'Connect Todoist' and authenticate via OAuth popup"
    - "After OAuth, the app shows Todoist as connected in settings"
    - "Premium user can import selected Todoist tasks into the app's task list"
    - "Imported tasks appear in the task list and can be used for focus sessions"
  artifacts:
    - path: "functions/src/todoist/oauth-init.ts"
      provides: "Todoist OAuth URL generation with CSRF state"
      exports: ["todoistOauthInit"]
    - path: "functions/src/todoist/oauth-callback.ts"
      provides: "Todoist OAuth redirect handler and token exchange"
      exports: ["todoistOauthCallback"]
    - path: "functions/src/todoist/import-tasks.ts"
      provides: "Todoist task fetching via stored token"
      exports: ["importTodoistTasks"]
    - path: "functions/src/index.ts"
      provides: "Re-exports all Todoist Cloud Functions"
    - path: "index.html"
      provides: "Todoist connect button, import dialog, and client-side integration logic"
  key_links:
    - from: "index.html"
      to: "todoistOauthInit Cloud Function"
      via: "fbFunctions.httpsCallable('todoistOauthInit')"
      pattern: "httpsCallable.*todoistOauthInit"
    - from: "todoistOauthCallback"
      to: "Firestore users/{uid}"
      via: "stores todoistToken after token exchange"
      pattern: "todoistToken"
    - from: "index.html"
      to: "importTodoistTasks Cloud Function"
      via: "fbFunctions.httpsCallable('importTodoistTasks')"
      pattern: "httpsCallable.*importTodoistTasks"
---

<objective>
Implement Todoist OAuth integration with Cloud Function proxy for secure token exchange and client-side task import UI.

Purpose: Enable premium users to connect their Todoist account and import tasks into the Pomodoro app, bridging their existing task management workflow with focused work sessions.
Output: Three Cloud Functions (oauth-init, oauth-callback, import-tasks) and client-side UI (connect button in settings, import dialog with task selection).
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-integrations/07-RESEARCH.md
@functions/src/index.ts
@functions/src/stripe/checkout.ts (reference for onCall pattern)
@functions/src/stripe/webhooks.ts (reference for onRequest pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Todoist Cloud Functions (OAuth init, callback, import)</name>
  <files>
    functions/src/todoist/oauth-init.ts
    functions/src/todoist/oauth-callback.ts
    functions/src/todoist/import-tasks.ts
    functions/src/index.ts
  </files>
  <action>
Create three Cloud Functions in `functions/src/todoist/` directory following existing patterns from `functions/src/stripe/`:

**oauth-init.ts** — `onCall` function:
- Guard: reject unauthenticated requests with HttpsError (same pattern as stripe/checkout.ts)
- Generate CSRF state via `crypto.randomUUID()`
- Store state in `todoistOAuthStates/{state}` Firestore doc with `{ uid, createdAt, expiresAt }` (10-min TTL)
- Use `defineSecret` for TODOIST_CLIENT_ID (firebase-functions/params pattern, see 07-RESEARCH.md code example)
- Return `{ url }` with Todoist authorize URL: `https://api.todoist.com/oauth/authorize?client_id=...&scope=data:read&state=...`
- Declare `secrets: [TODOIST_CLIENT_ID]` in function options

**oauth-callback.ts** — `onRequest` function:
- Extract `code` and `state` from query params
- Validate state against `todoistOAuthStates/{state}` Firestore doc — if missing, redirect to `https://pomodorotimer.vip/?todoist=error&reason=invalid_state`
- Check expiry — if expired, redirect with `reason=expired`
- Delete state doc after validation (one-time use)
- Exchange code for token via POST to `https://api.todoist.com/oauth/access_token` with `client_id`, `client_secret`, `code` (use native `fetch`, no npm dep)
- Store `{ todoistToken: access_token, todoistConnectedAt: new Date() }` in `users/{uid}` doc (merge: true)
- Use `defineSecret` for TODOIST_CLIENT_ID, TODOIST_CLIENT_SECRET
- Redirect to `https://pomodorotimer.vip/?todoist=success`

**import-tasks.ts** — `onCall` function:
- Guard: reject unauthenticated
- Read `todoistToken` from `users/{uid}` doc — if missing, throw HttpsError('failed-precondition', 'Todoist not connected')
- Fetch tasks from `https://api.todoist.com/api/v1/tasks` with Bearer token (use native `fetch`)
- If HTTP 401 from Todoist: clear the stored token, throw HttpsError telling client to reconnect
- Return `{ tasks: [{ id, content, projectName }] }` — map task objects to only needed fields
- Use `defineSecret` for TODOIST_CLIENT_ID (not strictly needed here but consistent)

**index.ts** — Add re-exports:
```typescript
export { todoistOauthInit } from './todoist/oauth-init.js';
export { todoistOauthCallback } from './todoist/oauth-callback.js';
export { importTodoistTasks } from './todoist/import-tasks.js';
```

Follow existing conventions: lazy-initialized services via getDb() helper from utils if available, otherwise inline. TypeScript strict. No new npm dependencies.
  </action>
  <verify>
Run `cd functions && npx tsc --noEmit` to verify TypeScript compiles without errors. Verify all three functions are exported from index.ts.
  </verify>
  <done>Three Todoist Cloud Functions compile cleanly and are exported from index.ts. OAuth init returns authorize URL, callback exchanges code for token and stores in Firestore, import fetches tasks from Todoist API v1.</done>
</task>

<task type="auto">
  <name>Task 2: Add Todoist connect UI and import dialog to client</name>
  <files>index.html</files>
  <action>
Add Todoist integration UI to `index.html` inside the existing IIFE:

**Settings section — Todoist connect button:**
- Add a "Todoist" section in settings (or a new "Integrations" section within settings dialog) with:
  - "Connect Todoist" button (shown when not connected)
  - "Todoist Connected ✓" status + "Disconnect" button (shown when connected)
- On page load with `?todoist=success` URL param: re-fetch user doc from Firestore, update `state.todoistConnected = true`, show success toast, clean URL via `history.replaceState`
- On `?todoist=error` param: show error toast with reason, clean URL
- Guard with `requirePremium('Todoist Integration')` on connect button click

**Connect flow (popup pattern from research — critical for browser compatibility):**
```javascript
async function connectTodoist() {
  if (!requirePremium('Todoist Integration')) return;
  const popup = window.open('', 'todoist_oauth', 'width=600,height=700'); // SYNC - must be in click handler
  try {
    const result = await fbFunctions.httpsCallable('todoistOauthInit')();
    popup.location.href = result.data.url;
  } catch {
    popup.close();
    // show error
  }
}
```
- Important: `window.open()` MUST be called synchronously in click handler (not after await) to avoid popup blocker

**Import dialog:**
- Create a `<dialog id="todoist-import-dialog">` with:
  - Loading state while fetching tasks
  - Checkbox list of Todoist tasks (task content as label)
  - "Import Selected" button and "Cancel" button
- On "Import Selected": push selected tasks into `state.tasks` array with `{ id: crypto.randomUUID(), title: task.content, completed: false }`, call `saveTasks()` and `renderTasks()`
- Add "Import from Todoist" button in task list header area (visible only when `state.todoistConnected`)

**State extensions:**
- Add `state.todoistConnected = false` to state initialization
- In `loadUserIntegrationSettings()` (called on auth state change): check `todoistConnectedAt` field on user doc to set `state.todoistConnected`
- Update `updatePremiumUI()` or create `updateIntegrationUI()` to show/hide Todoist-related UI based on connection state

**Disconnect flow:**
- On disconnect: set `todoistToken` and `todoistConnectedAt` to `null` in user doc (merge: true), set `state.todoistConnected = false`, update UI

**CSS:**
- Style the Todoist connect section consistent with existing settings dialog patterns
- Import dialog uses same `<dialog>` pattern as other dialogs (backdrop click to dismiss, close button)

Bump service worker cache version in `sw.js`.
  </action>
  <verify>
Open the app in browser. Verify:
1. Todoist section appears in settings for premium users
2. "Connect Todoist" button is visible when not connected
3. Clicking connect opens a popup (will fail without Todoist credentials but the popup should open)
4. URL param handling works (manually add ?todoist=success to URL)
  </verify>
  <done>Todoist connect button and import dialog are functional in the client. Premium users see integration controls in settings. Connect opens OAuth popup (synchronous window.open pattern). Import dialog shows task list with checkboxes for selective import.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Todoist integration end-to-end</name>
  <files>index.html, functions/src/todoist/oauth-init.ts, functions/src/todoist/oauth-callback.ts, functions/src/todoist/import-tasks.ts</files>
  <action>
Human verification of Todoist OAuth Cloud Functions and client-side connect/import UI.

What was built: Todoist OAuth Cloud Functions (oauth-init, oauth-callback, import-tasks) and client-side connect button, import dialog with task selection.

Steps to verify:
1. Open https://pomodorotimer.vip (or local dev) as a premium user
2. Go to Settings → find the Todoist/Integrations section
3. Click "Connect Todoist" — verify a popup opens (it will show an error unless Todoist app credentials are configured, but the popup opening confirms the flow works)
4. Verify "Import from Todoist" button is hidden when not connected
5. Check that non-premium users see upgrade prompt when clicking connect
6. Review the Cloud Functions code in functions/src/todoist/ for correctness
  </action>
  <verify>Visual and functional verification by user</verify>
  <done>User approves the Todoist integration UI and Cloud Function code</done>
</task>

</tasks>

<verification>
- TypeScript compiles: `cd functions && npx tsc --noEmit`
- Cloud Functions export correctly from index.ts
- Todoist UI elements render in settings dialog for premium users
- OAuth popup opens on connect click (sync window.open pattern)
- Import dialog has task selection checkboxes and import button
- Premium gating works on all Todoist features
- Service worker cache version bumped
</verification>

<success_criteria>
- Three Todoist Cloud Functions (oauth-init, oauth-callback, import-tasks) compile and export
- Client shows Todoist connect/disconnect UI in settings
- OAuth popup flow initiates correctly (blocked by credential setup but pattern is correct)
- Import dialog allows task selection and adds to app task list
- URL param handling for todoist=success/error works
- All Todoist features gated behind premium
</success_criteria>

<output>
After completion, create `.planning/phases/07-integrations/07-01-SUMMARY.md`
</output>
