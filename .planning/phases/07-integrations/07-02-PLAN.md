---
phase: 07-integrations
plan: 02
type: execute
wave: 2
depends_on:
  - 07-01
files_modified:
  - index.html
  - sw.js
autonomous: false
requirements:
  - INTG-02
  - INTG-03
  - EXPT-02
must_haves:
  truths:
    - "Premium user can enter a webhook URL in settings and save it"
    - "After completing a focus session, the app fires a POST to the saved webhook URL with session data"
    - "Premium user can click 'Send Test' to fire a sample webhook payload"
    - "Premium user can click 'Export PDF' in analytics and download a formatted productivity report"
    - "Webhook failures never block or delay session completion"
  artifacts:
    - path: "index.html"
      provides: "Webhook settings UI, fireWebhook function, test webhook button, jsPDF CDN load, exportProductivityReport function, PDF export button in analytics"
      contains: "fireWebhook"
    - path: "index.html"
      provides: "jsPDF CDN script tag"
      contains: "jspdf"
  key_links:
    - from: "recordSessionData (index.html)"
      to: "fireWebhook function"
      via: "called after batch.commit() completes"
      pattern: "fireWebhook"
    - from: "Export PDF button (analytics dialog)"
      to: "exportProductivityReport function"
      via: "click event listener"
      pattern: "exportProductivityReport"
    - from: "index.html"
      to: "jsPDF CDN"
      via: "script tag in head"
      pattern: "cdnjs.cloudflare.com/ajax/libs/jspdf"
---

<objective>
Implement user-configurable outbound webhooks for session completion notifications and client-side PDF productivity report export.

Purpose: Complete the integrations phase by giving power users automation capability (webhooks for tools like Zapier/Make) and a polished report export (PDF) for sharing or archiving.
Output: Webhook URL settings with test button, automatic webhook firing on session completion, jsPDF-powered PDF report generation with download.
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-integrations/07-RESEARCH.md
@.planning/phases/07-integrations/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Webhook configuration UI and outbound webhook firing</name>
  <files>index.html</files>
  <action>
Add webhook integration to `index.html` inside the existing IIFE:

**Webhook settings UI (in the Integrations section created by plan 01, or settings dialog):**
- URL input field with placeholder "https://hooks.zapier.com/..." or similar
- "Save" button to persist URL to Firestore `users/{uid}` doc as `webhookUrl` field (merge: true)
- "Send Test" button (enabled only when URL is saved)
- Status indicator: "Last test: success/failed" (ephemeral, not persisted)
- Guard everything with `requirePremium('Webhook Integration')`

**State extension:**
- Add `state.webhookUrl = null` to state initialization
- Load webhookUrl from user doc on auth state change (in `loadUserIntegrationSettings()` from plan 01, or create if not existing)

**fireWebhook function:**
```javascript
async function fireWebhook(sessionData, isTest = false) {
  const webhookUrl = state.webhookUrl;
  if (!webhookUrl) return;

  const payload = {
    event: isTest ? 'webhook.test' : 'session.completed',
    timestamp: new Date().toISOString(),
    session: isTest ? {
      startedAt: new Date().toISOString(),
      duration: 25,
      projectId: 'sample-project',
      projectName: 'Sample Project',
      taskId: 'sample-task',
      taskName: 'Sample Task',
    } : {
      startedAt: sessionData.startedAt instanceof Date ? sessionData.startedAt.toISOString() : sessionData.startedAt,
      duration: sessionData.duration,
      projectId: sessionData.projectId || null,
      projectName: getProjectName(sessionData.projectId) || null,
      taskId: sessionData.taskId || null,
      taskName: getTaskName(sessionData.taskId) || null,
    },
  };

  try {
    await fetch(webhookUrl, {
      method: 'POST',
      mode: 'no-cors',  // CRITICAL: avoids CORS errors with external webhook endpoints
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      signal: AbortSignal.timeout(5000),
    });
    return true;
  } catch {
    return false; // Silent failure — never interrupt session flow
  }
}
```

Helper functions `getProjectName(id)` and `getTaskName(id)` should look up names from `state.projects` and `state.tasks` arrays by ID. Return null if not found.

**Integration with recordSessionData:**
- After `batch.commit()` resolves in `recordSessionData()`, call `fireWebhook(sessionData)` — do NOT await it in the critical path. Use fire-and-forget: `fireWebhook(sessionData).catch(() => {})` to ensure it never blocks session completion.

**Test webhook button handler:**
- Call `fireWebhook(null, true)` — uses the sample payload
- Show brief toast/status: "Test sent!" (since mode: 'no-cors' means we can't read the response, assume success if no network error)

**Webhook URL validation:**
- Basic URL validation before save: must start with `https://` (reject `http://` for security)
- Show inline error if invalid URL format

**CSS:**
- Webhook settings styled consistent with existing settings sections
- Input field + button row layout
  </action>
  <verify>
Open app as premium user. Go to Settings → Integrations. Enter a webhook URL (e.g., https://httpbin.org/post). Click Save. Click "Send Test". Verify no console errors. Complete a focus session and verify fireWebhook is called (check Network tab — will show as opaque response due to no-cors).
  </verify>
  <done>Premium users can configure a webhook URL in settings, send a test payload, and receive automatic webhook POST on every completed focus session. Webhook failures never block session completion. URL validated as HTTPS only.</done>
</task>

<task type="auto">
  <name>Task 2: PDF productivity report export with jsPDF</name>
  <files>index.html, sw.js</files>
  <action>
Add jsPDF CDN and PDF export functionality to `index.html`:

**CDN script tag:**
- Add `<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>` in `<head>` section alongside existing CDN scripts (Chart.js pattern)
- The library exposes `window.jspdf.jsPDF` constructor

**Export PDF button:**
- Add "Export PDF" button in the analytics dialog (e.g., in the header area or as a tab action)
- Also consider adding it in the Yearly tab since that's the most "report-like" view
- Guard with `requirePremium('PDF Export')`

**exportProductivityReport function:**
Build a formatted A4 PDF report with the following sections. Reuse data from existing analytics functions (the same data already computed for renderOverviewTab, renderProjectsTab, renderYearlyTab):

```javascript
async function exportProductivityReport() {
  if (!requirePremium('PDF Export')) return;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const pageWidth = doc.internal.pageSize.getWidth(); // 210mm
  let y = 20;

  // --- Title ---
  doc.setFontSize(22);
  doc.setFont('helvetica', 'bold');
  doc.text('Productivity Report', 20, y);
  y += 8;

  doc.setFontSize(11);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(100);
  doc.text(`Generated ${new Date().toLocaleDateString()}`, 20, y);
  y += 4;
  doc.text('pomodorotimer.vip', 20, y);
  y += 10;

  // --- Divider ---
  doc.setDrawColor(220, 220, 220);
  doc.line(20, y, pageWidth - 20, y);
  y += 10;

  // --- Section: Annual Summary ---
  // Fetch session data (same query as renderYearlyTab)
  // Include: totalHours, totalSessions, activeDays, longestStreak, mostProductiveDay
  // Format as labeled rows: "Total Focus Time: XX hours"

  // --- Section: Weekly Summary ---
  // Current week stats from renderOverviewTab data
  // Include: hours this week, vs last week %, productivity score

  // --- Section: Best Focus Hours ---
  // Text summary: "Your most productive window is [X]:00 - [X+2]:00"

  // --- Section: Top Projects ---
  // List top 5 projects by time with hours

  // --- Footer ---
  doc.setFontSize(9);
  doc.setTextColor(150);
  doc.text('Generated by Pomodoro Timer — pomodorotimer.vip', 20, 287);

  doc.save(`productivity-report-${new Date().toISOString().slice(0, 10)}.pdf`);
}
```

**Data fetching:** The report needs session data. Reuse the same Firestore queries already used by analytics tabs. If the analytics data is cached in state (check if renderOverviewTab etc. cache their results), use the cache. Otherwise, run the same queries. Important: handle the case where user has no session data gracefully (show "No data yet" in the PDF).

**Page overflow handling:** For each section, check if `y > 260` (leave 37mm bottom margin). If so, call `doc.addPage()` and reset `y = 20`.

**Loading state:** Show a brief "Generating PDF..." indicator while building the report (the Firestore queries may take a moment).

**Bump service worker cache version in sw.js** (increment the version number in CACHE_NAME).
  </action>
  <verify>
Open app as premium user. Navigate to Analytics dialog. Click "Export PDF". Verify a PDF file downloads with the correct filename format (productivity-report-YYYY-MM-DD.pdf). Open the PDF and verify it contains: title, date, annual summary section, weekly summary, best focus hours, top projects, footer. Verify non-premium users see upgrade prompt.
  </verify>
  <done>Premium users can export a formatted PDF productivity report from the analytics dialog. Report includes annual summary, weekly stats, productivity score, best focus hours, and top projects. PDF downloads with dated filename. jsPDF loaded from CDN (3.0.3).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify webhooks and PDF export</name>
  <files>index.html</files>
  <action>
Human verification of webhook configuration with test/auto-fire and PDF productivity report export.

What was built: Webhook URL settings, test webhook button, auto-fire on session completion, jsPDF PDF report export from analytics.

Steps to verify:
1. Open the app as a premium user
2. Go to Settings → Integrations → Webhook section
3. Enter a webhook URL (e.g., https://webhook.site — get a unique URL from webhook.site to see incoming payloads)
4. Click "Send Test" — check webhook.site for the test payload
5. Complete a short focus session — verify webhook fires with real session data
6. Navigate to Analytics → click "Export PDF"
7. Open the downloaded PDF and verify it's formatted correctly with real data
8. Test as non-premium user: verify upgrade prompts appear for both webhook settings and PDF export
  </action>
  <verify>Visual and functional verification by user</verify>
  <done>User approves webhook firing and PDF report quality</done>
</task>

</tasks>

<verification>
- jsPDF CDN script loads without errors (check console)
- Webhook URL saves to Firestore user doc
- Test webhook fires POST to configured URL
- Session completion triggers webhook automatically (fire-and-forget)
- Webhook failure does not block session completion
- PDF exports with all sections populated
- PDF handles empty data gracefully
- Service worker cache version bumped
- All features gated behind premium
</verification>

<success_criteria>
- Webhook URL persists in Firestore and loads on auth state change
- Test webhook sends sample payload to configured URL
- Real webhook fires after every completed focus session (non-blocking)
- PDF report downloads with title, annual summary, weekly stats, best hours, top projects
- Both features show upgrade prompt for non-premium users
- No console errors from jsPDF CDN or webhook fetch
</success_criteria>

<output>
After completion, create `.planning/phases/07-integrations/07-02-SUMMARY.md`
</output>
