---
phase: 03-payment-infrastructure-and-feature-gating
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - index.html
  - sw.js
autonomous: false

must_haves:
  truths:
    - "Pricing page shows 3 tiers (monthly $2, yearly $15, lifetime $47) with free vs premium feature comparison and 'No Ads Ever' guarantee"
    - "Clicking a pricing tier button initiates Stripe Checkout redirect for authenticated users"
    - "Free user tapping a premium-gated feature sees an upgrade prompt modal with pricing comparison"
    - "Subscription status syncs from Firestore in real-time and persists across page reloads"
    - "Premium user sees 'Manage Subscription' option that redirects to Stripe Customer Portal"
    - "User returning from successful checkout sees confirmation and premium status activates"
  artifacts:
    - path: "index.html"
      provides: "Pricing page UI, upgrade prompt modal, feature gating JS, subscription status listener"
      contains: "pricing-page"
    - path: "sw.js"
      provides: "Updated cache version for new UI"
      contains: "CACHE_NAME"
  key_links:
    - from: "index.html"
      to: "Cloud Function createCheckoutSession"
      via: "firebase.functions().httpsCallable('createCheckoutSession')"
      pattern: "httpsCallable.*createCheckoutSession"
    - from: "index.html"
      to: "Cloud Function createPortalSession"
      via: "firebase.functions().httpsCallable('createPortalSession')"
      pattern: "httpsCallable.*createPortalSession"
    - from: "index.html"
      to: "Cloud Function verifySubscription"
      via: "firebase.functions().httpsCallable('verifySubscription')"
      pattern: "httpsCallable.*verifySubscription"
    - from: "index.html"
      to: "Firestore users/{uid}/subscription"
      via: "onSnapshot listener for real-time subscription status"
      pattern: "onSnapshot"
---

<objective>
Build the client-side pricing page, upgrade prompt modal, feature gating system, and subscription status management â€” the complete frontend for the monetization flow.

Purpose: This connects users to the payment infrastructure built in Plans 01-02. Without this, users have no way to see pricing, start checkout, manage their subscription, or experience feature gating.

Output: A pricing page with 3-tier comparison (including "No Ads Ever" guarantee), an upgrade prompt modal for gated features, real-time subscription status from Firestore, and Stripe Checkout/Portal redirects via Cloud Functions.
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-payment-infrastructure-and-feature-gating/03-RESEARCH.md
@.planning/phases/03-payment-infrastructure-and-feature-gating/03-01-SUMMARY.md
@.planning/phases/03-payment-infrastructure-and-feature-gating/03-02-SUMMARY.md
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Firebase Functions SDK, subscription state management, and feature gating system</name>
  <files>
    index.html
  </files>
  <action>
    **Add Firebase Functions SDK (near line 1825, after existing Firebase SDK scripts):**
    ```html
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-functions-compat.js"></script>
    ```

    **Initialize Firebase Functions (near line 1840, after fbDb init):**
    ```javascript
    const fbFunctions = firebase.functions();
    ```

    **Add subscription state to the main state object** (find the state object definition, add):
    ```javascript
    subscription: {
      status: 'none',    // 'none', 'active', 'trialing', 'past_due', 'lifetime', 'canceled'
      tier: null,         // 'monthly', 'yearly', 'lifetime', null
      customerId: null,
      currentPeriodEnd: null,
      cancelAtPeriodEnd: false,
      gracePeriod: false
    }
    ```

    **Add subscription listener function** (in the auth/Firebase section of JS):
    ```javascript
    function listenToSubscription(uid) {
      // Real-time Firestore listener for subscription status
      fbDb.doc(`users/${uid}/subscription`).onSnapshot((doc) => {
        if (doc.exists) {
          const data = doc.data();
          state.subscription = {
            status: data.status || 'none',
            tier: data.status === 'lifetime' ? 'lifetime' : (data.priceId ? getTierFromPriceId(data.priceId) : null),
            customerId: data.customerId || null,
            currentPeriodEnd: data.currentPeriodEnd || null,
            cancelAtPeriodEnd: data.cancelAtPeriodEnd || false,
            gracePeriod: data.status === 'past_due'
          };
        } else {
          state.subscription = { status: 'none', tier: null, customerId: null, currentPeriodEnd: null, cancelAtPeriodEnd: false, gracePeriod: false };
        }
        // Cache for fast optimistic checks
        localStorage.setItem('subscriptionStatus', state.subscription.status);
        updatePremiumUI();
      });
    }
    ```

    **Add to the Firebase auth state listener** (find `fbAuth.onAuthStateChanged`):
    - When user signs in: call `listenToSubscription(user.uid)`
    - When user signs out: reset `state.subscription` to defaults, remove localStorage cache

    **Add feature gating function:**
    ```javascript
    const PREMIUM_STATUSES = ['active', 'trialing', 'past_due', 'lifetime'];

    function isPremium() {
      return PREMIUM_STATUSES.includes(state.subscription.status);
    }

    function requirePremium(featureName) {
      if (isPremium()) return true;
      showUpgradePrompt(featureName);
      return false;
    }

    function getTierFromPriceId(priceId) {
      // Price IDs will be configured â€” match against known IDs
      // For now, return null and let the pricing page handle display
      return null;
    }
    ```

    **Add checkout and portal handler functions:**
    ```javascript
    async function startCheckout(priceId, mode) {
      if (!state.user) {
        // Prompt sign in first
        signInWithGoogle();
        return;
      }
      try {
        const createCheckoutSession = fbFunctions.httpsCallable('createCheckoutSession');
        const result = await createCheckoutSession({ priceId, mode });
        window.location.href = result.data.url;
      } catch (error) {
        console.error('Checkout error:', error);
        showNotification('Failed to start checkout. Please try again.');
      }
    }

    async function openCustomerPortal() {
      try {
        const createPortalSession = fbFunctions.httpsCallable('createPortalSession');
        const result = await createPortalSession();
        window.location.href = result.data.url;
      } catch (error) {
        console.error('Portal error:', error);
        showNotification('Failed to open subscription management.');
      }
    }
    ```

    **Add checkout return handler** (in init() or after DOM ready):
    ```javascript
    // Handle return from Stripe Checkout
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('checkout') === 'success') {
      showNotification('Payment successful! Premium features are activating...');
      // Clean URL
      window.history.replaceState({}, '', window.location.pathname);
    } else if (urlParams.get('checkout') === 'canceled') {
      showNotification('Checkout canceled.');
      window.history.replaceState({}, '', window.location.pathname);
    }
    ```

    **Add updatePremiumUI function:**
    ```javascript
    function updatePremiumUI() {
      const premium = isPremium();
      // Toggle premium badge visibility
      const badge = document.getElementById('premium-badge');
      if (badge) {
        badge.style.display = premium ? '' : 'none';
        badge.textContent = state.subscription.status === 'lifetime' ? 'â˜… Lifetime' : 'â˜… Premium';
      }
      // Toggle "Manage Subscription" visibility in user menu
      const manageBtn = document.getElementById('manage-subscription-btn');
      if (manageBtn) {
        manageBtn.style.display = (premium && state.subscription.status !== 'lifetime') ? '' : 'none';
      }
      // Toggle "Upgrade" button visibility
      const upgradeBtn = document.getElementById('upgrade-btn');
      if (upgradeBtn) {
        upgradeBtn.style.display = premium ? 'none' : '';
      }
    }
    ```
  </action>
  <verify>
    1. `grep 'firebase-functions-compat' index.html` â€” Functions SDK loaded
    2. `grep 'httpsCallable' index.html` â€” callable function invocations present
    3. `grep 'onSnapshot' index.html` â€” real-time subscription listener present
    4. `grep 'isPremium' index.html` â€” gating function present
    5. `grep 'requirePremium' index.html` â€” upgrade prompt trigger present
    6. `grep 'startCheckout' index.html` â€” checkout initiation present
    7. `grep 'openCustomerPortal' index.html` â€” portal access present
    8. `grep 'subscriptionStatus' index.html` â€” localStorage caching present
  </verify>
  <done>
    Firebase Functions SDK loaded, subscription state management with real-time Firestore listener, feature gating functions (isPremium, requirePremium), checkout/portal handlers via callable functions, checkout return URL handling, and premium UI update function all integrated into index.html.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build pricing page UI and upgrade prompt modal</name>
  <files>
    index.html
    sw.js
  </files>
  <action>
    **Add Pricing Page HTML** (add as a new dialog/page section in the HTML, following existing dialog patterns like settings dialog):

    Create a `<div id="pricing-page" class="dialog-overlay">` containing:

    1. **Header:** "Choose Your Plan" with close button
    2. **Subheader:** "Start with a 7-day free trial. Cancel anytime."
    3. **3-column pricing grid** (responsive: stacks on mobile):

    **Free tier (current plan indicator if not premium):**
    - Price: Free
    - Features list: Basic Timer, Focus/Break/Long Break, Task List, Daily Stats, Light/Dark Theme
    - Button: "Current Plan" (disabled) or hidden if premium

    **Premium Monthly:**
    - Price: $2/month
    - Badge: "7-day free trial"
    - Features list: Everything in Free, plus: Projects, Smart Insights, Focus Forecast, Project Analytics, Yearly Report, CSV Export, Custom Themes & Sounds, Todoist Import, Webhook Triggers, **No Ads Ever**
    - Button: "Start Free Trial" â†’ calls `startCheckout(PRICE_ID_MONTHLY, 'subscription')`

    **Premium Yearly (highlighted/recommended):**
    - Price: $15/year
    - Badge: "Save 37%" and "7-day free trial"
    - Features list: Same as monthly
    - Button: "Start Free Trial" â†’ calls `startCheckout(PRICE_ID_YEARLY, 'subscription')`

    **Lifetime:**
    - Price: $47 one-time
    - Badge: "Best Value"
    - Features: Same as monthly + "Pay once, own forever"
    - Button: "Get Lifetime Access" â†’ calls `startCheckout(PRICE_ID_LIFETIME, 'payment')`

    4. **Footer guarantee:** "ðŸ”’ No Ads Ever â€¢ Cancel anytime â€¢ Secure payment via Stripe" (MKTG-01 requirement)

    **Price ID configuration** (add near top of script, after constants):
    ```javascript
    // Stripe Price IDs â€” replace with actual IDs from Stripe Dashboard
    const STRIPE_PRICES = {
      monthly: 'price_REPLACE_WITH_MONTHLY_PRICE_ID',
      yearly: 'price_REPLACE_WITH_YEARLY_PRICE_ID',
      lifetime: 'price_REPLACE_WITH_LIFETIME_PRICE_ID'
    };
    ```

    **Add Upgrade Prompt Modal HTML:**
    Create `<div id="upgrade-prompt" class="dialog-overlay">` containing:
    - Header: "Unlock [Feature Name]"
    - Body: "This is a premium feature. Upgrade to access [feature] and 10 more premium features."
    - Mini pricing comparison (simplified version of pricing page)
    - Buttons: "View Plans" (opens full pricing page), "Maybe Later" (closes modal)

    **Add showUpgradePrompt function:**
    ```javascript
    function showUpgradePrompt(featureName) {
      const prompt = document.getElementById('upgrade-prompt');
      const featureEl = prompt.querySelector('.upgrade-feature-name');
      if (featureEl) featureEl.textContent = featureName || 'this feature';
      prompt.classList.add('active');
    }
    ```

    **Add showPricingPage / hidePricingPage functions:**
    ```javascript
    function showPricingPage() {
      document.getElementById('pricing-page').classList.add('active');
    }
    function hidePricingPage() {
      document.getElementById('pricing-page').classList.remove('active');
    }
    ```

    **Add UI entry points:**
    - Add "Upgrade to Premium" button (`id="upgrade-btn"`) in the user menu or header area (visible when not premium)
    - Add "â˜… Premium" badge (`id="premium-badge"`) next to user info (visible when premium)
    - Add "Manage Subscription" button (`id="manage-subscription-btn"`) in user menu (visible when premium, hidden for lifetime)

    **Add CSS for pricing page** (in the `<style>` section):
    - `.pricing-grid`: CSS Grid, 1 column on mobile, 3 columns on desktop (min-width: 768px)
    - `.pricing-card`: Card styling with border, padding, border-radius matching existing app design
    - `.pricing-card.recommended`: Highlighted card (slightly elevated, accent border)
    - `.pricing-price`: Large font for price amount
    - `.pricing-features`: Checkmark list
    - `.pricing-badge`: Small badge for "Save 37%", "Best Value", "7-day free trial"
    - `.pricing-btn`: Full-width button, matching existing button styles
    - `.upgrade-prompt`: Centered modal overlay
    - Theme-aware: use existing CSS custom properties (--bg, --text, --accent, etc.) so pricing page works in both light and dark themes
    - Use existing dialog overlay pattern from settings dialog for consistency

    **Update sw.js:**
    - Bump `CACHE_NAME` version number by 1

    **Wire up event listeners:**
    - Upgrade button click â†’ `showPricingPage()`
    - Pricing card buttons â†’ `startCheckout(priceId, mode)`
    - Manage subscription button â†’ `openCustomerPortal()`
    - Close buttons on pricing page and upgrade prompt
    - Escape key closes pricing page / upgrade prompt (add to existing Escape handler)
  </action>
  <verify>
    1. `grep 'pricing-page' index.html` â€” pricing page HTML exists
    2. `grep 'upgrade-prompt' index.html` â€” upgrade prompt modal exists
    3. `grep 'No Ads Ever' index.html` â€” MKTG-01 guarantee present
    4. `grep 'STRIPE_PRICES' index.html` â€” price ID configuration present
    5. `grep 'showPricingPage' index.html` â€” pricing page toggle function present
    6. `grep 'showUpgradePrompt' index.html` â€” upgrade prompt function present
    7. `grep 'manage-subscription-btn' index.html` â€” manage subscription UI element present
    8. `grep 'premium-badge' index.html` â€” premium badge element present
    9. `grep 'pricing-grid' index.html` â€” pricing grid CSS present
    10. `grep 'CACHE_NAME' sw.js` â€” cache version bumped
  </verify>
  <done>
    Pricing page shows all 3 tiers with free vs premium comparison, "No Ads Ever" guarantee (MKTG-01), and checkout buttons. Upgrade prompt modal appears when free users access premium features. Premium badge and manage subscription button visible for premium users. All UI is theme-aware and responsive. Service worker cache version bumped.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 3 payment infrastructure:
    - Firebase Cloud Functions (webhook handler, checkout, portal, verification)
    - Pricing page with 3 tiers ($2/mo, $15/yr, $47 lifetime)
    - Upgrade prompt modal for gated features
    - Real-time subscription status from Firestore
    - Premium badge and manage subscription button

    NOTE: To fully test, Cloud Functions must be deployed and Stripe must be configured. For this checkpoint, verify:
    1. UI renders correctly
    2. Code structure is sound
    3. Functions compile
  </what-built>
  <how-to-verify>
    1. Open index.html in browser â€” app loads without console errors
    2. Click "Upgrade to Premium" button â€” pricing page opens with 3 tiers
    3. Verify pricing page shows: Free tier, Monthly ($2/mo), Yearly ($15/yr, "Save 37%"), Lifetime ($47)
    4. Verify "No Ads Ever" guarantee text is visible on pricing page
    5. Verify pricing page is responsive (check mobile width ~375px)
    6. Verify pricing page works in both light and dark themes
    7. Close pricing page with X button and Escape key
    8. Run `cd functions && npx tsc` â€” compiles without errors
    9. Verify Stripe price IDs have placeholder values (will need real IDs before deployment)

    DEPLOYMENT STEPS (after approval):
    - User must: upgrade Firebase to Blaze, set up Stripe account, create products/prices, configure .env.yaml with real keys
    - Deploy: `cd functions && npm run deploy`
    - Configure Stripe webhook endpoint in Stripe Dashboard pointing to deployed function URL
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 3 planning, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Open app in browser â€” no console errors on load
2. Pricing page renders with 3 tiers and correct pricing
3. "No Ads Ever" guarantee visible (MKTG-01)
4. Upgrade prompt modal appears when simulating `showUpgradePrompt('Projects')`
5. Premium badge shows/hides based on subscription status
6. Manage Subscription button visible for active subscribers
7. `cd functions && npx tsc` â€” full backend compiles
8. All 4 Cloud Functions present in functions/lib/index.js after build
9. Feature gating functions (isPremium, requirePremium) available in client JS
10. Firestore subscription listener set up on auth state change
</verification>

<success_criteria>
- Pricing page shows all 3 tiers with clear free vs premium comparison (PAY-01, PAY-02, PAY-03, PAY-08)
- 7-day trial badge shown on subscription tiers, not lifetime (PAY-04)
- Manage Subscription button wired to Customer Portal (PAY-05)
- Feature gating framework with isPremium() and requirePremium() (PAY-06)
- Subscription status from Firestore listener (PAY-07)
- Upgrade prompt modal for gated features (PAY-09)
- past_due status grants access (PAY-10)
- "No Ads Ever" guarantee on pricing page (MKTG-01)
- Service worker cache version bumped
</success_criteria>

<output>
After completion, create `.planning/phases/03-payment-infrastructure-and-feature-gating/03-03-SUMMARY.md`
</output>
