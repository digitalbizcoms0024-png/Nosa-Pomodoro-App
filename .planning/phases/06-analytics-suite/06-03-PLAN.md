---
phase: 06-analytics-suite
plan: 03
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified: [index.html, sw.js]
autonomous: true

must_haves:
  truths:
    - "Premium user can view time spent per project as a donut chart with total hours"
    - "Premium user can view project time trends over the past 4 weeks as a line chart"
    - "Premium user can view Focus Forecast predicting each day of next week based on weighted day-of-week history"
    - "Forecast shows confidence indicator based on data availability"
    - "Insufficient data shows encouraging message instead of broken chart"
  artifacts:
    - path: "index.html"
      provides: "Projects tab with donut chart and trend line chart, Forecast tab with prediction display and confidence badge"
      contains: "renderProjectsTab"
    - path: "sw.js"
      provides: "Updated cache version"
  key_links:
    - from: "renderAnalyticsTab('projects')"
      to: "Projects panel with donut + trend chart"
      via: "renderProjectsTab() fetches sessions grouped by projectId"
      pattern: "renderProjectsTab"
    - from: "renderAnalyticsTab('forecast')"
      to: "Forecast panel with day-of-week predictions"
      via: "renderForecastTab() computes weighted averages from 4 weeks"
      pattern: "renderForecastTab"
    - from: "Project donut chart"
      to: "Chart.js via renderChart()"
      via: "Doughnut chart config with project names and minutes"
      pattern: "type.*doughnut"
    - from: "Forecast predictions"
      to: "Chart.js via renderChart()"
      via: "Bar chart showing predicted minutes per day of week"
      pattern: "forecastChart"
---

<objective>
Projects tab (project time allocation + trends) and Forecast tab (day-of-week prediction model).

Purpose: Projects tab shows WHERE time goes (allocation) and HOW it changes (trends) â€” answering "Am I spending time on the right things?" Forecast tab predicts next week's output using weighted day-of-week patterns â€” answering "What can I expect next week?"
Output: Two fully functional tabs rendering real session data from Firestore.
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-analytics-suite/06-RESEARCH.md
@.planning/phases/06-analytics-suite/06-01-SUMMARY.md
@.planning/phases/06-analytics-suite/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Projects tab â€” project time donut chart and weekly trend line chart</name>
  <files>index.html</files>
  <action>
  Add to the Analytics IIFE in index.html:

  **1. Projects tab renderer:**
  ```javascript
  async function renderProjectsTab() {
    const panel = analyticsDialog.querySelector('[data-tab-panel="projects"]');
    panel.innerHTML = '<div class="analytics-loading">Loading project data...</div>';

    try {
      // Fetch last 4 weeks of sessions
      const fourWeeksAgo = new Date();
      fourWeeksAgo.setDate(fourWeeksAgo.getDate() - 28);
      const sessions = await fetchSessions(fourWeeksAgo, new Date());

      if (sessions.length === 0) {
        panel.innerHTML = '<p class="analytics-empty">Complete focus sessions to see project analytics.</p>';
        return;
      }

      // Build project name lookup from state.projects
      const projectMap = {};
      (state.projects || []).forEach(p => { projectMap[p.id] = p.name; });

      // Aggregate time per project
      const projectMinutes = {};
      sessions.forEach(s => {
        const name = s.projectId ? (projectMap[s.projectId] || 'Unknown Project') : 'No Project';
        projectMinutes[name] = (projectMinutes[name] || 0) + (s.duration || 0);
      });

      const projectEntries = Object.entries(projectMinutes).sort((a, b) => b[1] - a[1]);
      const totalMinutes = projectEntries.reduce((s, [, m]) => s + m, 0);

      // Weekly trend data: group by week and project
      const weeklyData = {};
      sessions.forEach(s => {
        const d = s.startedAt?.toDate ? s.startedAt.toDate() : new Date(s.startedAt);
        const weekStart = new Date(d);
        weekStart.setDate(weekStart.getDate() - weekStart.getDay());
        const weekKey = weekStart.toISOString().split('T')[0];
        const name = s.projectId ? (projectMap[s.projectId] || 'Unknown Project') : 'No Project';
        if (!weeklyData[weekKey]) weeklyData[weekKey] = {};
        weeklyData[weekKey][name] = (weeklyData[weekKey][name] || 0) + (s.duration || 0);
      });

      const weekKeys = Object.keys(weeklyData).sort();

      panel.innerHTML = `
        <h3 class="analytics-section-title">Time by Project</h3>
        <p class="analytics-subtitle">Last 4 weeks â€” ${Math.round(totalMinutes / 60 * 10) / 10} hours total</p>
        <div class="project-chart-container">
          <canvas id="projectDonutChart" height="250"></canvas>
        </div>
        <h3 class="analytics-section-title" style="margin-top:24px;">Weekly Trends</h3>
        <div class="project-chart-container">
          <canvas id="projectTrendChart" height="200"></canvas>
        </div>
      `;

      const colors = getChartColors();
      // Generate a palette of distinct colors for projects
      const palette = [colors.primary, colors.secondary, colors.accent, colors.success, '#e056fd', '#7ed6df', '#ffbe76', '#badc58'];

      // Donut chart
      renderChart('projectDonutChart', {
        type: 'doughnut',
        data: {
          labels: projectEntries.map(([name]) => name),
          datasets: [{
            data: projectEntries.map(([, min]) => min),
            backgroundColor: projectEntries.map((_, i) => palette[i % palette.length]),
            borderWidth: 2,
            borderColor: 'var(--surface)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: colors.text, padding: 12, usePointStyle: true, pointStyleWidth: 10, font: { size: 12 } }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const mins = ctx.raw;
                  const pct = Math.round((mins / totalMinutes) * 100);
                  return `${ctx.label}: ${mins} min (${pct}%)`;
                }
              }
            }
          }
        }
      });

      // Trend line chart â€” one line per project (top 5 projects max to avoid clutter)
      const topProjects = projectEntries.slice(0, 5).map(([name]) => name);
      const trendDatasets = topProjects.map((name, i) => ({
        label: name,
        data: weekKeys.map(wk => weeklyData[wk][name] || 0),
        borderColor: palette[i % palette.length],
        backgroundColor: palette[i % palette.length] + '20',
        tension: 0.3,
        fill: false,
        pointRadius: 4,
        pointHoverRadius: 6
      }));

      const weekLabels = weekKeys.map(wk => {
        const d = new Date(wk + 'T00:00:00');
        return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
      });

      renderChart('projectTrendChart', {
        type: 'line',
        data: { labels: weekLabels, datasets: trendDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: colors.text, padding: 12, usePointStyle: true, font: { size: 11 } }
            },
            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.raw} min` } }
          },
          scales: {
            x: { ticks: { color: colors.text }, grid: { display: false } },
            y: { ticks: { color: colors.text }, grid: { color: colors.grid }, beginAtZero: true }
          }
        }
      });

    } catch (err) {
      console.error('Analytics projects error:', err);
      panel.innerHTML = '<p class="analytics-loading">Unable to load project analytics.</p>';
    }
  }
  ```

  **2. CSS:**
  ```css
  .analytics-subtitle { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 16px; }
  .analytics-empty { text-align: center; color: var(--text-secondary); padding: 40px 0; font-size: 0.9rem; }
  .project-chart-container { position: relative; height: 250px; }
  ```

  **3. Update renderAnalyticsTab switch** to add `case 'projects': return renderProjectsTab();`
  </action>
  <verify>
  1. Open Analytics dialog, click Projects tab
  2. Donut chart shows project breakdown with percentages in tooltips
  3. Trend line chart shows weekly progression for top 5 projects
  4. If no sessions, shows encouraging empty state message
  5. Colors match current theme
  6. No console errors
  </verify>
  <done>Projects tab renders donut chart of project time allocation and weekly trend line chart with up to 5 project lines, with proper empty state handling</done>
</task>

<task type="auto">
  <name>Task 2: Forecast tab â€” day-of-week prediction model with confidence display</name>
  <files>index.html, sw.js</files>
  <action>
  Add to the Analytics IIFE:

  **1. Forecast calculation (exponentially weighted day-of-week averages):**
  Per user decision: predict each day based on past same-day-of-week values. Recent weeks weighted higher. 4-week history window.

  ```javascript
  function calculateForecast(sessions) {
    const fourWeeksAgo = new Date();
    fourWeeksAgo.setDate(fourWeeksAgo.getDate() - 28);

    // Group sessions by day-of-week and by week (for weighting)
    const byDayAndWeek = {}; // { dayOfWeek: { weekIndex: totalMinutes } }
    for (let d = 0; d < 7; d++) byDayAndWeek[d] = {};

    const recentSessions = sessions.filter(s => {
      const date = s.startedAt?.toDate ? s.startedAt.toDate() : new Date(s.startedAt);
      return date >= fourWeeksAgo;
    });

    recentSessions.forEach(s => {
      const date = s.startedAt?.toDate ? s.startedAt.toDate() : new Date(s.startedAt);
      const dow = date.getDay();
      // Determine which week (0 = oldest, 3 = most recent)
      const weeksAgo = Math.floor((Date.now() - date.getTime()) / (7 * 24 * 60 * 60 * 1000));
      const weekIndex = Math.max(0, 3 - weeksAgo);
      byDayAndWeek[dow][weekIndex] = (byDayAndWeek[dow][weekIndex] || 0) + (s.duration || 0);
    });

    // Exponential weights: most recent week gets highest weight
    const weights = [0.1, 0.2, 0.3, 0.4];
    const forecast = {};
    let totalDataPoints = 0;

    for (let d = 0; d < 7; d++) {
      const weekValues = [];
      for (let w = 0; w < 4; w++) {
        if (byDayAndWeek[d][w] !== undefined) {
          weekValues.push({ week: w, value: byDayAndWeek[d][w] });
          totalDataPoints++;
        }
      }

      if (weekValues.length === 0) {
        forecast[d] = null;
        continue;
      }

      const applicableWeights = weekValues.map(wv => weights[wv.week]);
      const weightSum = applicableWeights.reduce((a, b) => a + b, 0);

      forecast[d] = Math.round(weekValues.reduce((sum, wv, i) => {
        return sum + wv.value * (applicableWeights[i] / weightSum);
      }, 0));
    }

    // Confidence: HIGH (20+), MEDIUM (10-19), LOW (<10)
    let confidence = 'low';
    if (totalDataPoints >= 20) confidence = 'high';
    else if (totalDataPoints >= 10) confidence = 'medium';

    const totalPredicted = Object.values(forecast).reduce((s, v) => s + (v || 0), 0);

    return { forecast, confidence, totalDataPoints, totalPredicted };
  }
  ```

  **2. Forecast tab renderer:**
  ```javascript
  async function renderForecastTab() {
    const panel = analyticsDialog.querySelector('[data-tab-panel="forecast"]');
    panel.innerHTML = '<div class="analytics-loading">Loading forecast...</div>';

    try {
      const fiveWeeksAgo = new Date();
      fiveWeeksAgo.setDate(fiveWeeksAgo.getDate() - 35);
      const sessions = await fetchSessions(fiveWeeksAgo, new Date());

      // Check if enough data
      const uniqueDays = new Set(sessions.map(s => {
        const d = s.startedAt?.toDate ? s.startedAt.toDate() : new Date(s.startedAt);
        return d.toDateString();
      })).size;

      if (uniqueDays < 7) {
        panel.innerHTML = `
          <div class="forecast-insufficient">
            <div class="forecast-icon">ðŸ“Š</div>
            <h3>Not Enough Data Yet</h3>
            <p>Focus Forecast needs at least 1 week of sessions to make predictions. You have ${uniqueDays} day${uniqueDays !== 1 ? 's' : ''} of data so far.</p>
            <p class="forecast-encourage">Keep focusing â€” your forecast will appear soon!</p>
          </div>
        `;
        return;
      }

      const result = calculateForecast(sessions);
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const fullDayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

      const confidenceBadge = {
        high: { label: 'High confidence', cls: 'confidence-high' },
        medium: { label: 'Moderate confidence', cls: 'confidence-medium' },
        low: { label: 'Limited data', cls: 'confidence-low' }
      }[result.confidence];

      panel.innerHTML = `
        <h3 class="analytics-section-title">Next Week Forecast</h3>
        <div class="forecast-header">
          <span class="forecast-total">${Math.round(result.totalPredicted / 60 * 10) / 10} hours predicted</span>
          <span class="confidence-badge ${confidenceBadge.cls}">${confidenceBadge.label}</span>
        </div>
        <div class="forecast-chart-container">
          <canvas id="forecastChart" height="220"></canvas>
        </div>
        <div class="forecast-details" id="forecastDetails"></div>
        <p class="forecast-note">Based on your last 4 weeks of focus patterns. Recent weeks weighted more heavily.</p>
      `;

      const colors = getChartColors();
      const today = new Date().getDay();

      const chartData = dayNames.map((_, i) => result.forecast[i] || 0);
      const bgColors = dayNames.map((_, i) =>
        result.forecast[i] === null ? colors.grid : (i === today ? colors.primary : colors.secondary)
      );

      renderChart('forecastChart', {
        type: 'bar',
        data: {
          labels: dayNames,
          datasets: [{
            data: chartData,
            backgroundColor: bgColors,
            borderRadius: 6,
            barPercentage: 0.7
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => fullDayNames[items[0].dataIndex],
                label: (ctx) => result.forecast[ctx.dataIndex] === null ? 'No data' : `${ctx.raw} min predicted`
              }
            }
          },
          scales: {
            x: { ticks: { color: colors.text }, grid: { display: false } },
            y: { ticks: { color: colors.text, callback: (v) => v + 'min' }, grid: { color: colors.grid }, beginAtZero: true }
          }
        }
      });

      // Day-by-day breakdown below chart
      const detailsEl = document.getElementById('forecastDetails');
      const detailsHTML = dayNames.map((name, i) => {
        const mins = result.forecast[i];
        if (mins === null) return `<div class="forecast-day"><span class="forecast-day-name">${fullDayNames[i]}</span><span class="forecast-day-value">â€”</span></div>`;
        return `<div class="forecast-day${i === today ? ' forecast-today' : ''}"><span class="forecast-day-name">${fullDayNames[i]}${i === today ? ' (today)' : ''}</span><span class="forecast-day-value">${mins} min</span></div>`;
      }).join('');
      detailsEl.innerHTML = detailsHTML;

    } catch (err) {
      console.error('Analytics forecast error:', err);
      panel.innerHTML = '<p class="analytics-loading">Unable to load forecast.</p>';
    }
  }
  ```

  **3. Update renderAnalyticsTab switch** to add `case 'forecast': return renderForecastTab();`

  **4. CSS for forecast:**
  ```css
  .forecast-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .forecast-total { font-size: 1.1rem; font-weight: 600; color: var(--text); }
  .confidence-badge { font-size: 0.7rem; padding: 3px 10px; border-radius: var(--radius-full); font-weight: 500; }
  .confidence-high { background: var(--chart-success); color: #fff; }
  .confidence-medium { background: #f39c12; color: #fff; }
  .confidence-low { background: var(--text-secondary); color: #fff; }
  .forecast-chart-container { position: relative; height: 220px; margin-bottom: 16px; }
  .forecast-details { display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px; }
  .forecast-day { display: flex; justify-content: space-between; padding: 6px 12px; border-radius: var(--radius-sm); font-size: 0.85rem; color: var(--text); }
  .forecast-today { background: var(--primary); color: #fff; font-weight: 600; border-radius: var(--radius-sm); }
  .forecast-day-name { font-weight: 500; }
  .forecast-note { font-size: 0.75rem; color: var(--text-secondary); font-style: italic; text-align: center; }
  .forecast-insufficient { text-align: center; padding: 40px 20px; }
  .forecast-insufficient h3 { color: var(--text); margin: 12px 0 8px; }
  .forecast-insufficient p { color: var(--text-secondary); font-size: 0.9rem; }
  .forecast-encourage { color: var(--primary); font-weight: 500; margin-top: 12px; }
  .forecast-icon { font-size: 2rem; }
  ```

  **5. Bump sw.js cache version.**
  </action>
  <verify>
  1. Open Analytics, click Projects tab â€” donut chart and trend lines render (or empty state if no projects)
  2. Click Forecast tab â€” bar chart with 7 days, confidence badge, day-by-day breakdown
  3. Today's day highlighted differently in both chart and detail list
  4. With insufficient data (<7 unique days), shows "Not Enough Data Yet" message
  5. Confidence badge shows correct level (high/medium/low) based on data points
  6. Forecast note text explains the model
  7. Theme-aware colors on all charts
  8. No console errors
  </verify>
  <done>Projects tab shows donut chart (project allocation) and line chart (weekly trends). Forecast tab shows day-of-week predictions with weighted model, confidence badge, day breakdown, and graceful insufficient-data handling.</done>
</task>

</tasks>

<verification>
1. ANLY-01 (project time + trends): Donut chart shows per-project allocation, line chart shows weekly trends
2. ANLY-05 (Focus Forecast): Bar chart predicts next week per-day, uses exponentially weighted 4-week history
3. Project donut tooltip shows minutes and percentage
4. Trend chart limited to top 5 projects (avoids visual clutter)
5. Forecast confidence badge: high/medium/low based on data points
6. Insufficient data: 7+ unique days required for forecast, encouraging message otherwise
7. All charts theme-aware via getChartColors()
</verification>

<success_criteria>
- Projects tab: donut chart of project time allocation + weekly trend line chart
- Project names resolved from state.projects array
- Trend chart shows up to 5 projects over 4 weeks
- Forecast tab: 7-day bar chart with exponentially weighted predictions
- Confidence badge: HIGH (20+ data points), MEDIUM (10-19), LOW (<10)
- Insufficient data threshold: 7 unique days minimum
- Today highlighted in forecast chart and detail list
- Forecast note explains model source
- sw.js cache version bumped
</success_criteria>

<output>
After completion, create `.planning/phases/06-analytics-suite/06-03-SUMMARY.md`
</output>
