---
phase: 06-analytics-suite
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: [index.html, sw.js]
autonomous: true

must_haves:
  truths:
    - "Premium user can see a circular productivity score gauge (0-100) with color gradient and motivating label"
    - "Premium user can see a weekly summary comparing this week vs last week with arrow indicators and vs 4-week average"
    - "Premium user can see best focus hours as an hour-of-day bar chart with actionable text recommendation"
    - "Score factors in total focus time, consistency, and session quality"
  artifacts:
    - path: "index.html"
      provides: "Overview tab content: productivity gauge SVG, weekly summary cards, hour-of-day Chart.js bar chart, calculateProductivityScore(), analyzeBestFocusHours()"
      contains: "calculateProductivityScore"
    - path: "sw.js"
      provides: "Updated cache version"
  key_links:
    - from: "renderAnalyticsTab('overview')"
      to: "Overview panel populated with gauge + summary + chart"
      via: "renderOverviewTab() called from renderAnalyticsTab switch"
      pattern: "renderOverviewTab"
    - from: "calculateProductivityScore()"
      to: "SVG gauge rendering"
      via: "Score value drives stroke-dashoffset and color selection"
      pattern: "stroke-dashoffset.*score"
    - from: "Hour-of-day bar chart"
      to: "Chart.js via renderChart()"
      via: "Canvas element + Chart.js bar config with getChartColors()"
      pattern: "renderChart.*hourChart"
---

<objective>
Overview tab: productivity score gauge, weekly summary comparison, and best focus hours analysis.

Purpose: The Overview tab is the first thing users see when opening Analytics — it needs to deliver immediate, motivating insight. The productivity score creates engagement (fitness tracker feel), the weekly summary shows progress, and the best focus hours give actionable advice.
Output: Fully functional Overview tab with real Firestore data driving all three sections.
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-analytics-suite/06-RESEARCH.md
@.planning/phases/06-analytics-suite/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Productivity score calculation, SVG gauge, and motivating labels</name>
  <files>index.html</files>
  <action>
  Add to the Analytics IIFE section in index.html:

  **1. Productivity score calculation function:**
  Multi-factor score (0-100) per user decision:
  - 40% total focus time: `Math.min(40, (totalMinutes / 300) * 40)` — 300 min (5 hours) in a week = max
  - 30% consistency: `(uniqueDaysWithSessions / 7) * 30` — 7 active days = max
  - 30% session quality: `Math.min(30, (avgSessionMinutes / 45) * 30)` — 45 min average session = max

  ```javascript
  function calculateProductivityScore(sessions) {
    if (sessions.length === 0) return { score: 0, timeScore: 0, consistencyScore: 0, qualityScore: 0 };

    const totalMinutes = sessions.reduce((sum, s) => sum + (s.duration || 0), 0);
    const timeScore = Math.min(40, (totalMinutes / 300) * 40);

    const uniqueDays = new Set(sessions.map(s => {
      const d = s.startedAt?.toDate ? s.startedAt.toDate() : new Date(s.startedAt);
      return d.toDateString();
    })).size;
    const consistencyScore = Math.min(30, (uniqueDays / 7) * 30);

    const avgSession = totalMinutes / sessions.length;
    const qualityScore = Math.min(30, (avgSession / 45) * 30);

    const score = Math.round(Math.min(100, timeScore + consistencyScore + qualityScore));
    return { score, timeScore: Math.round(timeScore), consistencyScore: Math.round(consistencyScore), qualityScore: Math.round(qualityScore) };
  }
  ```

  **2. Score label function (motivating tone per user decision):**
  ```javascript
  function getScoreLabel(score) {
    if (score >= 90) return 'Crushing it!';
    if (score >= 70) return 'On fire';
    if (score >= 50) return 'Building momentum';
    if (score >= 30) return 'Getting started';
    return 'Every session counts';
  }
  ```

  **3. SVG gauge renderer:**
  Build a fitness-tracker style circular gauge:
  - Two SVG circles: background (--ring-track) and progress arc
  - Color gradient: red (0-49), yellow (50-69), green (70+) — use --chart-primary for green range, #f39c12 for yellow, #e74c3c for red
  - Score number centered inside (large, bold)
  - Label text below score inside SVG
  - Comparison text below gauge: "Up X from last week" or "Down X from last week" with arrow

  ```javascript
  function renderProductivityGauge(container, currentScore, lastWeekScore) {
    const circumference = 2 * Math.PI * 70;
    const progress = (currentScore.score / 100) * circumference;

    let color = '#e74c3c';
    if (currentScore.score >= 70) color = getChartColors().success;
    else if (currentScore.score >= 50) color = '#f39c12';

    const diff = currentScore.score - lastWeekScore;
    const diffText = diff > 0 ? `↑ Up ${diff} from last week` : diff < 0 ? `↓ Down ${Math.abs(diff)} from last week` : 'Same as last week';
    const diffClass = diff > 0 ? 'score-up' : diff < 0 ? 'score-down' : 'score-same';

    container.innerHTML = `
      <div class="productivity-gauge">
        <svg viewBox="0 0 180 180" class="gauge-svg">
          <circle cx="90" cy="90" r="70" fill="none" stroke="var(--ring-track)" stroke-width="12" />
          <circle cx="90" cy="90" r="70" fill="none" stroke="${color}" stroke-width="12"
            stroke-linecap="round" stroke-dasharray="${circumference}" stroke-dashoffset="${circumference - progress}"
            transform="rotate(-90 90 90)" style="transition: stroke-dashoffset 1s ease;" />
          <text x="90" y="82" text-anchor="middle" dominant-baseline="middle"
            font-size="40" font-weight="bold" fill="var(--text)">${currentScore.score}</text>
          <text x="90" y="110" text-anchor="middle" font-size="13" fill="var(--text-secondary)">${getScoreLabel(currentScore.score)}</text>
        </svg>
        <p class="score-comparison ${diffClass}">${diffText}</p>
      </div>
    `;
  }
  ```

  **4. CSS for gauge:**
  ```css
  .productivity-gauge { text-align: center; margin-bottom: 20px; }
  .gauge-svg { width: 180px; height: 180px; }
  .score-comparison { font-size: 0.85rem; margin-top: 8px; }
  .score-up { color: var(--chart-success); }
  .score-down { color: #e74c3c; }
  .score-same { color: var(--text-secondary); }
  ```
  </action>
  <verify>
  In browser console (while analytics dialog is open), test:
  1. `calculateProductivityScore([])` returns `{ score: 0, ... }`
  2. `getScoreLabel(95)` returns `'Crushing it!'`
  3. `getScoreLabel(75)` returns `'On fire'`
  4. `getScoreLabel(55)` returns `'Building momentum'`
  </verify>
  <done>Productivity score calculation produces 0-100 composite score, SVG gauge renders with color gradient, motivating labels display correctly, week-over-week comparison shown</done>
</task>

<task type="auto">
  <name>Task 2: Weekly summary cards, best focus hours chart, and Overview tab wiring</name>
  <files>index.html, sw.js</files>
  <action>
  **1. Weekly summary renderer:**
  Compares this week vs last week AND vs 4-week average per user decision. Shows arrows for up/down changes.

  ```javascript
  function renderWeeklySummary(container, thisWeekSessions, lastWeekSessions, fourWeekAvg) {
    const thisTotal = thisWeekSessions.reduce((s, x) => s + (x.duration || 0), 0);
    const lastTotal = lastWeekSessions.reduce((s, x) => s + (x.duration || 0), 0);
    const thisCount = thisWeekSessions.length;
    const lastCount = lastWeekSessions.length;

    const weekDiff = thisTotal - lastTotal;
    const weekPct = lastTotal > 0 ? Math.round((weekDiff / lastTotal) * 100) : 0;
    const avgDiff = thisTotal - fourWeekAvg.minutes;
    const avgPct = fourWeekAvg.minutes > 0 ? Math.round((avgDiff / fourWeekAvg.minutes) * 100) : 0;

    function arrow(val) { return val > 0 ? '↑' : val < 0 ? '↓' : '→'; }
    function cls(val) { return val > 0 ? 'stat-up' : val < 0 ? 'stat-down' : 'stat-same'; }

    container.innerHTML = `
      <div class="weekly-summary">
        <h3 class="analytics-section-title">This Week</h3>
        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-value">${thisTotal}<span class="summary-unit">min</span></div>
            <div class="summary-label">Total focus</div>
            <div class="summary-compare ${cls(weekDiff)}">
              ${arrow(weekDiff)} ${Math.abs(weekPct)}% vs last week
            </div>
            <div class="summary-compare ${cls(avgDiff)}">
              ${arrow(avgDiff)} ${Math.abs(avgPct)}% vs 4-week avg
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-value">${thisCount}</div>
            <div class="summary-label">Sessions</div>
            <div class="summary-compare ${cls(thisCount - lastCount)}">
              ${arrow(thisCount - lastCount)} ${Math.abs(thisCount - lastCount)} vs last week
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-value">${thisWeekSessions.length > 0 ? Math.round(thisTotal / thisCount) : 0}<span class="summary-unit">min</span></div>
            <div class="summary-label">Avg session</div>
          </div>
        </div>
      </div>
    `;
  }
  ```

  **2. Best focus hours analysis and chart:**
  ```javascript
  function analyzeBestFocusHours(sessions) {
    const hourMinutes = Array(24).fill(0);
    sessions.forEach(s => {
      const hour = s.hourOfDay != null ? s.hourOfDay : (s.startedAt?.toDate ? s.startedAt.toDate() : new Date(s.startedAt)).getHours();
      hourMinutes[hour] += (s.duration || 0);
    });

    // Find best 2-hour window
    let maxWindow = 0, maxStart = 0;
    for (let i = 0; i < 23; i++) {
      const w = hourMinutes[i] + hourMinutes[i + 1];
      if (w > maxWindow) { maxWindow = w; maxStart = i; }
    }

    const formatHour = (h) => { const p = h >= 12 ? 'pm' : 'am'; return ((h % 12) || 12) + p; };
    const recommendation = sessions.length > 0
      ? `You focus best between ${formatHour(maxStart)}-${formatHour(maxStart + 2)}`
      : 'Complete more sessions to see your best focus hours';

    return { hourMinutes, peakStart: maxStart, peakEnd: maxStart + 2, recommendation };
  }

  function renderFocusHoursChart(container, analysis) {
    const colors = getChartColors();
    container.innerHTML = `
      <div class="focus-hours-section">
        <h3 class="analytics-section-title">Best Focus Hours</h3>
        <p class="focus-recommendation">${analysis.recommendation}</p>
        <canvas id="focusHoursChart" height="200"></canvas>
      </div>
    `;

    const labels = Array.from({length: 24}, (_, i) => {
      const p = i >= 12 ? 'pm' : 'am';
      return ((i % 12) || 12) + p;
    });

    const bgColors = analysis.hourMinutes.map((_, i) =>
      (i >= analysis.peakStart && i < analysis.peakEnd) ? colors.primary : colors.secondary + '60'
    );

    renderChart('focusHoursChart', {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data: analysis.hourMinutes,
          backgroundColor: bgColors,
          borderRadius: 4,
          barPercentage: 0.8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.raw} min`
            }
          }
        },
        scales: {
          x: { ticks: { color: colors.text, font: { size: 10 }, maxRotation: 45 }, grid: { display: false } },
          y: { ticks: { color: colors.text }, grid: { color: colors.grid } }
        }
      }
    });
  }
  ```

  **3. Overview tab rendering orchestrator:**
  Update `renderAnalyticsTab` to handle 'overview':
  ```javascript
  async function renderOverviewTab() {
    const panel = analyticsDialog.querySelector('[data-tab-panel="overview"]');
    panel.innerHTML = '<div class="analytics-loading">Loading analytics...</div>';

    try {
      const thisWeek = getWeekBounds(0);
      const lastWeek = getWeekBounds(1);
      const fourWeeksAgo = new Date(thisWeek.start);
      fourWeeksAgo.setDate(fourWeeksAgo.getDate() - 28);

      const [thisWeekSessions, lastWeekSessions, fourWeekSessions] = await Promise.all([
        fetchSessions(thisWeek.start, thisWeek.end),
        fetchSessions(lastWeek.start, lastWeek.end),
        fetchSessions(fourWeeksAgo, thisWeek.start)
      ]);

      // 4-week average
      const fourWeekTotal = fourWeekSessions.reduce((s, x) => s + (x.duration || 0), 0);
      const fourWeekAvg = { minutes: Math.round(fourWeekTotal / 4), sessions: Math.round(fourWeekSessions.length / 4) };

      // Productivity scores
      const currentScore = calculateProductivityScore(thisWeekSessions);
      const lastWeekScoreObj = calculateProductivityScore(lastWeekSessions);

      // Build overview panel
      panel.innerHTML = '<div id="gaugeContainer"></div><div id="summaryContainer"></div><div id="focusHoursContainer"></div>';

      renderProductivityGauge(document.getElementById('gaugeContainer'), currentScore, lastWeekScoreObj.score);
      renderWeeklySummary(document.getElementById('summaryContainer'), thisWeekSessions, lastWeekSessions, fourWeekAvg);

      // Best focus hours uses all 4 weeks of data for better analysis
      const allRecentSessions = [...fourWeekSessions, ...thisWeekSessions];
      const focusAnalysis = analyzeBestFocusHours(allRecentSessions);
      renderFocusHoursChart(document.getElementById('focusHoursContainer'), focusAnalysis);

    } catch (err) {
      console.error('Analytics overview error:', err);
      panel.innerHTML = '<p class="analytics-loading">Unable to load analytics. Please try again.</p>';
    }
  }
  ```

  Update the `renderAnalyticsTab` function (from plan 06-01) to route to tab-specific renderers:
  ```javascript
  async function renderAnalyticsTab(tabName) {
    renderedTabs[tabName] = true;
    switch (tabName) {
      case 'overview': return renderOverviewTab();
      // cases for projects, forecast, yearly will be added in later plans
      default:
        const panel = analyticsDialog.querySelector(`[data-tab-panel="${tabName}"]`);
        if (panel) panel.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:40px 0;">Coming soon</p>';
    }
  }
  ```

  **4. CSS for summary cards and focus hours:**
  ```css
  .analytics-section-title { font-size: 0.95rem; font-weight: 600; color: var(--text); margin-bottom: 12px; }
  .summary-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 24px; }
  .summary-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; text-align: center; }
  .summary-value { font-size: 1.6rem; font-weight: 700; color: var(--text); }
  .summary-unit { font-size: 0.75rem; font-weight: 400; color: var(--text-secondary); margin-left: 2px; }
  .summary-label { font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px; }
  .summary-compare { font-size: 0.7rem; margin-top: 4px; }
  .stat-up { color: var(--chart-success); }
  .stat-down { color: #e74c3c; }
  .stat-same { color: var(--text-secondary); }
  .focus-hours-section { margin-top: 4px; }
  .focus-recommendation { font-size: 0.85rem; color: var(--primary); font-weight: 500; margin-bottom: 12px; }
  @media (max-width: 480px) {
    .summary-grid { grid-template-columns: 1fr; }
  }
  ```

  **5. Bump sw.js cache version.**
  </action>
  <verify>
  1. Open analytics dialog, Overview tab loads automatically
  2. Productivity gauge shows circular SVG with score number and motivating label
  3. Weekly summary shows 3 cards with comparison arrows (vs last week, vs 4-week avg)
  4. Focus hours bar chart renders with 24 hour labels, peak hours highlighted in primary color
  5. Actionable recommendation text shows below chart title (e.g., "You focus best between 9am-11am")
  6. All colors respond to theme changes (switch theme, reopen analytics)
  7. Empty state: if no sessions exist, gauge shows 0, summary shows 0s, chart is empty but no errors
  8. No console errors
  </verify>
  <done>Overview tab fully functional: productivity gauge (0-100, color gradient, motivating label, week comparison), weekly summary (3 cards, vs last week + 4-week avg with arrows), best focus hours (24h bar chart with peak highlight + actionable recommendation)</done>
</task>

</tasks>

<verification>
1. ANLY-02 (best focus hours): Hour-of-day bar chart with highlighted peak window + text recommendation
2. ANLY-03 (productivity score): Multi-factor score 0-100 displayed as circular gauge with color gradient
3. ANLY-04 (weekly summary): Cards comparing this week vs last week AND vs 4-week average with arrows
4. Theme awareness: Switch between themes, chart colors update on next dialog open
5. Empty state handling: No errors with zero sessions
6. Performance: Overview tab loads quickly (3 parallel Firestore queries)
</verification>

<success_criteria>
- Productivity score gauge renders as circular SVG with red/yellow/green coloring based on score
- Score formula: 40% time + 30% consistency + 30% session quality
- Motivating labels: "Crushing it!" (90+), "On fire" (70+), "Building momentum" (50+), "Getting started" (30+), "Every session counts" (0+)
- Week-over-week comparison shown below gauge with arrow
- Weekly summary: 3 cards (total focus, sessions, avg session) with vs-last-week and vs-4-week-avg comparisons
- Best focus hours: 24-hour bar chart with peak hours highlighted + actionable recommendation text
- All data fetched from Firestore sessions subcollection using fetchSessions utility
- sw.js cache version bumped
</success_criteria>

<output>
After completion, create `.planning/phases/06-analytics-suite/06-02-SUMMARY.md`
</output>
