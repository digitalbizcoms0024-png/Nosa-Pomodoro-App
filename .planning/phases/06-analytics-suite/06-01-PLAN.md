---
phase: 06-analytics-suite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [index.html, sw.js]
autonomous: true

must_haves:
  truths:
    - "Chart.js is loaded from CDN and available globally"
    - "Every theme (light, dark, ocean, forest, sunset, lavender, charcoal) has chart color CSS custom properties"
    - "Analytics dialog opens with 4 working tabs (Overview, Projects, Forecast, Yearly) that show/hide panels"
    - "Chart.js instances are tracked and destroyed before re-creation (no memory leaks)"
    - "Analytics dialog is premium-gated — free users see upgrade prompt"
  artifacts:
    - path: "index.html"
      provides: "Chart.js CDN script tag, chart color CSS tokens for all 7 themes, analytics dialog HTML with tab navigation, analytics IIFE with data fetching and chart management utilities"
      contains: "chart.js"
    - path: "sw.js"
      provides: "Updated cache version"
  key_links:
    - from: "Analytics button in toolbar"
      to: "analytics-dialog.showModal()"
      via: "click event listener"
      pattern: "analyticsDialog\\.showModal"
    - from: "Tab buttons"
      to: "Tab panels show/hide"
      via: "data-tab-button click handler toggling data-tab-panel display"
      pattern: "data-tab-button.*data-tab-panel"
    - from: "Chart color functions"
      to: "CSS custom properties"
      via: "getComputedStyle reading --chart-* variables"
      pattern: "getPropertyValue.*--chart"
---

<objective>
Analytics dialog foundation: Chart.js integration, theme-aware chart color tokens, tabbed dialog shell, session data fetching utilities, and chart instance management.

Purpose: Establish the infrastructure that all 4 analytics tabs will build upon — charting library, themed colors, dialog UI, data layer, and memory-safe chart lifecycle.
Output: Working analytics dialog with switchable tabs (empty content), Chart.js loaded, chart colors responding to theme, utility functions for session queries and chart management.
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-analytics-suite/06-RESEARCH.md
@.planning/phases/05-premium-personalization-export/05-01-SUMMARY.md
@.planning/phases/04-data-foundation-and-projects/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Chart.js CDN, chart color CSS custom properties, and analytics dialog HTML</name>
  <files>index.html</files>
  <action>
  Three additions to index.html:

  **1. Chart.js CDN script tag:**
  Add before the closing `</body>` tag (before the Firebase/app scripts, or after — just before the main IIFE):
  ```html
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  ```

  **2. Chart color CSS custom properties for ALL 7 themes:**
  Add `--chart-primary`, `--chart-secondary`, `--chart-accent`, `--chart-grid`, `--chart-text`, `--chart-success` to each theme block. These must be distinct from --primary to allow chart-specific palette control. Use colors that complement each theme:

  - light focus: --chart-primary: #e74c3c; --chart-secondary: #3498db; --chart-accent: #f39c12; --chart-grid: #e8e0de; --chart-text: #2c2c2c; --chart-success: #27ae60
  - light break: same as focus (charts don't change between modes — use the focus-mode values for all modes of each theme)
  - dark focus: --chart-primary: #e74c3c; --chart-secondary: #5dade2; --chart-accent: #f5b041; --chart-grid: #3d2a2e; --chart-text: #f0e6e6; --chart-success: #2ecc71
  - dark break: same chart colors as dark focus
  - ocean: --chart-primary: #2980b9; --chart-secondary: #16a085; --chart-accent: #e67e22; --chart-grid: #d4e6f3; --chart-text: #2c2c2c; --chart-success: #27ae60
  - forest: --chart-primary: #27ae60; --chart-secondary: #2980b9; --chart-accent: #f39c12; --chart-grid: #d5e8d7; --chart-text: #2c2c2c; --chart-success: #2ecc71
  - sunset: --chart-primary: #ff6b6b; --chart-secondary: #f39c12; --chart-accent: #9b59b6; --chart-grid: #ffe0d9; --chart-text: #2c2c2c; --chart-success: #27ae60
  - lavender: --chart-primary: #9b59b6; --chart-secondary: #3498db; --chart-accent: #e74c3c; --chart-grid: #ebdff0; --chart-text: #2c2c2c; --chart-success: #27ae60
  - charcoal focus: --chart-primary: #ff7675; --chart-secondary: #74b9ff; --chart-accent: #ffeaa7; --chart-grid: #3d3d3d; --chart-text: #f0f0f0; --chart-success: #55efc4
  - charcoal break: same chart colors as charcoal focus

  IMPORTANT: For each theme, add the chart tokens to the FOCUS mode selector only (e.g., `html[data-theme="ocean"][data-mode="focus"]`). Charts read these at render time, and the focus-mode block is always evaluated. If you add to break mode too, that's fine but redundant. Just ensure every theme has them.

  **3. Analytics dialog HTML:**
  Add after the existing `</dialog>` for chimeDialog (around line 2640). Structure:

  ```html
  <dialog id="analyticsDialog" aria-labelledby="analyticsTitle">
    <div class="dialog-header">
      <h2 id="analyticsTitle">Analytics</h2>
      <button class="icon-btn" id="closeAnalytics" aria-label="Close analytics">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="analytics-tabs">
      <button class="analytics-tab active" data-tab-button="overview">Overview</button>
      <button class="analytics-tab" data-tab-button="projects">Projects</button>
      <button class="analytics-tab" data-tab-button="forecast">Forecast</button>
      <button class="analytics-tab" data-tab-button="yearly">Yearly</button>
    </div>
    <div class="dialog-body analytics-body">
      <div class="analytics-panel" data-tab-panel="overview" style="display:block">
        <div class="analytics-loading">Loading analytics...</div>
      </div>
      <div class="analytics-panel" data-tab-panel="projects" style="display:none">
        <div class="analytics-loading">Loading project data...</div>
      </div>
      <div class="analytics-panel" data-tab-panel="forecast" style="display:none">
        <div class="analytics-loading">Loading forecast...</div>
      </div>
      <div class="analytics-panel" data-tab-panel="yearly" style="display:none">
        <div class="analytics-loading">Loading yearly report...</div>
      </div>
    </div>
  </dialog>
  ```

  **4. Analytics CSS:**
  Add styles for the analytics dialog (wider than standard dialogs — max-width: 600px), tab bar, tab buttons (horizontal strip with active state using --primary underline), analytics panels, and loading state. The dialog should be scrollable. Tab bar should be sticky at top when scrolling.

  ```css
  /* Analytics dialog */
  #analyticsDialog { max-width: 600px; width: 95vw; max-height: 85vh; }
  .analytics-tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); padding: 0 20px; position: sticky; top: 0; background: var(--surface); z-index: 1; }
  .analytics-tab { background: none; border: none; color: var(--text-secondary); padding: 10px 16px; font-size: 0.9rem; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: color 0.2s, border-color 0.2s; }
  .analytics-tab:hover { color: var(--text); }
  .analytics-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }
  .analytics-body { padding: 20px; overflow-y: auto; }
  .analytics-panel { min-height: 200px; }
  .analytics-loading { text-align: center; color: var(--text-secondary); padding: 40px 0; }
  ```
  </action>
  <verify>
  Open index.html in browser. Verify:
  1. No console errors about Chart.js loading
  2. `typeof Chart !== 'undefined'` returns true in console
  3. CSS custom properties visible: `getComputedStyle(document.documentElement).getPropertyValue('--chart-primary')` returns a color value
  4. Dialog HTML exists in DOM: `document.getElementById('analyticsDialog')` is not null
  </verify>
  <done>Chart.js loaded from CDN, all 7 themes have chart color CSS custom properties, analytics dialog HTML with 4 tab panels exists in DOM</done>
</task>

<task type="auto">
  <name>Task 2: Tab switching JS, session data fetching, chart instance management, and toolbar button</name>
  <files>index.html, sw.js</files>
  <action>
  Add JavaScript inside the main IIFE (after the existing audio or export sections):

  **1. DOM references:**
  ```javascript
  const analyticsDialog = $('#analyticsDialog');
  const closeAnalyticsBtn = $('#closeAnalytics');
  ```

  **2. Chart instance management (prevent memory leaks):**
  ```javascript
  const chartInstances = {};

  function renderChart(canvasId, config) {
    if (chartInstances[canvasId]) {
      chartInstances[canvasId].destroy();
    }
    const ctx = document.getElementById(canvasId).getContext('2d');
    chartInstances[canvasId] = new Chart(ctx, config);
    return chartInstances[canvasId];
  }

  function getChartColors() {
    const style = getComputedStyle(document.documentElement);
    return {
      primary: style.getPropertyValue('--chart-primary').trim(),
      secondary: style.getPropertyValue('--chart-secondary').trim(),
      accent: style.getPropertyValue('--chart-accent').trim(),
      grid: style.getPropertyValue('--chart-grid').trim(),
      text: style.getPropertyValue('--chart-text').trim(),
      success: style.getPropertyValue('--chart-success').trim()
    };
  }
  ```

  **3. Session data fetching utility:**
  ```javascript
  async function fetchSessions(startDate, endDate) {
    if (!state.user) return [];
    const uid = state.user.uid;
    const sessionsRef = fbDb.collection('users').doc(uid).collection('sessions');
    const q = sessionsRef
      .where('startedAt', '>=', startDate)
      .where('startedAt', '<=', endDate)
      .orderBy('startedAt', 'asc');
    const snapshot = await q.get();
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }

  function getWeekBounds(weeksAgo = 0) {
    const now = new Date();
    const dayOfWeek = now.getDay(); // 0=Sun
    const startOfThisWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - dayOfWeek);
    const start = new Date(startOfThisWeek);
    start.setDate(start.getDate() - (weeksAgo * 7));
    const end = new Date(start);
    end.setDate(end.getDate() + 7);
    end.setMilliseconds(end.getMilliseconds() - 1);
    return { start, end };
  }
  ```

  **4. Tab switching logic:**
  ```javascript
  const analyticsTabButtons = analyticsDialog.querySelectorAll('[data-tab-button]');
  const analyticsTabPanels = analyticsDialog.querySelectorAll('[data-tab-panel]');
  const renderedTabs = {};

  analyticsTabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const targetTab = button.dataset.tabButton;

      analyticsTabButtons.forEach(b => b.classList.remove('active'));
      button.classList.add('active');

      analyticsTabPanels.forEach(panel => {
        panel.style.display = panel.dataset.tabPanel === targetTab ? 'block' : 'none';
      });

      // Lazy-render tab content
      if (!renderedTabs[targetTab]) {
        renderAnalyticsTab(targetTab);
      }
    });
  });

  async function renderAnalyticsTab(tabName) {
    renderedTabs[tabName] = true;
    // Tab-specific rendering will be added in plans 06-02, 06-03, 06-04
    // For now, show placeholder
    const panel = analyticsDialog.querySelector(`[data-tab-panel="${tabName}"]`);
    if (panel) {
      panel.innerHTML = `<p style="text-align:center;color:var(--text-secondary);padding:40px 0;">Coming soon</p>`;
    }
  }
  ```

  **5. Open/close analytics dialog:**
  ```javascript
  function openAnalytics() {
    if (!requirePremium('Analytics')) return;
    // Reset rendered state so data refreshes each open
    Object.keys(renderedTabs).forEach(k => delete renderedTabs[k]);
    // Reset to Overview tab
    analyticsTabButtons.forEach(b => b.classList.toggle('active', b.dataset.tabButton === 'overview'));
    analyticsTabPanels.forEach(p => p.style.display = p.dataset.tabPanel === 'overview' ? 'block' : 'none');
    analyticsDialog.showModal();
    renderAnalyticsTab('overview');
  }

  closeAnalyticsBtn.addEventListener('click', () => analyticsDialog.close());
  analyticsDialog.addEventListener('click', (e) => {
    if (e.target === analyticsDialog) analyticsDialog.close();
  });
  ```

  **6. Analytics button in toolbar:**
  Find the existing stats/toolbar button area. Add an "Analytics" button next to the existing stats button. Use an SVG chart icon (bar chart or line chart). The button should call `openAnalytics()`. Place it near the existing openStats button. Use the same `icon-btn` class.

  Look for where the stats button (`openStats`) is wired up and add the analytics button similarly. Add a new button element in the toolbar HTML area (near the stats/settings buttons). A simple bar-chart SVG icon:
  ```html
  <button class="icon-btn" id="openAnalytics" aria-label="Analytics" title="Analytics">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
    </svg>
  </button>
  ```

  Wire it: `$('#openAnalytics').addEventListener('click', openAnalytics);`

  **7. Keyboard shortcut:**
  In the existing Escape key handler, add: `else if (analyticsDialog.open) analyticsDialog.close();`

  **8. Bump service worker cache version in sw.js** — increment CACHE_NAME (currently at some version, bump by 1).
  </action>
  <verify>
  Open index.html in browser:
  1. Analytics button visible in toolbar with bar-chart icon
  2. Clicking Analytics button while not premium shows upgrade prompt
  3. With premium (or bypassing gate for testing), dialog opens with 4 tabs
  4. Clicking tabs switches panels (shows "Coming soon" placeholder)
  5. Close via X button, Escape key, and backdrop click all work
  6. No console errors
  7. `typeof renderChart === 'function'` — false (it's in IIFE scope, but check no errors)
  8. Service worker cache version is bumped in sw.js
  </verify>
  <done>Analytics dialog fully functional with tab switching, premium-gated, session data fetching utility ready, chart instance management ready, toolbar button wired up, service worker cache bumped</done>
</task>

</tasks>

<verification>
1. Chart.js loads without errors: check Network tab shows chart.js loaded from CDN
2. Chart color CSS properties exist for all 7 themes: switch theme, read --chart-primary in console
3. Analytics dialog opens, tabs switch, panels show/hide correctly
4. Premium gating works: free user sees upgrade prompt
5. Dialog closes via all 3 methods (X, Escape, backdrop)
6. No memory leak setup: chartInstances object and destroy-before-create pattern in place
7. fetchSessions and getWeekBounds utility functions exist and are callable
</verification>

<success_criteria>
- Chart.js loaded from CDN (script tag in index.html)
- All 7 themes have --chart-primary, --chart-secondary, --chart-accent, --chart-grid, --chart-text, --chart-success CSS custom properties
- Analytics dialog with 4 tabs (Overview, Projects, Forecast, Yearly) opens and tab-switches correctly
- Dialog is premium-gated via requirePremium()
- Chart instance management (chartInstances map, renderChart with destroy-before-create) is ready
- Session data fetching utility (fetchSessions, getWeekBounds) is ready
- Toolbar has Analytics button with bar-chart SVG icon
- sw.js cache version bumped
</success_criteria>

<output>
After completion, create `.planning/phases/06-analytics-suite/06-01-SUMMARY.md`
</output>
