---
phase: 05-premium-personalization-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [index.html, sw.js]
autonomous: true

must_haves:
  truths:
    - "Premium user can switch between 5 color themes beyond light/dark (Ocean, Forest, Sunset, Lavender, Charcoal)"
    - "Selected theme persists across page reloads via localStorage"
    - "Free user sees locked themes with Premium badge in theme selector"
    - "Each theme provides distinct focus/break/longbreak color variants"
    - "Premium user can browse and play 3 additional audio categories (Lo-fi, Classical, Nature)"
    - "Free user tapping a premium audio category sees upgrade prompt"
  artifacts:
    - path: "index.html"
      provides: "CSS rules for 5 premium themes (focus + break + longbreak for each)"
      contains: "data-theme=\"ocean\""
    - path: "index.html"
      provides: "Theme selector dialog with color swatch grid"
      contains: "themeDialog"
    - path: "index.html"
      provides: "3 premium audio categories in AUDIO_STATIONS"
      contains: "lofi:"
  key_links:
    - from: "theme selector UI"
      to: "document.documentElement data-theme attribute"
      via: "applyTheme() sets attribute + saves to localStorage"
      pattern: "setAttribute.*data-theme"
    - from: "theme selector UI"
      to: "requirePremium()"
      via: "premium check before applying non-light/dark themes"
      pattern: "requirePremium.*Theme"
    - from: "audio category buttons"
      to: "switchAudioCategory()"
      via: "premium check added to existing function"
      pattern: "requirePremium.*audio"
---

<objective>
Add 5 premium color themes with a theme selector dialog, and extend the audio system with 3 premium streaming categories.

Purpose: Deliver the "feel premium on day one" visual and auditory personalization that makes the subscription immediately tangible.
Output: Theme selector UI, 5 premium CSS themes (each with focus/break/longbreak variants), 3 premium audio categories with premium gating on both features.
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-premium-personalization-export/05-RESEARCH.md
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Premium CSS themes and theme selector UI</name>
  <files>index.html</files>
  <action>
**CSS (after the existing dark break/longbreak rules, ~line 79):**

Add 5 premium themes, each with 3 mode variants (focus, break, longbreak). Each theme needs ALL custom properties: --bg, --surface, --primary, --primary-hover, --text, --text-secondary, --ring-track, --border. Dark themes also need shadow overrides.

Themes to define:
1. **Ocean** (light-based): focus=#2980b9 blue, break=#16a085 teal, bg=#f0f8ff
2. **Forest** (light-based): focus=#27ae60 green, break=#2ecc71 lighter green, bg=#f4f8f4
3. **Sunset** (light-based): focus=#ff6b6b coral, break=#f39c12 amber, bg=#fff5ee
4. **Lavender** (light-based): focus=#9b59b6 purple, break=#8e44ad deeper purple, bg=#f8f5ff
5. **Charcoal** (dark-based): focus=#ff7675 soft red, break=#55efc4 mint, bg=#1a1a1a. Include shadow overrides like existing dark theme.

Each theme selector format: `html[data-theme="ocean"][data-mode="focus"]`, `html[data-theme="ocean"][data-mode="break"]`, `html[data-theme="ocean"][data-mode="longbreak"]` (break and longbreak can share same selector like existing light/dark do).

**CSS for theme selector dialog:**

Add styles for `#themeDialog` using the existing dialog pattern (same as settingsDialog/pricingPage). Add a `.theme-grid` with CSS grid (3 columns on desktop, 2 on mobile). Each `.theme-card` is a clickable button showing:
- A color swatch (small circle using the theme's --primary color)
- Theme name text
- `.active` state with border highlight
- `.locked` state with reduced opacity + "Premium" badge
- The "Light" and "Dark" cards should be free (no lock)

**HTML (after the existing dialogs, near line ~2014):**

Add a `<dialog id="themeDialog">` with:
- Dialog header with title "Choose Theme" and close button (icon-btn with SVG X, matching existing pattern)
- `.theme-grid` container (will be populated dynamically by JS)

**Replace existing theme toggle button** (the fixed button at bottom-right, id="themeToggle", ~line 1944):
- Change it from a simple light/dark toggle to a palette icon button that opens the theme selector dialog
- Update aria-label to "Choose theme" and data-tooltip to "Theme"
- Replace sun/moon SVGs with a palette SVG icon
- Keep the same `.theme-toggle-fixed` class and positioning

**JavaScript:**

1. Add DOM ref: `const themeDialog = $('#themeDialog');`

2. Define theme metadata constant:
```javascript
const THEMES = [
  { id: 'light', name: 'Light', color: '#e74c3c', premium: false },
  { id: 'dark', name: 'Dark', color: '#e74c3c', premium: false },
  { id: 'ocean', name: 'Ocean', color: '#2980b9', premium: true },
  { id: 'forest', name: 'Forest', color: '#27ae60', premium: true },
  { id: 'sunset', name: 'Sunset', color: '#ff6b6b', premium: true },
  { id: 'lavender', name: 'Lavender', color: '#9b59b6', premium: true },
  { id: 'charcoal', name: 'Charcoal', color: '#ff7675', premium: true },
];
```

3. Add `showThemeSelector()` function:
   - Populate `.theme-grid` with buttons for each theme
   - Each button: color swatch circle (inline style `background: theme.color`), theme name, premium badge if locked
   - Mark current theme as `.active`
   - Premium themes show lock if `!isPremium()`
   - On click: if locked, call `requirePremium('Premium Themes')` and return. Otherwise call `applyTheme(theme.id)` and update active state.
   - Add a preview button on each card that temporarily applies theme on hover/focus (optional, skip if complex)
   - Open dialog with `themeDialog.showModal()`

4. Add `applyTheme(themeId)` function:
   - `document.documentElement.setAttribute('data-theme', themeId)`
   - `saveTheme(themeId)` (existing function already saves to localStorage)
   - Update the theme selector UI active state

5. Update the themeToggle click handler: instead of toggling light/dark, call `showThemeSelector()`

6. Update Escape key handler to include themeDialog in the priority chain (after pricingPage, before settingsDialog)

7. Add backdrop click handler for themeDialog: `if (e.target === themeDialog) themeDialog.close()`

8. **Theme flash prevention**: The existing `loadTheme()` runs inside the IIFE (after DOM parse). Add an inline `<script>` in the `<head>` (before the `<style>` tag) that reads localStorage and sets `data-theme` immediately:
```html
<script>
  (function(){var t=localStorage.getItem('pomodoro-theme');if(t)document.documentElement.setAttribute('data-theme',t)})();
</script>
```
This prevents flash when loading premium themes.

**Important patterns to follow:**
- Use addEventListener inside IIFE (not inline onclick) per Phase 3 lesson
- Use `<dialog>` with `.showModal()` / `.close()` per existing pattern
- Close button uses `icon-btn` class with SVG (not &times;)
- Backdrop click: `if (e.target === e.currentTarget) dialog.close()`
  </action>
  <verify>
Open index.html in browser. Click the theme button (bottom-right). Verify:
1. Theme dialog opens with 7 theme cards in a grid
2. Light and Dark show as free, Ocean/Forest/Sunset/Lavender/Charcoal show "Premium" badge
3. Clicking Light or Dark applies theme immediately (colors change)
4. Close dialog via X button, Escape key, and backdrop click all work
5. Reload page -- saved theme persists (no flash of default theme)
6. Check all 5 premium themes apply correctly in both focus and break modes (manually set data-theme in DevTools if not premium)
  </verify>
  <done>
Theme selector dialog shows 7 themes (2 free + 5 premium). Free themes apply on click. Premium themes show lock + badge when not premium. Theme persists across reload. All 5 premium themes have complete CSS for focus/break/longbreak modes with proper color variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Premium audio categories with gating</name>
  <files>index.html, sw.js</files>
  <action>
**Extend AUDIO_STATIONS** (~line 2463) with 3 premium categories:

```javascript
const AUDIO_STATIONS = {
  // Existing free categories
  ambient: [ /* keep existing */ ],
  binaural: [ /* keep existing */ ],

  // Premium categories
  lofi: [
    { name: 'Lush', url: 'https://ice1.somafm.com/lush-128-mp3', genre: 'Lo-fi Chill' },
    { name: 'Groove Salad', url: 'https://ice1.somafm.com/groovesalad-256-mp3', genre: 'Downtempo' },
    { name: 'Indie Pop Rocks', url: 'https://ice1.somafm.com/indiepop-128-mp3', genre: 'Indie Pop' },
  ],
  classical: [
    { name: 'BAGeL Radio', url: 'https://ice1.somafm.com/bagel-128-mp3', genre: 'Classical Remix' },
    { name: 'Suburbs of Goa', url: 'https://ice1.somafm.com/suburbsofgoa-128-mp3', genre: 'World Classical' },
  ],
  nature: [
    { name: 'Fluid', url: 'https://ice1.somafm.com/fluid-128-mp3', genre: 'Liquid Ambient' },
    { name: 'Drone Zone', url: 'https://ice5.somafm.com/dronezone-256-mp3', genre: 'Meditative Drone' },
  ],
};
```

**Extend AUDIO_CATEGORY_LABELS** (~line 2477):
```javascript
const AUDIO_CATEGORY_LABELS = {
  ambient: 'Ambient',
  binaural: 'Focus Beats',
  lofi: 'Lo-fi',
  classical: 'Classical',
  nature: 'Nature',
};
```

**Add premium categories constant** (after AUDIO_CATEGORY_LABELS):
```javascript
const PREMIUM_AUDIO_CATEGORIES = ['lofi', 'classical', 'nature'];
```

**Modify `switchAudioCategory()` function** (~line 3876):
Add a premium check at the top of the function, before any state changes:
```javascript
function switchAudioCategory(category) {
  if (!AUDIO_STATIONS[category]) {
    console.error('Invalid audio category:', category);
    return;
  }

  // Premium gate for premium categories
  if (PREMIUM_AUDIO_CATEGORIES.includes(category) && !isPremium()) {
    showUpgradePrompt('Premium Audio');
    return;
  }

  // ... rest of existing logic unchanged
}
```

**Modify `initAudio()` category button generation** (~line 3792):
When generating category buttons, add a visual indicator for premium categories. After creating the button, if the category is premium, add a small lock icon or "PRO" badge text:
```javascript
if (PREMIUM_AUDIO_CATEGORIES.includes(key) && !isPremium()) {
  btn.classList.add('audio-cat-premium');
}
```

**Add CSS for `.audio-cat-premium`:**
```css
.audio-cat-btn.audio-cat-premium::after {
  content: 'PRO';
  font-size: 8px;
  font-weight: 700;
  background: var(--primary);
  color: var(--surface);
  padding: 1px 4px;
  border-radius: 3px;
  margin-left: 4px;
  vertical-align: super;
}
```

**Bump service worker cache version** in sw.js.

**Important:** The existing `initAudio()` already dynamically generates category buttons from `AUDIO_CATEGORY_LABELS`, so adding new entries there will automatically create the buttons. The premium gate in `switchAudioCategory()` prevents free users from switching to premium categories.

**Fallback behavior:** If a user's saved category was a premium one and they lose premium status, the existing fallback in `initAudio()` (`if (!AUDIO_STATIONS[state.audio.currentCategory])`) won't catch it because the category still exists. Add an additional check: if saved category is premium and user is not premium, reset to 'ambient'.
  </action>
  <verify>
Open index.html in browser. Click the audio indicator to expand the panel. Verify:
1. Five category buttons visible: Ambient, Focus Beats, Lo-fi, Classical, Nature
2. Lo-fi, Classical, Nature show "PRO" badge
3. Clicking a premium category (when not premium) shows upgrade prompt
4. Ambient and Focus Beats still work as before (no regression)
5. In DevTools, manually set `isPremium` to return true -- premium categories play SomaFM streams
  </verify>
  <done>
3 premium audio categories (Lo-fi, Classical, Nature) added to AUDIO_STATIONS with 2-3 stations each. Category buttons auto-generated with PRO badges. switchAudioCategory() gates premium categories. Free users see upgrade prompt. Existing categories unaffected. Service worker cache bumped.
  </done>
</task>

</tasks>

<verification>
1. Theme selector opens from bottom-right button, shows 7 themes in grid
2. Light/Dark themes free to switch, premium themes gated
3. Each premium theme has correct colors for focus, break, and longbreak modes
4. Theme persists across reload without flash
5. Audio panel shows 5 categories (2 free + 3 premium with PRO badges)
6. Premium audio categories gated behind upgrade prompt for free users
7. No regression on existing audio playback or theme functionality
</verification>

<success_criteria>
- 5 premium CSS themes defined with focus/break/longbreak variants
- Theme selector dialog with color swatches and premium badges
- Theme persists via localStorage with flash prevention
- 3 premium audio categories with SomaFM streams
- Premium gating on both themes and audio categories via existing isPremium()/requirePremium()
- Service worker cache version bumped
</success_criteria>

<output>
After completion, create `.planning/phases/05-premium-personalization-export/05-01-SUMMARY.md`
</output>
