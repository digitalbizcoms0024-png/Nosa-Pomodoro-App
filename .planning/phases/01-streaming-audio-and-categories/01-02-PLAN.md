---
phase: 01-streaming-audio-and-categories
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - index.html
autonomous: false

must_haves:
  truths:
    - "User can see a minimal audio indicator on the main screen"
    - "User can expand the indicator to reveal full audio controls"
    - "User can play and pause background audio by tapping the play button"
    - "User can choose from 4 audio categories"
    - "User can switch between stations within a category (next/prev)"
    - "User can adjust volume with a slider"
    - "User can mute/unmute audio"
    - "Current station name is displayed"
    - "Audio controls look consistent with existing app theme (light/dark, focus/break)"
  artifacts:
    - path: "index.html"
      provides: "Audio indicator HTML, expanded panel HTML, CSS styles, UI event wiring, updateAudioUI implementation"
      contains: "audioIndicator"
  key_links:
    - from: "index.html (audio indicator click)"
      to: "index.html (toggleAudioPanel)"
      via: "addEventListener click"
      pattern: "audioIndicator.*click|toggleAudioPanel"
    - from: "index.html (play button click)"
      to: "index.html (toggleAudioPlayback)"
      via: "addEventListener click"
      pattern: "audioPlayPause.*click|toggleAudioPlayback"
    - from: "index.html (category selector)"
      to: "index.html (switchAudioCategory)"
      via: "addEventListener change/click"
      pattern: "switchAudioCategory"
    - from: "index.html (volume slider)"
      to: "index.html (setAudioVolume)"
      via: "addEventListener input"
      pattern: "audioVolume.*input|setAudioVolume"
    - from: "index.html (updateAudioUI)"
      to: "index.html (DOM elements)"
      via: "updates play/pause icon, station name, category, volume"
      pattern: "updateAudioUI"
---

<objective>
Build the audio controls UI and wire it to the audio engine from Plan 01.

Purpose: This plan creates the minimal indicator + expandable panel UI pattern for audio controls, styles everything to match the existing app theme, wires all UI events to the audio playback functions, implements the real `updateAudioUI()` function, and adds a human verification checkpoint.

Output: Fully functional, themed audio controls in index.html
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-streaming-audio-and-categories/01-RESEARCH.md
@.planning/phases/01-streaming-audio-and-categories/01-01-SUMMARY.md
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add audio controls HTML, CSS, and UI wiring</name>
  <files>index.html</files>
  <action>
  Make the following additions to index.html:

  **1. HTML — Add audio indicator and expandable panel (insert after the closing `</dialog>` of leaderboardDialog and before the `<!-- Firebase SDK -->` comment):**

  Create a fixed-position audio indicator in the bottom-right corner of the screen. Structure:

  ```
  <div id="audioIndicator" class="audio-indicator" aria-label="Audio controls">
    <!-- Collapsed state: small circular button with music note icon -->
    <button id="audioTogglePanel" class="audio-toggle-btn" aria-label="Toggle audio panel">
      <svg><!-- music note icon --></svg>
    </button>

    <!-- Expanded state: full controls panel -->
    <div id="audioPanel" class="audio-panel">
      <!-- Category selector: row of small buttons/pills for lofi/ambient/nature/binaural -->
      <div class="audio-categories">
        <!-- One button per category from AUDIO_CATEGORY_LABELS -->
      </div>

      <!-- Station info + nav -->
      <div class="audio-station">
        <button id="audioPrev" aria-label="Previous station"><!-- chevron left SVG --></button>
        <span id="audioStationName" class="audio-station-name">Station Name</span>
        <button id="audioNext" aria-label="Next station"><!-- chevron right SVG --></button>
      </div>

      <!-- Play/Pause button -->
      <button id="audioPlayPause" class="audio-play-btn" aria-label="Play audio">
        <!-- Play/Pause SVG icon -->
      </button>

      <!-- Volume row: mute button + slider -->
      <div class="audio-volume">
        <button id="audioMuteBtn" aria-label="Mute"><!-- speaker SVG --></button>
        <input type="range" id="audioVolumeSlider" min="0" max="100" value="70" aria-label="Volume">
      </div>
    </div>
  </div>
  ```

  Use simple inline SVG icons (music note, play triangle, pause bars, chevrons, speaker). Keep them minimal — consistent with the existing icon style in the app (the app uses inline SVGs for close buttons, theme toggle, etc.).

  **2. CSS — Add audio control styles (add at end of the existing `<style>` block, before `</style>`):**

  Style the audio indicator with these characteristics:
  - `.audio-indicator`: `position: fixed; bottom: 20px; right: 20px; z-index: 100;` — sits above page content but below dialogs
  - Collapsed state (default): 48px circle with `var(--surface)` background, `var(--shadow-md)` shadow, `var(--primary)` icon color
  - `.audio-indicator.expanded`: wider panel (280-300px width), rounded rectangle (`var(--radius-md)`), auto height
  - `.audio-panel`: hidden by default (`display: none`), shown when `.expanded` class on parent (`display: flex; flex-direction: column; gap: 12px; padding: 16px;`)
  - `.audio-toggle-btn`: 48x48 circle, `var(--surface)` bg, `var(--primary)` icon, no border, cursor pointer. When expanded, remains at top of panel.
  - `.audio-categories`: flex row with gap, small pill buttons. Active category gets `var(--primary)` bg with white text, inactive gets `var(--surface)` bg with `var(--text-secondary)` text and `var(--border)` border
  - `.audio-station`: flex row, station name centered between prev/next chevron buttons
  - `.audio-station-name`: truncate with ellipsis, `var(--text)` color, small font size
  - `.audio-play-btn`: centered, 40x40 circle, `var(--primary)` bg, white icon
  - `.audio-volume`: flex row, mute button + range slider. Style the range slider to use `var(--primary)` for the track fill (use `::-webkit-slider-runnable-track` and `::-moz-range-track` for cross-browser).
  - All colors use CSS custom properties so light/dark and focus/break themes work automatically
  - Add smooth transition for expand/collapse: `transition: all 300ms ease`
  - `.audio-indicator.playing .audio-toggle-btn`: Add a subtle animation or visual cue (e.g., pulsing opacity or a small colored dot) to indicate audio is playing even when collapsed

  Mobile responsive: On screens < 480px, make the panel take more width but keep it in bottom-right. Ensure it doesn't overlap with the timer or main controls.

  **3. JavaScript — Implement updateAudioUI() (replace the stub from Plan 01):**

  Replace the empty `updateAudioUI()` function with a real implementation that:
  - Updates play/pause button icon (swap SVG between play triangle and pause bars)
  - Updates station name text (`audioStationName.textContent = station.name`)
  - Updates active category pill (add/remove `.active` class)
  - Updates volume slider value
  - Updates mute button icon (speaker vs speaker-off)
  - Adds/removes `.playing` class on audioIndicator when playing/paused

  **4. JavaScript — Wire UI event listeners (add in the `// --- Event listeners ---` section or right after audio function definitions):**

  - `audioTogglePanel` click: Toggle `.expanded` class on `audioIndicator`. Update `state.audio.isExpanded`.
  - `audioPlayPause` click: Call `toggleAudioPlayback()`. MUST be direct synchronous call from click handler (iOS Safari).
  - Each category button click: Call `switchAudioCategory(category)`. Update UI.
  - `audioPrev` click: Call `prevAudioStation()`.
  - `audioNext` click: Call `nextAudioStation()`.
  - `audioVolumeSlider` input: Call `setAudioVolume(parseInt(this.value))`.
  - `audioMuteBtn` click: Call `toggleAudioMute()`.
  - Click outside the expanded panel: Collapse it (add document click listener that checks if click target is outside audioIndicator).

  **5. JavaScript — Populate category buttons dynamically in initAudio() or a new initAudioUI() function:**

  Use `AUDIO_CATEGORY_LABELS` to create the category buttons so they stay in sync with the data. Set the first category as active. Call `updateAudioUI()` after initialization to show the correct initial state.

  **6. JavaScript — Update initAudio() to also init the UI:**

  At the end of `initAudio()`, call the UI initialization (populate categories, set initial UI state from restored settings).

  IMPORTANT STYLING NOTES:
  - Use ONLY existing CSS custom properties (--bg, --surface, --primary, --primary-hover, --text, --text-secondary, --border, --shadow-sm/md/lg, --radius-sm/md/lg/full, --transition)
  - This ensures automatic theme support — no extra dark/light mode CSS needed
  - The audio panel should feel like a native part of the app, not a bolt-on widget
  </action>
  <verify>
  1. Page loads without console errors
  2. Small circular audio indicator visible in bottom-right corner
  3. Clicking indicator expands to show full controls
  4. Clicking play starts audio from SomaFM (check Network tab for stream request)
  5. Category buttons switch stations and update station name
  6. Next/prev buttons cycle through stations
  7. Volume slider changes audio volume
  8. Mute button toggles mute state
  9. Clicking outside panel collapses it
  10. Theme switching (light/dark) properly re-themes audio controls
  11. Mode switching (focus/break) properly re-themes audio controls
  12. Collapsed indicator shows visual cue when audio is playing
  </verify>
  <done>
  - Audio indicator visible on main screen (minimal, non-intrusive)
  - Clicking indicator expands to full controls panel
  - Play/pause, category selection, station switching, volume, mute all functional
  - Station name displays correctly
  - UI themed with CSS custom properties (works in all 4 theme combos)
  - Panel collapses on outside click
  - Playing state visible even when collapsed
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete audio playback system with streaming radio from SomaFM, featuring a minimal floating indicator that expands to full controls with category selection, station switching, play/pause, volume, and mute.</what-built>
  <how-to-verify>
    1. Open the app in browser (or run a local server)
    2. Look for small circular audio button in bottom-right corner
    3. Click it — panel should expand with category buttons, station name, play/pause, volume
    4. Click Play — audio should start streaming (check that sound comes out)
    5. Switch categories (Lofi, Ambient, Nature Sounds, Focus Beats) — station should change
    6. Use Next/Prev to cycle stations within a category
    7. Adjust volume slider — audio volume should change
    8. Click mute — audio should mute (icon changes)
    9. Click outside the panel — it should collapse
    10. When collapsed and playing, verify there's a visual indicator (dot, pulse, etc.)
    11. Toggle dark mode — verify audio controls match the theme
    12. Switch to break mode — verify audio controls match the green break theme
    13. Reload page — verify your last category/station/volume preferences are restored
    14. Check on mobile viewport (responsive design tools) — controls shouldn't overlap timer
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Audio indicator is visible and non-intrusive on the main screen
2. Full control panel expands/collapses smoothly
3. Audio plays from SomaFM streams without errors
4. All 4 categories have selectable stations
5. Volume and mute controls work independently of timer sounds
6. Theme integration works across all 4 theme combinations (light/dark x focus/break)
7. Preferences persist across page reloads
8. No regressions to existing timer functionality
</verification>

<success_criteria>
- All 9 requirements met: AUDIO-01 (play/pause), AUDIO-02 (volume), AUDIO-03 (mute), AUDIO-04 (integrated UI), CAT-01 (4 categories), CAT-02 (curated stations), CAT-03 (station switching as auto-advance), UI-01 (minimal indicator), UI-02 (expandable controls)
- Audio controls themed consistently with existing app
- Preferences persist via localStorage
- No regressions to timer, tasks, stats, or theme functionality
</success_criteria>

<output>
After completion, create `.planning/phases/01-streaming-audio-and-categories/01-02-SUMMARY.md`
</output>
