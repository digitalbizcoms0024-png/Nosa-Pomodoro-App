---
phase: 01-streaming-audio-and-categories
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
  - sw.js
autonomous: true

must_haves:
  truths:
    - "Hidden audio element exists and can play a SomaFM stream URL"
    - "Audio station data for 4 categories (lofi, ambient, nature, binaural) is defined"
    - "Play/pause, volume, mute, station switching, and category switching functions work"
    - "Audio state persists across page reload (category, station, volume, mute)"
    - "Audio auto-advances to next station when current stream ends (ended event)"
    - "Service worker does not cache streaming audio URLs"
  artifacts:
    - path: "index.html"
      provides: "Hidden <audio> element, AUDIO_STATIONS data, audio state management, all playback functions"
      contains: "bgAudio"
    - path: "sw.js"
      provides: "Stream URL exclusion from cache"
      contains: "somafm.com"
  key_links:
    - from: "index.html (audio functions)"
      to: "index.html (<audio> element)"
      via: "document.getElementById('bgAudio')"
      pattern: "getElementById.*bgAudio"
    - from: "index.html (audio state)"
      to: "localStorage"
      via: "saveSettings/loadSettings"
      pattern: "audioVolume|audioCategory|audioStation"
    - from: "sw.js (fetch handler)"
      to: "streaming domains"
      via: "URL exclusion check"
      pattern: "somafm\\.com"
---

<objective>
Add the audio playback engine and station data to the pomodoro timer app.

Purpose: This plan creates the hidden `<audio>` element, defines all station/category data, implements all audio playback functions (play, pause, volume, mute, station/category switching), persists audio preferences, and updates the service worker to exclude streaming URLs from cache. After this plan, audio can be played programmatically even though no UI controls exist yet.

Output: Working audio engine in index.html + updated sw.js
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-streaming-audio-and-categories/01-RESEARCH.md
@index.html
@sw.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add audio element, station data, and playback engine to index.html</name>
  <files>index.html</files>
  <action>
  In index.html, make the following additions:

  **1. HTML — Add hidden audio element (insert just before the Firebase SDK scripts, around line 1558):**
  ```html
  <!-- Background Audio -->
  <audio id="bgAudio" preload="none" crossorigin="anonymous"></audio>
  ```
  No `controls` attribute — UI is custom (Plan 02). `crossorigin="anonymous"` for CORS compatibility with SomaFM.

  **2. JavaScript — Add audio station data (inside the main IIFE, right after the DEFAULTS object, around line 1663):**

  Define `AUDIO_STATIONS` as a const object with 4 categories. Use ONLY verified SomaFM HTTPS URLs for reliability. Each station has `name`, `url`, and `genre` fields:

  - `lofi` (3-4 stations): Groove Salad (`ice5.somafm.com/groovesalad-256-mp3`), Fluid (`ice1.somafm.com/fluid-128-mp3`), Illinois Street Lounge (`ice1.somafm.com/illstreet-128-mp3`), Lush (`ice1.somafm.com/lush-128-mp3`)
  - `ambient` (3-4 stations): Drone Zone (`ice5.somafm.com/dronezone-256-mp3`), Deep Space One (`ice1.somafm.com/deepspaceone-128-mp3`), Space Station Soma (`ice1.somafm.com/spacestation-128-mp3`), Mission Control (`ice1.somafm.com/missioncontrol-128-mp3`)
  - `nature` (3 stations): SomaFM has limited nature content, so use: Fluid (ambient/organic), Suburbs of Goa (`ice1.somafm.com/suburbsofgoa-128-mp3`), and Silent Channel (if available). If SomaFM doesn't have enough pure nature stations, use 2-3 SomaFM stations with nature/organic vibes and clearly label them.
  - `binaural` (2-3 stations): SomaFM doesn't have dedicated binaural stations. Use ambient/drone stations that serve a similar focus-enhancement purpose: Drone Zone, Deep Space One, Dark Zone (`ice1.somafm.com/darkzone-256-mp3`). Label the category clearly as "Focus/Binaural" in the UI.

  NOTE: Stick to SomaFM URLs only for launch reliability. Third-party URLs (chillhop, calmradio, etc.) have unverified CORS support. We can add more sources later.

  Define `AUDIO_CATEGORY_LABELS` mapping keys to display names: `{ lofi: 'Lofi', ambient: 'Ambient', nature: 'Nature Sounds', binaural: 'Focus Beats' }`.

  **3. JavaScript — Extend state object:** Add `audio` property to the `state` object:
  ```javascript
  audio: {
    isPlaying: false,
    currentCategory: 'lofi',
    currentStationIndex: 0,
    volume: 0.7,
    isMuted: false,
    isExpanded: false,
  }
  ```

  **4. JavaScript — Extend DEFAULTS and settings persistence:**
  Add to DEFAULTS: `audioVolume: 70, audioMuted: false, audioCategory: 'lofi', audioStationIndex: 0`.
  These will be saved/loaded via the existing `saveSettings()`/`loadSettings()` pattern (they use `Object.assign` from localStorage).

  **5. JavaScript — Add audio playback functions (add a new section `// --- Audio ---` before the `// --- Event listeners ---` section):**

  - `initAudio()` — Get bgAudio element reference. Set volume from `state.settings.audioVolume / 100`. Set muted from `state.settings.audioMuted`. Restore last category/station from settings. Add event listeners: `error` (call `handleAudioError`), `play` (set `state.audio.isPlaying = true`, call `updateAudioUI` if it exists), `pause` (set `state.audio.isPlaying = false`, call `updateAudioUI` if it exists), `ended` (call `nextAudioStation()` to auto-advance to next station — implements CAT-03). Call from `init()`.
  - `handleAudioError(e)` — Log error code. If MEDIA_ERR_NETWORK (code 2), show user-friendly message via existing `sendNotification` if available, or console.warn.
  - `toggleAudioPlayback()` — If paused: set audio.src to current station URL if not already set, then call `audio.play()` with `.catch()` for NotAllowedError. If playing: call `audio.pause()`. Must be called synchronously from user click handler (iOS Safari requirement).
  - `setAudioVolume(value)` — Takes 0-100 integer. Sets `audio.volume = value / 100`, updates `state.settings.audioVolume = value`, calls `saveSettings()`.
  - `toggleAudioMute()` — Toggles `audio.muted`. Updates `state.settings.audioMuted = audio.muted`. Calls `saveSettings()`.
  - `switchAudioCategory(category)` — Validates category exists in AUDIO_STATIONS. Updates `state.audio.currentCategory`, resets `state.audio.currentStationIndex` to 0. Loads first station of new category. Persists to settings. If was playing, starts playing new station.
  - `nextAudioStation()` — Advances `currentStationIndex` by 1, wraps around. Calls `loadAudioStation()`.
  - `prevAudioStation()` — Decrements `currentStationIndex` by 1, wraps around. Calls `loadAudioStation()`.
  - `loadAudioStation(station)` — If no argument, gets station from current category/index. Sets `audio.src = station.url`. If `state.audio.isPlaying`, calls `audio.play().catch(...)`. Persists station index to settings.
  - `getCurrentAudioStation()` — Returns current station object from AUDIO_STATIONS based on state.
  - `updateAudioUI()` — Stub function for now (Plan 02 fills this in). Just a no-op: `function updateAudioUI() {}`. This avoids errors from event listeners that call it.

  **6. JavaScript — Restore audio state in init():**
  In the `init()` function, after `loadSettings()`, add call to `initAudio()`. The initAudio function restores category/station/volume/mute from persisted settings.

  IMPORTANT: All `audio.play()` calls MUST include `.catch()` — never leave the promise unhandled. This is critical for iOS Safari compatibility and prevents console errors.
  </action>
  <verify>
  Open browser console at the running app. Execute:
  - `document.getElementById('bgAudio')` should return the audio element
  - `typeof AUDIO_STATIONS` or access via the IIFE scope — verify station data exists by checking the audio element's behavior
  - In the console, the audio functions won't be directly accessible (they're inside an IIFE), but you can verify by:
    1. Checking no console errors on page load
    2. The audio element exists in the DOM
    3. The state object has the audio property (inspect via debugger or add temporary console.log in init)

  Also verify: `state.settings` in localStorage includes audioVolume, audioCategory, audioStationIndex, audioMuted keys after page load.
  </verify>
  <done>
  - Hidden `<audio id="bgAudio">` element exists in DOM with crossorigin="anonymous"
  - AUDIO_STATIONS object has 4 categories with 2-4 SomaFM stations each
  - All audio functions (toggle, volume, mute, category switch, station switch) are defined
  - Audio preferences (volume, mute, category, station) persist to localStorage via settings
  - No console errors on page load
  - initAudio() called from init()
  </done>
</task>

<task type="auto">
  <name>Task 2: Update service worker to exclude streaming URLs from cache</name>
  <files>sw.js</files>
  <action>
  Modify `sw.js`:

  1. **Bump cache version**: Change `CACHE_NAME` from `'pomodoro-v33'` to `'pomodoro-v34'`.

  2. **Add stream URL exclusion to fetch handler**: Replace the current simple fetch handler with one that checks for streaming domains before attempting cache:

  ```javascript
  self.addEventListener('fetch', (e) => {
    const url = e.request.url;

    // Don't cache streaming audio URLs — they are continuous/infinite
    const streamingDomains = ['somafm.com'];

    if (streamingDomains.some(domain => url.includes(domain))) {
      e.respondWith(fetch(e.request));
      return;
    }

    // Cache-first for static assets
    e.respondWith(
      caches.match(e.request).then((cached) => cached || fetch(e.request))
    );
  });
  ```

  Keep the `streamingDomains` array — easy to add more domains later when we add non-SomaFM sources. Only include `somafm.com` for now since that's all we use.

  NOTE: The existing install and activate handlers remain unchanged (except the version bump triggers cache refresh).
  </action>
  <verify>
  - `sw.js` contains `CACHE_NAME = 'pomodoro-v34'`
  - `sw.js` fetch handler includes `somafm.com` check
  - `sw.js` still has cache-first for static assets
  - App still loads and works offline for its static assets (service worker doesn't break existing caching)
  </verify>
  <done>
  - Service worker cache version bumped to v34
  - Streaming audio domains excluded from cache (network-only)
  - Static asset caching still works (cache-first)
  </done>
</task>

</tasks>

<verification>
1. Page loads without console errors
2. `<audio id="bgAudio">` element exists in DOM
3. Service worker updates to v34 (check Application tab in DevTools)
4. Streaming domains are excluded from SW cache (Network tab shows no cache for somafm.com requests)
5. Audio state properties exist in localStorage settings
</verification>

<success_criteria>
- Audio engine is fully functional (all playback functions defined and callable)
- Station data covers 4 categories with SomaFM URLs
- Service worker excludes streaming URLs from cache
- Audio preferences persist to localStorage
- No regressions to existing app functionality
</success_criteria>

<output>
After completion, create `.planning/phases/01-streaming-audio-and-categories/01-01-SUMMARY.md`
</output>
